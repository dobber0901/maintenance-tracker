<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Planner - Helena Agri-Enterprises</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Roboto+Condensed:wght@400;700&display=swap');
    
    :root {
      --helena-green: #215530;
      --helena-green-light: #2d6e3f;
      --helena-green-dark: #1a4426;
      --accent-gold: #c5a562;
      --accent-light: #e8dcc4;
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border: #dee2e6;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --shadow: rgba(33, 85, 48, 0.1);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    
    /* Fullscreen optimization */
    body:-webkit-full-screen {
      width: 100%;
      height: 100%;
    }
    
    body:-moz-full-screen {
      width: 100%;
      height: 100%;
    }
    
    body:fullscreen {
      width: 100%;
      height: 100%;
    }
    
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 1rem 2rem;
    }
    
    header {
      background: linear-gradient(135deg, var(--helena-green), var(--helena-green-light));
      border-radius: 12px;
      padding: 1rem 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px var(--shadow);
      display: flex;
      align-items: center;
      gap: 2rem;
    }
    
    .logo {
      width: 140px;
      height: auto;
      filter: brightness(0) invert(1);
    }
    
    .header-text {
      flex: 1;
    }
    
    h1 {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: white;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.9);
      font-weight: 300;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      background: white;
      padding: 0.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .nav-tab {
      font-family: 'Roboto Condensed', sans-serif;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      padding: 0.75rem 1.5rem;
      font-size: 0.95rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 6px;
    }
    
    .nav-tab:hover {
      background: rgba(33, 85, 48, 0.05);
      color: var(--helena-green);
    }
    
    .nav-tab.active {
      background: var(--helena-green);
      color: white;
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .action-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      font-family: 'Roboto', sans-serif;
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--helena-green);
      background: white;
      color: var(--helena-green);
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 6px;
    }
    
    .btn:hover {
      background: var(--helena-green);
      color: white;
      box-shadow: 0 4px 12px var(--shadow);
    }
    
    .btn-primary {
      background: var(--helena-green);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--helena-green-dark);
      border-color: var(--helena-green-dark);
    }
    
    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    
    .equipment-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
    }
    
    .equipment-card:hover {
      box-shadow: 0 8px 24px var(--shadow);
      transform: translateY(-4px);
      border-color: var(--helena-green);
    }
    
    .equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--helena-green);
    }
    
    .equipment-id {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--helena-green);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.15rem;
    }
    
    .equipment-name {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.15rem;
    }
    
    .equipment-type {
      font-size: 0.85rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .status-badge {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .status-good {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
      border: 1px solid var(--success);
    }
    
    .status-warning {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
      border: 1px solid var(--warning);
    }
    
    .status-danger {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
      border: 1px solid var(--danger);
    }
    
    .equipment-stats {
      display: flex;
      gap: 0.75rem;
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: var(--bg-primary);
      border-radius: 6px;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.15rem;
    }
    
    .stat-value {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--helena-green);
    }
    
    .equipment-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .btn-small {
      flex: 1;
      padding: 0.6rem 1rem;
      font-size: 0.8rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 2rem;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--helena-green);
    }
    
    .modal-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--helena-green);
      text-transform: uppercase;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      color: var(--danger);
      transform: rotate(90deg);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--helena-green);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--helena-green);
      box-shadow: 0 0 0 3px rgba(33, 85, 48, 0.1);
    }
    
    select {
      cursor: pointer;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .maintenance-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .maintenance-item {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      transition: all 0.3s ease;
    }
    
    .maintenance-item:hover {
      border-color: var(--helena-green);
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .maintenance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .maintenance-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .maintenance-interval {
      font-size: 0.85rem;
      color: var(--helena-green);
      font-weight: 500;
    }
    
    .maintenance-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    .maintenance-status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .template-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid var(--border);
    }
    
    .template-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }
    
    .template-item:hover {
      border-color: var(--helena-green);
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .template-info {
      flex: 1;
    }
    
    .template-name {
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .template-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    
    /* Calendar Styles */
    .calendar-container {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .calendar-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--helena-green);
    }
    
    .calendar-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    
    .calendar-day-header {
      text-align: center;
      font-weight: 700;
      color: var(--helena-green);
      padding: 0.5rem;
      font-size: 0.85rem;
    }
    
    .calendar-day {
      aspect-ratio: 1;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      min-height: 80px;
      display: flex;
      flex-direction: column;
    }
    
    .calendar-day:hover {
      border-color: var(--helena-green);
      background: rgba(33, 85, 48, 0.05);
    }
    
    .calendar-day.other-month {
      opacity: 0.3;
    }
    
    .calendar-day.today {
      border: 2px solid var(--helena-green);
      background: rgba(33, 85, 48, 0.1);
    }
    
    .calendar-day.has-schedule {
      background: rgba(33, 85, 48, 0.05);
    }

    .calendar-day.windy-day {
      border-left: 3px solid #ff9800;
    }

    .calendar-day.windy-day.today {
      border: 2px solid var(--helena-green);
      border-left: 3px solid #ff9800;
    }

    /* Calendar View Toggle */
    .calendar-view-toggle {
      display: flex;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-right: 1rem;
    }

    .calendar-view-toggle button {
      padding: 0.4rem 0.75rem;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }

    .calendar-view-toggle button:hover {
      background: var(--bg-primary);
    }

    .calendar-view-toggle button.active {
      background: var(--helena-green);
      color: white;
    }

    /* Week View Styles */
    .calendar-grid.week-view {
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-grid.week-view .calendar-day {
      aspect-ratio: auto;
      min-height: 150px;
    }

    .calendar-grid.week-view .calendar-day-header {
      padding: 0.75rem;
    }

    .calendar-day-number {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    
    .calendar-events {
      font-size: 0.65rem;
      overflow: hidden;
    }
    
    .calendar-event {
      background: var(--helena-green);
      color: white;
      padding: 0.15rem 0.25rem;
      border-radius: 2px;
      margin-bottom: 0.15rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Issues Styles */
    .issues-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .issue-card {
      background: white;
      border: 1px solid var(--border);
      border-left: 4px solid var(--warning);
      border-radius: 6px;
      padding: 1.5rem;
      transition: all 0.3s ease;
    }
    
    .issue-card.critical {
      border-left-color: var(--danger);
    }
    
    .issue-card.completed {
      border-left-color: var(--success);
      opacity: 0.7;
    }
    
    .issue-card:hover {
      box-shadow: 0 4px 12px var(--shadow);
    }
    
    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .issue-equipment {
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      color: var(--helena-green);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }
    
    .issue-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .issue-notes {
      color: var(--text-secondary);
      margin: 1rem 0;
      line-height: 1.6;
    }
    
    .issue-meta {
      display: flex;
      gap: 2rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }
    
    .issue-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .severity-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      margin-left: 0.5rem;
    }
    
    .severity-critical {
      background: var(--danger);
      color: white;
    }
    
    .severity-minor {
      background: var(--warning);
      color: white;
    }
    
    .equipment-card.has-issues {
      border-left: 4px solid var(--warning);
    }
    
    .repair-badge {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--warning);
      color: white;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    /* Dashboard Styles */
    .stat-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      box-shadow: 0 8px 24px var(--shadow);
      transform: translateY(-4px);
    }
    
    .stat-card-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }
    
    .stat-card-value {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--helena-green);
      margin-bottom: 0.25rem;
    }
    
    .stat-card-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .dashboard-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .dashboard-section-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--helena-green);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--helena-green);
    }
    
    .dashboard-issue-item {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-left: 4px solid var(--danger);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: grid;
      grid-template-columns: 120px 120px 1fr 1fr 100px;
      gap: 1rem;
      align-items: start;
    }
    
    .dashboard-issue-item.minor {
      border-left-color: var(--warning);
    }
    
    .dashboard-issue-field {
      display: flex;
      flex-direction: column;
    }
    
    .dashboard-issue-field-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }
    
    .dashboard-issue-field-value {
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .days-down {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--danger);
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 1.75rem; }
      header { flex-direction: column; text-align: center; }
      .logo { width: 100px; }
      .equipment-grid { grid-template-columns: 1fr; }
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .loading-overlay.active {
      display: flex;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top: 4px solid var(--helena-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 1rem;
      font-family: 'Roboto Condensed', sans-serif;
      color: var(--helena-green);
      font-size: 1rem;
      font-weight: 500;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 4000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      background: white;
      border-radius: 6px;
      padding: 1rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      min-width: 280px;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warning);
    }

    .toast-icon {
      font-size: 1.25rem;
    }

    .toast-message {
      flex: 1;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    /* Search Box */
    .search-box {
      flex: 1;
      max-width: 300px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 2.5rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .search-box input:focus {
      border-color: var(--helena-green);
      outline: none;
    }

    .search-box::before {
      content: 'üîç';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1rem;
      opacity: 0.5;
    }

    /* SN/VIN Display */
    .equipment-snvin {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 0.15rem;
    }

    /* Alerts Banner */
    .alerts-banner {
      background: linear-gradient(135deg, #fff3cd, #ffeeba);
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      display: none;
    }

    .alerts-banner.show {
      display: block;
    }

    .alerts-banner.has-critical {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      border-color: #dc3545;
    }

    .alerts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .alerts-title {
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--text-primary);
    }

    .alerts-dismiss {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .alerts-dismiss:hover {
      opacity: 1;
    }

    .alerts-content {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }

    .alert-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .alert-item:hover {
      background: rgba(0,0,0,0.1);
    }

    .alert-count {
      font-family: 'Roboto Condensed', sans-serif;
      font-weight: 700;
      font-size: 1.25rem;
    }

    .alert-count.critical {
      color: var(--danger);
    }

    .alert-count.warning {
      color: #d39e00;
    }

    .alert-count.info {
      color: #0056b3;
    }

    /* Hour Meter Styles */
    .hour-meter-display {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .hour-meter-display strong {
      color: var(--helena-green);
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--border);
    }

    .quick-action-btn {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: var(--bg-primary);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .quick-action-btn:hover {
      border-color: var(--helena-green);
      color: var(--helena-green);
      background: white;
    }

    .next-due-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .next-due-badge.overdue {
      background: rgba(220, 53, 69, 0.1);
      color: var(--danger);
    }

    .next-due-badge.soon {
      background: rgba(255, 193, 7, 0.1);
      color: #d39e00;
    }

    .next-due-badge.ok {
      background: rgba(40, 167, 69, 0.1);
      color: var(--success);
    }

    /* Timeline Styles */
    .timeline {
      position: relative;
      padding-left: 2rem;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 1.5rem;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -1.65rem;
      top: 0.25rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--helena-green);
      border: 2px solid white;
      box-shadow: 0 0 0 2px var(--helena-green);
    }

    .timeline-item.issue::before {
      background: var(--warning);
      box-shadow: 0 0 0 2px var(--warning);
    }

    .timeline-item.critical::before {
      background: var(--danger);
      box-shadow: 0 0 0 2px var(--danger);
    }

    .timeline-item.checkout::before {
      background: #2196F3;
      box-shadow: 0 0 0 2px #2196F3;
    }

    .timeline-date {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .timeline-content {
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 1rem;
    }

    .timeline-title {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .timeline-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .timeline-photo {
      margin-top: 0.5rem;
    }

    .timeline-photo img {
      transition: transform 0.2s;
    }

    .timeline-photo img:hover {
      transform: scale(1.02);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Photo Attachment Styles */
    .photo-upload-area {
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .photo-upload-area:hover {
      border-color: var(--helena-green);
      background: rgba(33, 85, 48, 0.05);
    }

    .photo-upload-area.has-photo {
      border-style: solid;
      border-color: var(--success);
    }

    .photo-preview {
      max-width: 100%;
      max-height: 200px;
      border-radius: 4px;
      margin-top: 0.5rem;
    }

    .issue-photo {
      max-width: 100%;
      max-height: 300px;
      border-radius: 6px;
      margin-top: 0.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .issue-photo:hover {
      transform: scale(1.02);
    }

    /* Multiple Photo Preview Styles */
    .photo-previews-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .photo-preview-item {
      position: relative;
      display: inline-block;
    }

    .photo-preview-item img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    .photo-preview-item img:hover {
      border-color: var(--helena-green);
    }

    .photo-preview-item .remove-photo {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-preview-item .remove-photo:hover {
      background: #c0392b;
    }

    .issue-photos-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .issue-photos-gallery img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
      border: 1px solid var(--border);
    }

    .issue-photos-gallery img:hover {
      transform: scale(1.05);
      border-color: var(--helena-green);
    }

    /* Products Grid Styles */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .product-card {
      background: white;
      border-radius: 8px;
      padding: 1.25rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .product-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .product-part-number {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--helena-green);
      margin-bottom: 0.5rem;
    }

    .product-description {
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .product-type {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .product-type.liquid {
      background: #e3f2fd;
      color: #1976d2;
    }

    .product-type.dry {
      background: #fff3e0;
      color: #f57c00;
    }

    .product-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    /* Load Tracking Styles */
    .load-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }

    .load-card.complete {
      border-left: 4px solid var(--success);
      opacity: 0.8;
    }

    .load-card.partial {
      border-left: 4px solid var(--warning);
    }

    .load-card.open {
      border-left: 4px solid var(--helena-green);
    }

    .load-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .load-product-info {
      flex: 1;
    }

    .load-part-number {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--helena-green);
    }

    .load-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .load-progress {
      text-align: right;
    }

    .load-progress-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .load-progress-bar {
      width: 120px;
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.25rem;
    }

    .load-progress-fill {
      height: 100%;
      background: var(--helena-green);
      transition: width 0.3s;
    }

    .load-lines {
      display: grid;
      gap: 0.5rem;
    }

    .load-line {
      display: grid;
      grid-template-columns: 50px 1fr 130px 90px 90px 90px;
      gap: 0.75rem;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg-primary);
      border-radius: 6px;
    }

    .load-line-number {
      font-weight: 700;
      color: var(--helena-green);
    }

    .load-line-release {
      font-family: monospace;
      font-size: 0.95rem;
    }

    .load-line-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .load-line-status input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .load-line-status.assigned {
      color: #1976d2;
    }

    .load-line-status.delivered {
      color: var(--success);
    }

    .load-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    /* Collapsible Load Cards */
    .load-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      cursor: pointer;
      padding: 0.5rem;
      margin: -0.5rem -0.5rem 0 -0.5rem;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .load-card-header:hover {
      background: var(--bg-primary);
    }

    .load-collapse-btn {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.25rem;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }

    .load-card.collapsed .load-collapse-btn {
      transform: rotate(-90deg);
    }

    .load-card.collapsed .load-lines,
    .load-card.collapsed .load-actions {
      display: none;
    }

    .load-line-status select {
      padding: 0.35rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.8rem;
      max-width: 120px;
    }

    .assigned-option-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
    }

    .assigned-option-item button {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      font-size: 0.8rem;
    }

    .release-field-group {
      background: var(--bg-primary);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }

    .release-field-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--helena-green);
    }

    .release-field-group input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .edit-load-line {
      display: grid;
      grid-template-columns: 60px 1fr 80px 80px 40px;
      gap: 0.75rem;
      align-items: center;
      padding: 0.75rem;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-bottom: 0.5rem;
    }

    .edit-load-line input[type="text"] {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .edit-load-line .remove-line-btn {
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 1.1rem;
    }

    .edit-load-line .remove-line-btn:hover {
      background: #c0392b;
    }

    @media (max-width: 768px) {
      .load-line {
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
      }

      .load-line-number {
        grid-column: 1;
      }

      .load-line-release {
        grid-column: 2;
      }

      .load-line-status {
        grid-column: span 1;
        justify-content: flex-start;
      }

      .edit-load-line {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }
    }

    /* Tasks Table Styles */
    .tasks-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow-x: auto;
    }

    .tasks-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    .tasks-table thead {
      background: var(--helena-green);
      color: white;
    }

    .tasks-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-family: 'Roboto Condensed', sans-serif;
      white-space: nowrap;
    }

    .tasks-table td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .tasks-table tbody tr:hover {
      background: var(--bg-primary);
    }

    .tasks-table tbody tr.task-overdue {
      background: #ffebee;
    }

    .tasks-table tbody tr.task-overdue td {
      color: var(--danger);
      font-weight: 500;
    }

    .tasks-table tbody tr.task-due-soon {
      background: #fff8e1;
    }

    .tasks-table tbody tr.task-due-soon td {
      color: #f57c00;
    }

    .tasks-table tbody tr.task-completed {
      background: #e8f5e9;
      opacity: 0.7;
    }

    .task-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .task-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .task-type-badge.recurring {
      background: #e3f2fd;
      color: #1976d2;
    }

    .task-type-badge.single {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .task-status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .task-status-badge.overdue {
      background: var(--danger);
      color: white;
    }

    .task-status-badge.due-soon {
      background: var(--warning);
      color: white;
    }

    .task-status-badge.on-track {
      background: var(--success);
      color: white;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .print-buttons {
      margin-left: auto;
    }

    @media (max-width: 768px) {
      .tasks-table th,
      .tasks-table td {
        padding: 0.5rem;
        font-size: 0.85rem;
      }

      .task-actions {
        flex-direction: column;
      }

      .print-buttons {
        margin-left: 0;
        width: 100%;
      }
    }

    /* Orders Table Styles */
    .orders-table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow-x: auto;
    }

    .orders-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }

    .orders-table thead {
      background: var(--helena-green);
      color: white;
    }

    .orders-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-family: 'Roboto Condensed', sans-serif;
      white-space: nowrap;
    }

    .orders-table td {
      padding: 0.875rem 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }

    .orders-table tbody tr:hover {
      background: var(--bg-primary);
    }

    .orders-table tbody tr.order-overdue {
      background: #ffebee;
    }

    .orders-table tbody tr.order-overdue td {
      color: var(--danger);
    }

    .orders-table tbody tr.order-complete {
      background: #e8f5e9;
      opacity: 0.8;
    }

    .order-type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .order-type-badge.product {
      background: #e3f2fd;
      color: #1976d2;
    }

    .order-type-badge.service {
      background: #fff3e0;
      color: #e65100;
    }

    .order-status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .order-status-badge.pending {
      background: #fff8e1;
      color: #f57c00;
    }

    .order-status-badge.in_progress {
      background: #e3f2fd;
      color: #1976d2;
    }

    .order-status-badge.complete {
      background: var(--success);
      color: white;
    }

    .order-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .order-checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .order-item-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      background: var(--bg-primary);
      border-radius: 4px;
    }

    .order-item-row input,
    .order-item-row select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .order-item-header {
      display: flex;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    #orderItemsContainer,
    #editOrderItemsContainer {
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.5rem;
      background: white;
    }

    /* Email Digest Styles */
    .email-config {
      background: var(--bg-primary);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .email-preview {
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Mobile Optimization */
    @media (max-width: 768px) {
      h1 { font-size: 1.5rem; }
      .subtitle { font-size: 0.85rem; }
      header {
        flex-direction: column;
        text-align: center;
        padding: 1rem;
        gap: 1rem;
      }
      .logo { width: 100px; }
      .equipment-grid { grid-template-columns: 1fr; }
      .container { padding: 0.5rem; }

      .nav-tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
        padding: 0.5rem;
        gap: 0.25rem;
      }

      .nav-tab {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .action-bar {
        flex-direction: column;
        gap: 0.5rem;
      }

      .action-bar .btn {
        width: 100%;
      }

      .search-box {
        max-width: 100%;
      }

      .modal-content {
        padding: 1rem;
        margin: 0.5rem;
        max-height: 95vh;
      }

      .btn {
        padding: 0.9rem 1.25rem;
        font-size: 0.85rem;
      }

      .btn-small {
        padding: 0.7rem 0.9rem;
        font-size: 0.8rem;
      }

      .equipment-card {
        padding: 0.75rem;
      }

      .quick-actions {
        flex-wrap: wrap;
      }

      .quick-action-btn {
        min-width: calc(50% - 0.25rem);
      }

      .stat-card {
        padding: 1rem;
      }

      .stat-card-value {
        font-size: 2rem;
      }

      .calendar-day {
        min-height: 60px;
        font-size: 0.8rem;
      }

      .alerts-content {
        flex-direction: column;
        gap: 0.5rem;
      }

      #headerDateTime {
        display: none;
      }

      .dashboard-issue-item {
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
      }

      .issue-meta {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    @media (max-width: 480px) {
      h1 { font-size: 1.25rem; }
      .equipment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .status-badge {
        align-self: flex-start;
      }

      .equipment-stats {
        flex-direction: column;
        gap: 0.5rem;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Loading...</div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <div class="container">
    <header>
      <svg class="logo" viewBox="0 0 157 90" xmlns="http://www.w3.org/2000/svg">
        <g fill="currentColor">
          <path d="M78.487013,73.5487013 C57.974026,73.5487013 38.6298701,69.9837662 24.0194805,63.4967532 C8.53246753,56.6006494 0,47.1331169 0,36.788961 C0,26.4155844 8.53246753,16.9480519 24.0194805,10.0519481 C38.6298701,3.56493506 57.974026,0 78.487013,0 C99,0 118.344156,3.56493506 132.954545,10.0519481 C148.441558,16.9480519 156.974026,26.4155844 156.974026,36.7597403 C156.974026,47.1038961 148.441558,56.6006494 132.954545,63.4675325 C118.373377,69.9837662 99.0292208,73.5487013 78.487013,73.5487013 Z M78.487013,6.8961039 C58.9090909,6.8961039 40.5584416,10.2564935 26.7954545,16.3636364 C14.1136364,22.0032468 6.86688312,29.4253247 6.86688312,36.788961 C6.86688312,44.1525974 14.1428571,51.5746753 26.7954545,57.2142857 C40.5292208,63.3214286 58.9090909,66.6818182 78.487013,66.6818182 C98.0649351,66.6818182 116.415584,63.3214286 130.178571,57.2142857 C142.86039,51.5746753 150.107143,44.1525974 150.107143,36.788961 C150.107143,29.4253247 142.831169,22.0032468 130.178571,16.3636364 C116.444805,10.2564935 98.0649351,6.8961039 78.487013,6.8961039 Z"/>
          <polygon points="25.5681818 49.1785714 25.5681818 39.5357143 32.5227273 39.5357143 32.5227273 49.1785714 39.9155844 49.1785714 39.9155844 24.3116883 32.5227273 24.3116883 32.5227273 32.6980519 25.5681818 32.6980519 25.5681818 24.3116883 18.1753247 24.3116883 18.1753247 49.1785714"/>
          <polygon points="58.8506494 49.1785714 58.8506494 43.3928571 48.7402597 43.3928571 48.7402597 39.4772727 58.0324675 39.4772727 58.0324675 33.6623377 48.7402597 33.6623377 48.7402597 30.0974026 58.4123377 30.0974026 58.4123377 24.3116883 41.3474026 24.3116883 41.3474026 49.1785714"/>
          <polygon points="75.4188312 49.1785714 75.4188312 42.9545455 67.8798701 42.9545455 67.8798701 24.3116883 60.487013 24.3116883 60.487013 49.1785714"/>
          <polygon points="94.1201299 49.1785714 94.1201299 43.3928571 84.0097403 43.3928571 84.0097403 39.4772727 93.3019481 39.4772727 93.3019481 33.6623377 84.0097403 33.6623377 84.0097403 30.0974026 93.6818182 30.0974026 93.6818182 24.3116883 76.6168831 24.3116883 76.6168831 49.1785714"/>
          <polygon points="104.172078 24.3116883 95.5519481 24.3116883 95.5519481 49.1785714 102.623377 49.1785714 102.623377 41.3181818 102.331169 35.6493506 108.642857 49.1785714 117.262987 49.1785714 117.262987 24.3116883 110.220779 24.3116883 110.220779 32.2305195 110.483766 37.8993506"/>
          <polygon points="121.87987 37.8409091 132.691558 37.8409091 132.691558 43.9188312 121.87987 43.9188312"/>
          <polygon points="122.931818 24.5746753 132.662338 24.5746753 139.587662 49.1785714 133.042208 49.1785714 127.811688 30.1558442 122.727273 49.1785714 115.275974 49.1785714"/>
        </g>
      </svg>
      <div class="header-text">
        <h1>üìã Operations Planner</h1>
        <p class="subtitle">Helena Agri-Enterprises</p>
      </div>
      <div id="headerDateTime" style="text-align: right; color: white; min-width: 200px;">
        <div id="currentDate" style="font-size: 0.9rem; font-weight: 500;"></div>
        <div id="currentTime" style="font-size: 1.2rem; font-weight: 700; margin: 0.25rem 0;"></div>
        <div id="currentWeather" style="font-size: 0.85rem; opacity: 0.9;"></div>
        <div id="currentWind" style="font-size: 0.8rem; opacity: 0.85;"></div>
      </div>
    </header>

    <!-- Alerts Banner -->
    <div id="alertsBanner" class="alerts-banner">
      <div class="alerts-header">
        <span class="alerts-title">‚ö†Ô∏è Items Needing Attention</span>
        <button class="alerts-dismiss" onclick="dismissAlerts()">&times;</button>
      </div>
      <div class="alerts-content" id="alertsContent"></div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="equipment">Equipment Fleet</button>
      <button class="nav-tab" data-tab="dashboard">Dashboard</button>
      <button class="nav-tab" data-tab="templates">Maintenance Templates</button>
      <button class="nav-tab" data-tab="schedule">Schedule</button>
      <button class="nav-tab" data-tab="issues">Equipment Issues</button>
      <button class="nav-tab" data-tab="location">Item Location</button>
      <button class="nav-tab" data-tab="costrepair">Cost Repair</button>
      <button class="nav-tab" data-tab="products">Products</button>
      <button class="nav-tab" data-tab="loads">Load Tracking</button>
      <button class="nav-tab" data-tab="tasks">Tasks</button>
      <button class="nav-tab" data-tab="orders">Orders</button>
    </div>
    
    <div id="equipment-tab" class="tab-content active">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddEquipmentModal()">+ Add Equipment</button>
        <div class="search-box">
          <input type="text" id="equipmentSearch" placeholder="Search equipment..." oninput="window.filterEquipment()">
        </div>
      </div>
      <div class="equipment-grid" id="equipmentGrid"></div>
    </div>
    
    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn" onclick="window.openEmailDigestModal()">üìß Email Digest</button>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('equipment')">
          <div class="stat-card-icon" style="color: var(--danger);">‚ö†Ô∏è</div>
          <div class="stat-card-value" id="dashOverdueCount">0</div>
          <div class="stat-card-label">Past Due Maintenance</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('equipment')">
          <div class="stat-card-icon" style="color: var(--success);">‚úì</div>
          <div class="stat-card-value" id="dashUpToDateCount">0</div>
          <div class="stat-card-label">Up to Date</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('issues')">
          <div class="stat-card-icon" style="color: var(--danger);">üõë</div>
          <div class="stat-card-value" id="dashOutOfServiceCount">0</div>
          <div class="stat-card-label">Out of Service</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('issues')">
          <div class="stat-card-icon" style="color: var(--warning);">üîß</div>
          <div class="stat-card-value" id="dashMinorIssuesCount">0</div>
          <div class="stat-card-label">Minor Issues</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('location')">
          <div class="stat-card-icon" style="color: #2196F3;">üìç</div>
          <div class="stat-card-value" id="dashCheckedOutCount">0</div>
          <div class="stat-card-label">Checked Out</div>
        </div>
        <div class="stat-card" style="cursor: pointer;" onclick="switchToTab('schedule')">
          <div class="stat-card-icon" style="color: var(--helena-green);">üìÖ</div>
          <div class="stat-card-value" id="dashDueThisWeekCount">0</div>
          <div class="stat-card-label">Due This Week</div>
        </div>
      </div>

      <!-- Needs Attention This Week Section -->
      <div id="dashboardNeedsAttention"></div>
      
      <div id="dashboardCheckedOut"></div>
      <div id="dashboardCriticalIssues"></div>
      <div id="dashboardMinorIssues"></div>
    </div>
    
    <div id="templates-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddTemplateModal()">+ Create Template</button>
      </div>
      <div id="templatesList"></div>
    </div>
    
    <div id="schedule-tab" class="tab-content">
      <div class="action-bar">
        <select id="scheduleEquipmentFilter" onchange="renderScheduleCalendar()">
          <option value="">All Equipment</option>
        </select>
      </div>
      <div class="calendar-container">
        <div class="calendar-header">
          <h3 class="calendar-title" id="calendarMonth"></h3>
          <div style="display: flex; align-items: center;">
            <div class="calendar-view-toggle">
              <button id="weekViewBtn" onclick="setCalendarView('week')">Week</button>
              <button id="monthViewBtn" class="active" onclick="setCalendarView('month')">Month</button>
            </div>
            <div class="calendar-nav">
              <button class="btn btn-small" onclick="previousPeriod()">¬´ Prev</button>
              <button class="btn btn-small" onclick="goToToday()">Today</button>
              <button class="btn btn-small" onclick="nextPeriod()">Next ¬ª</button>
            </div>
          </div>
        </div>
        <div class="calendar-grid" id="calendar"></div>
      </div>
      <div id="scheduleView"></div>
    </div>
    
    <!-- Issues Tab -->
    <div id="issues-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddIssueModal()">+ Log New Issue</button>
        <select id="issuesEquipmentFilter" onchange="renderIssues()">
          <option value="">All Equipment</option>
        </select>
        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
          <input type="checkbox" id="showCompletedIssues" onchange="renderIssues()" style="width: auto; cursor: pointer;">
          <span style="font-weight: normal; text-transform: none; letter-spacing: normal;">Show Completed</span>
        </label>
      </div>
      <div id="issuesList"></div>
    </div>
    
    <!-- Item Location Tab -->
    <div id="location-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="window.openCheckOutModal()">+ Check Out Equipment</button>
        <select id="locationEquipmentFilter" onchange="renderLocations()">
          <option value="">All Equipment</option>
        </select>
        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
          <input type="checkbox" id="showReturnedItems" onchange="renderLocations()" style="width: auto; cursor: pointer;">
          <span style="font-weight: normal; text-transform: none; letter-spacing: normal;">Show Returned</span>
        </label>
      </div>
      <div id="locationsList"></div>
    </div>
    
    <!-- Cost Repair Tab -->
    <div id="costrepair-tab" class="tab-content">
      <div class="action-bar">
        <select id="costRepairEquipmentFilter" onchange="renderCostRepair()">
          <option value="">Select Equipment</option>
        </select>
        <button class="btn btn-primary" onclick="printCostRepairReport()" id="printCostRepairBtn" style="display: none;">üìÑ Print Cost Analysis Report</button>
      </div>
      
      <div id="costRepairChart" style="display: none; background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
        <h3 style="font-family: 'Roboto Condensed', sans-serif; color: var(--helena-green); margin-bottom: 1rem;">Repair Costs by Year</h3>
        <canvas id="costChartCanvas" style="max-height: 300px;"></canvas>
      </div>
      
      <div id="costRepairList"></div>
    </div>

    <!-- Products Tab -->
    <div id="products-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
        <div class="search-box">
          <input type="text" id="productSearch" placeholder="Search products..." oninput="window.filterProducts()">
        </div>
      </div>
      <div id="productsList" class="products-grid"></div>
    </div>

    <!-- Load Tracking Tab -->
    <div id="loads-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddLoadModal()">+ New Load Request</button>
        <select id="loadStatusFilter" onchange="renderLoads()">
          <option value="active" selected>Active (Open/Partial)</option>
          <option value="">All Loads</option>
          <option value="open">Open Only</option>
          <option value="partial">Partially Delivered</option>
          <option value="complete">Complete Only</option>
        </select>
        <select id="loadProductFilter" onchange="renderLoads()">
          <option value="">All Products</option>
        </select>
        <button class="btn btn-small" onclick="openAssignedOptionsModal()">‚öôÔ∏è Manage Assigned Options</button>
        <button class="btn btn-small" onclick="toggleAllLoads()" id="collapseAllBtn">Collapse All</button>
      </div>
      <div id="loadsList"></div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasks-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddTaskModal()">+ Add Task</button>
        <select id="taskOwnerFilter" onchange="renderTasks()">
          <option value="">All Owners</option>
        </select>
        <select id="taskTypeFilter" onchange="renderTasks()">
          <option value="">All Types</option>
          <option value="recurring">Recurring</option>
          <option value="single">Single Time</option>
        </select>
        <select id="taskSortBy" onchange="renderTasks()">
          <option value="dueDate">Sort by Due Date</option>
          <option value="owner">Sort by Owner</option>
          <option value="task">Sort by Task Name</option>
        </select>
        <div class="print-buttons" style="display: flex; gap: 0.5rem;">
          <button class="btn btn-small" onclick="printTaskReport('urgent')">üìÑ Print Urgent</button>
          <button class="btn btn-small" onclick="printTaskReport('all')">üìÑ Print All</button>
        </div>
      </div>
      <div class="tasks-table-container">
        <table class="tasks-table" id="tasksTable">
          <thead>
            <tr>
              <th>Task</th>
              <th>Type</th>
              <th>Owner</th>
              <th>Due Date</th>
              <th>Last Completed</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddOrderModal()">+ New Order</button>
        <select id="orderAssignedFilter" onchange="renderOrders()">
          <option value="">All Assigned</option>
        </select>
        <select id="orderTypeFilter" onchange="renderOrders()">
          <option value="">All Types</option>
          <option value="product">Product</option>
          <option value="service">Service</option>
        </select>
        <select id="orderStatusFilter" onchange="renderOrders()">
          <option value="active" selected>Active Orders</option>
          <option value="">All Orders</option>
          <option value="complete">Completed</option>
        </select>
        <button class="btn btn-small" onclick="printSelectedOrders()">üìÑ Print Selected</button>
        <button class="btn btn-small" onclick="openUomModal()">‚öôÔ∏è Unit of Measure</button>
        <label style="display: flex; align-items: center; gap: 0.25rem; margin-left: auto;">
          <input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders()"> Select All
        </label>
      </div>
      <div class="orders-table-container">
        <table class="orders-table" id="ordersTable">
          <thead>
            <tr>
              <th style="width: 40px;"></th>
              <th>Customer</th>
              <th>Type</th>
              <th>Product/Service</th>
              <th>Qty</th>
              <th>Due Date</th>
              <th>Assigned</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Task Modal -->
  <div id="addTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Task</h2>
        <button class="close-btn" onclick="closeModal('addTaskModal')">&times;</button>
      </div>
      <form id="addTaskForm" onsubmit="addTask(event)">
        <div class="form-group">
          <label for="taskName">Task Name *</label>
          <input type="text" id="taskName" required placeholder="e.g., Monthly Safety Inspection">
        </div>
        <div class="form-group">
          <label for="taskType">Task Type *</label>
          <select id="taskType" required onchange="toggleRecurringFields()">
            <option value="">Select Type</option>
            <option value="recurring">Recurring</option>
            <option value="single">Single Time</option>
          </select>
        </div>
        <div class="form-group" id="recurringIntervalGroup" style="display: none;">
          <label for="taskFrequency">Frequency *</label>
          <select id="taskFrequency">
            <option value="1">Daily</option>
            <option value="7">Weekly</option>
            <option value="14">Bi-Weekly</option>
            <option value="30" selected>Monthly</option>
          </select>
        </div>
        <div class="form-group">
          <label for="taskOwner">Owner *</label>
          <input type="text" id="taskOwner" required placeholder="e.g., John Smith">
        </div>
        <div class="form-group">
          <label for="taskDueDate">Due Date *</label>
          <input type="date" id="taskDueDate" required>
        </div>
        <div class="form-group">
          <label for="taskNotes">Notes</label>
          <textarea id="taskNotes" placeholder="Additional details..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Task</button>
      </form>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="editTaskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Task</h2>
        <button class="close-btn" onclick="closeModal('editTaskModal')">&times;</button>
      </div>
      <form id="editTaskForm" onsubmit="updateTask(event)">
        <input type="hidden" id="editTaskId">
        <div class="form-group">
          <label for="editTaskName">Task Name *</label>
          <input type="text" id="editTaskName" required>
        </div>
        <div class="form-group">
          <label for="editTaskType">Task Type *</label>
          <select id="editTaskType" required onchange="toggleEditRecurringFields()">
            <option value="recurring">Recurring</option>
            <option value="single">Single Time</option>
          </select>
        </div>
        <div class="form-group" id="editRecurringIntervalGroup" style="display: none;">
          <label for="editTaskFrequency">Frequency *</label>
          <select id="editTaskFrequency">
            <option value="1">Daily</option>
            <option value="7">Weekly</option>
            <option value="14">Bi-Weekly</option>
            <option value="30">Monthly</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editTaskOwner">Owner *</label>
          <input type="text" id="editTaskOwner" required>
        </div>
        <div class="form-group">
          <label for="editTaskDueDate">Due Date *</label>
          <input type="date" id="editTaskDueDate" required>
        </div>
        <div class="form-group" id="editLastCompletedGroup">
          <label for="editTaskLastCompleted">Last Completed</label>
          <input type="date" id="editTaskLastCompleted">
        </div>
        <div class="form-group">
          <label for="editTaskNotes">Notes</label>
          <textarea id="editTaskNotes"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Task</button>
      </form>
    </div>
  </div>

  <!-- Add Order Modal -->
  <div id="addOrderModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">New Order</h2>
        <button class="close-btn" onclick="closeModal('addOrderModal')">&times;</button>
      </div>
      <form id="addOrderForm" onsubmit="addOrder(event)">
        <div class="form-group">
          <label for="orderCustomer">Customer *</label>
          <input type="text" id="orderCustomer" required placeholder="Customer name">
        </div>
        <div class="form-group">
          <label for="orderType">Order Type *</label>
          <select id="orderType" required onchange="toggleOrderServiceFields()">
            <option value="">Select Type</option>
            <option value="product">Product</option>
            <option value="service">Service</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orderDueDate">Due Date *</label>
          <input type="date" id="orderDueDate" required>
        </div>
        <div id="orderServiceDatesGroup" style="display: none;">
          <div class="form-group">
            <label for="orderStartDate">Start Date</label>
            <input type="date" id="orderStartDate">
          </div>
          <div class="form-group">
            <label for="orderFinishDate">Finish Date</label>
            <input type="date" id="orderFinishDate">
          </div>
        </div>
        <div class="form-group">
          <label for="orderAssigned">Assigned To *</label>
          <input type="text" id="orderAssigned" required placeholder="Who will deliver/complete this order">
        </div>

        <div class="form-group">
          <label style="display: flex; justify-content: space-between; align-items: center;">
            <span>Order Items *</span>
            <button type="button" class="btn btn-small" onclick="addOrderItemRow()">+ Add Item</button>
          </label>
          <div id="orderItemsContainer">
            <div class="order-item-row" data-item="1">
              <input type="text" placeholder="Product/Service" class="item-description" required style="flex: 2;">
              <input type="number" placeholder="Qty" class="item-qty" min="0.01" step="0.01" value="1" required style="width: 80px;">
              <select class="item-uom" style="width: 100px;"></select>
              <button type="button" class="btn btn-small" onclick="removeOrderItemRow(this)" style="background: #dc3545; color: white;">√ó</button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="orderNotes">Special Notes</label>
          <textarea id="orderNotes" placeholder="Any special instructions..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Create Order</button>
      </form>
    </div>
  </div>

  <!-- Edit Order Modal -->
  <div id="editOrderModal" class="modal">
    <div class="modal-content" style="max-width: 750px;">
      <div class="modal-header">
        <h2 class="modal-title">Edit Order</h2>
        <button class="close-btn" onclick="closeModal('editOrderModal')">&times;</button>
      </div>
      <form id="editOrderForm" onsubmit="updateOrder(event)">
        <input type="hidden" id="editOrderId">
        <div class="form-group">
          <label for="editOrderCustomer">Customer *</label>
          <input type="text" id="editOrderCustomer" required>
        </div>
        <div class="form-group">
          <label for="editOrderType">Order Type *</label>
          <select id="editOrderType" required onchange="toggleEditOrderServiceFields()">
            <option value="product">Product</option>
            <option value="service">Service</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editOrderDueDate">Due Date *</label>
          <input type="date" id="editOrderDueDate" required>
        </div>
        <div id="editOrderServiceDatesGroup" style="display: none;">
          <div class="form-group">
            <label for="editOrderStartDate">Start Date</label>
            <input type="date" id="editOrderStartDate">
          </div>
          <div class="form-group">
            <label for="editOrderFinishDate">Finish Date</label>
            <input type="date" id="editOrderFinishDate">
          </div>
        </div>
        <div class="form-group">
          <label for="editOrderAssigned">Assigned To *</label>
          <input type="text" id="editOrderAssigned" required>
        </div>

        <div class="form-group">
          <label style="display: flex; justify-content: space-between; align-items: center;">
            <span>Order Items</span>
            <button type="button" class="btn btn-small" onclick="addEditOrderItemRow()">+ Add Item</button>
          </label>
          <div id="editOrderItemsContainer"></div>
        </div>

        <div class="form-group">
          <label for="editOrderNotes">Special Notes</label>
          <textarea id="editOrderNotes"></textarea>
        </div>
        <div class="form-group">
          <label for="editOrderStatus">Status</label>
          <select id="editOrderStatus">
            <option value="pending">Pending</option>
            <option value="in_progress">In Progress</option>
            <option value="complete">Complete</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Order</button>
      </form>
    </div>
  </div>

  <!-- Unit of Measure Modal -->
  <div id="uomModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Manage Units of Measure</h2>
        <button class="close-btn" onclick="closeModal('uomModal')">&times;</button>
      </div>
      <div style="margin-bottom: 1rem;">
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Add or remove units of measure for order quantities.</p>
      </div>
      <div class="form-group">
        <label>Add New Unit</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="newUomOption" placeholder="e.g., Bushels" style="flex: 1;">
          <button class="btn btn-primary" onclick="addUomOption()">Add</button>
        </div>
      </div>
      <div class="form-group">
        <label>Current Units</label>
        <div id="uomOptionsList" style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; max-height: 250px; overflow-y: auto;">
          <p style="color: var(--text-secondary);">Loading...</p>
        </div>
      </div>
      <button class="btn" style="width: 100%;" onclick="closeModal('uomModal')">Done</button>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Product</h2>
        <button class="close-btn" onclick="closeModal('addProductModal')">&times;</button>
      </div>
      <form id="addProductForm" onsubmit="addProduct(event)">
        <div class="form-group">
          <label for="productPartNumber">Part Number *</label>
          <input type="text" id="productPartNumber" required placeholder="e.g., FERT-001">
        </div>
        <div class="form-group">
          <label for="productDescription">Item Description *</label>
          <input type="text" id="productDescription" required placeholder="e.g., 10-34-0 Liquid Starter">
        </div>
        <div class="form-group">
          <label for="productType">Product Type *</label>
          <select id="productType" required>
            <option value="">Select Type</option>
            <option value="Liquid">Liquid Fertilizer</option>
            <option value="Dry">Dry Fertilizer</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Product</button>
      </form>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Product</h2>
        <button class="close-btn" onclick="closeModal('editProductModal')">&times;</button>
      </div>
      <form id="editProductForm" onsubmit="updateProduct(event)">
        <input type="hidden" id="editProductId">
        <div class="form-group">
          <label for="editProductPartNumber">Part Number *</label>
          <input type="text" id="editProductPartNumber" required>
        </div>
        <div class="form-group">
          <label for="editProductDescription">Item Description *</label>
          <input type="text" id="editProductDescription" required>
        </div>
        <div class="form-group">
          <label for="editProductType">Product Type *</label>
          <select id="editProductType" required>
            <option value="Liquid">Liquid Fertilizer</option>
            <option value="Dry">Dry Fertilizer</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Product</button>
      </form>
    </div>
  </div>

  <!-- Add Load Modal -->
  <div id="addLoadModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">New Load Request</h2>
        <button class="close-btn" onclick="closeModal('addLoadModal')">&times;</button>
      </div>
      <form id="addLoadForm" onsubmit="addLoad(event)">
        <div class="form-group">
          <label for="loadProduct">Product *</label>
          <select id="loadProduct" required onchange="fillProductInfo()">
            <option value="">Select Product</option>
          </select>
        </div>
        <div id="loadProductInfo" style="display: none; background: var(--bg-primary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
          <div><strong>Description:</strong> <span id="loadProductDescription"></span></div>
          <div><strong>Type:</strong> <span id="loadProductType"></span></div>
        </div>
        <div class="form-group">
          <label for="loadQuantity">Number of Loads Requested *</label>
          <input type="number" id="loadQuantity" required min="1" max="20" value="1" onchange="generateReleaseFields()">
        </div>
        <div id="releaseFieldsContainer"></div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Create Load Request</button>
      </form>
    </div>
  </div>

  <!-- Edit Load Modal -->
  <div id="editLoadModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Edit Load Request</h2>
        <button class="close-btn" onclick="closeModal('editLoadModal')">&times;</button>
      </div>
      <form id="editLoadForm" onsubmit="updateLoad(event)">
        <input type="hidden" id="editLoadId">
        <div style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
          <div><strong>Part Number:</strong> <span id="editLoadPartNumber"></span></div>
          <div><strong>Description:</strong> <span id="editLoadDescription"></span></div>
          <div><strong>Type:</strong> <span id="editLoadType"></span></div>
        </div>
        <div id="editReleaseFieldsContainer"></div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Update Load</button>
          <button type="button" class="btn" onclick="addLoadLine()" style="flex: 0;">+ Add Load</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Manage Assigned Options Modal -->
  <div id="assignedOptionsModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Manage Assigned Options</h2>
        <button class="close-btn" onclick="closeModal('assignedOptionsModal')">&times;</button>
      </div>
      <div style="margin-bottom: 1rem;">
        <p style="color: var(--text-secondary); font-size: 0.9rem;">Add options that will appear in the "Assigned To" dropdown for load lines.</p>
      </div>
      <div class="form-group">
        <label>Add New Option</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="newAssignedOption" placeholder="e.g., Driver Name or Truck #" style="flex: 1;">
          <button class="btn btn-primary" onclick="addAssignedOption()">Add</button>
        </div>
      </div>
      <div class="form-group">
        <label>Current Options</label>
        <div id="assignedOptionsList" style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; max-height: 250px; overflow-y: auto;">
          <p style="color: var(--text-secondary);">No options added yet.</p>
        </div>
      </div>
      <button class="btn" style="width: 100%;" onclick="closeModal('assignedOptionsModal')">Done</button>
    </div>
  </div>

  <!-- Add Equipment Modal -->
  <div id="addEquipmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Equipment</h2>
        <button class="close-btn" onclick="closeModal('addEquipmentModal')">&times;</button>
      </div>
      <form id="addEquipmentForm" onsubmit="addEquipment(event)">
        <div class="form-group">
          <label for="equipmentId">Equipment ID *</label>
          <input type="text" id="equipmentId" required placeholder="e.g., FB-001">
        </div>
        <div class="form-group">
          <label for="equipmentName">Equipment Name *</label>
          <input type="text" id="equipmentName" required placeholder="e.g., John Deere Fertilizer Buggy">
        </div>
        <div class="form-group">
          <label for="equipmentSNVIN">SN/VIN</label>
          <input type="text" id="equipmentSNVIN" placeholder="Serial Number or VIN (optional)">
        </div>
        <div class="form-group">
          <label for="equipmentType">Equipment Type *</label>
          <select id="equipmentType" required onchange="loadMaintenanceTemplates()">
            <option value="">Select Type</option>
            <option value="Equipment">Equipment</option>
            <option value="Fertilizer Buggy">Fertilizer Buggy</option>
            <option value="Flatbed">Flatbed</option>
            <option value="Forklift">Forklift</option>
            <option value="Hopper Bottom">Hopper Bottom</option>
            <option value="Nurse Trailer">Nurse Trailer</option>
            <option value="Seed Trailer">Seed Trailer</option>
            <option value="Skid Steer">Skid Steer</option>
            <option value="Tank Trailer">Tank Trailer</option>
            <option value="Tender">Tender</option>
            <option value="Tractor">Tractor</option>
            <option value="Truck">Truck</option>
            
          </select>
        </div>
        <div class="form-group">
          <label for="equipmentLocation">Location</label>
          <input type="text" id="equipmentLocation" placeholder="e.g., Main Yard">
        </div>
        <div class="form-group">
          <label for="equipmentHourMeter">Current Hour Meter / Odometer</label>
          <input type="number" id="equipmentHourMeter" min="0" step="0.1" placeholder="e.g., 1250.5 hours or miles">
        </div>
        <div id="templateLoadSection" style="display: none;">
          <div class="form-group">
            <label>Auto-Load Maintenance Items</label>
            <div id="availableTemplates"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Equipment</button>
      </form>
    </div>
  </div>
  
  <!-- Edit Equipment Modal -->
  <div id="editEquipmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Equipment</h2>
        <button class="close-btn" onclick="closeModal('editEquipmentModal')">&times;</button>
      </div>
      <form id="editEquipmentForm" onsubmit="updateEquipment(event)">
        <input type="hidden" id="editEquipmentDbId">
        <div class="form-group">
          <label for="editEquipmentId">Equipment ID *</label>
          <input type="text" id="editEquipmentId" required placeholder="e.g., FB-001">
        </div>
        <div class="form-group">
          <label for="editEquipmentName">Equipment Name *</label>
          <input type="text" id="editEquipmentName" required placeholder="e.g., John Deere Fertilizer Buggy">
        </div>
        <div class="form-group">
          <label for="editEquipmentSNVIN">SN/VIN</label>
          <input type="text" id="editEquipmentSNVIN" placeholder="Serial Number or VIN (optional)">
        </div>
        <div class="form-group">
          <label for="editEquipmentLocation">Location</label>
          <input type="text" id="editEquipmentLocation" placeholder="e.g., Main Yard">
        </div>
        <div class="form-group">
          <label for="editEquipmentHourMeter">Current Hour Meter / Odometer</label>
          <input type="number" id="editEquipmentHourMeter" min="0" step="0.1" placeholder="e.g., 1250.5 hours or miles">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Equipment</button>
      </form>
    </div>
  </div>
  
  <!-- Add Template Modal -->
  <div id="addTemplateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Maintenance Template</h2>
        <button class="close-btn" onclick="closeModal('addTemplateModal')">&times;</button>
      </div>
      <form id="addTemplateForm" onsubmit="addTemplate(event)">
        <div class="form-group">
          <label for="templateEquipmentType">Equipment Type *</label>
          <select id="templateEquipmentType" required>
            <option value="">Select Type</option>
            <option value="Equipment">Equipment</option>
            <option value="Fertilizer Buggy">Fertilizer Buggy</option>
            <option value="Flatbed">Flatbed</option>
            <option value="Forklift">Forklift</option>
            <option value="Hopper Bottom">Hopper Bottom</option>
            <option value="Nurse Trailer">Nurse Trailer</option>
            <option value="Seed Trailer">Seed Trailer</option>
            <option value="Skid Steer">Skid Steer</option>
            <option value="Tank Trailer">Tank Trailer</option>
            <option value="Tender">Tender</option>
            <option value="Tractor">Tractor</option>
            <option value="Truck">Truck</option>
          </select>
        </div>
        <div class="form-group">
          <label for="templateName">Maintenance Item Name *</label>
          <input type="text" id="templateName" required placeholder="e.g., Oil Change">
        </div>
        <div class="form-group">
          <label for="templateInterval">Interval (days) *</label>
          <input type="number" id="templateInterval" required min="1" placeholder="e.g., 90">
        </div>
        <div class="form-group">
          <label for="templateDescription">Description/Instructions</label>
          <textarea id="templateDescription" placeholder="Detailed instructions for this maintenance item..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Create Template</button>
      </form>
    </div>
  </div>
  
  <!-- Equipment Details Modal -->
  <div id="equipmentDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="detailsEquipmentName"></h2>
        <button class="close-btn" onclick="closeModal('equipmentDetailsModal')">&times;</button>
      </div>
      <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
        <button class="btn btn-primary" onclick="openAddMaintenanceItemModal()">+ Add Maintenance Item</button>
        <button class="btn" onclick="printReport()">üìÑ Print Report</button>
      </div>
      <div id="equipmentDetailsContent"></div>
      <div class="action-bar" style="margin-top: 2rem;">
        <button class="btn" onclick="closeModal('equipmentDetailsModal')">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Complete Maintenance Modal -->
  <div id="completeMaintenanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Complete Maintenance</h2>
        <button class="close-btn" onclick="closeModal('completeMaintenanceModal')">&times;</button>
      </div>
      <form id="completeMaintenanceForm" onsubmit="completeMaintenance(event)">
        <input type="hidden" id="completeEquipmentId">
        <input type="hidden" id="completeMaintenanceId">
        <div class="form-group">
          <label>Maintenance Item</label>
          <p id="completeMaintenanceName" style="color: var(--text-primary); font-size: 1.1rem; font-weight: 600;"></p>
        </div>
        <div class="form-group">
          <label for="completionDate">Completion Date *</label>
          <input type="date" id="completionDate" required>
        </div>
        <div class="form-group">
          <label for="completionHours">Current Hour Meter / Odometer</label>
          <input type="number" id="completionHours" min="0" step="0.1" placeholder="Record current hours/miles at completion">
        </div>
        <div class="form-group">
          <label for="completionNotes">Notes</label>
          <textarea id="completionNotes" placeholder="What was done? Any issues found?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Mark Complete</button>
      </form>
    </div>
  </div>
  
  <!-- Bulk Complete Maintenance Modal -->
  <div id="bulkCompleteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Complete Multiple Items</h2>
        <button class="close-btn" onclick="closeModal('bulkCompleteModal')">&times;</button>
      </div>
      <form id="bulkCompleteForm" onsubmit="bulkCompleteMaintenance(event)">
        <div class="form-group">
          <label>Items to Complete</label>
          <div id="bulkCompleteItemsList" style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div class="form-group">
          <label for="bulkCompletionDate">Completion Date *</label>
          <input type="date" id="bulkCompletionDate" required>
        </div>
        <div class="form-group">
          <label for="bulkCompletionHours">Current Hour Meter / Odometer</label>
          <input type="number" id="bulkCompletionHours" min="0" step="0.1" placeholder="Record current hours/miles at completion">
        </div>
        <div class="form-group">
          <label for="bulkCompletionNotes">Notes (applies to all items)</label>
          <textarea id="bulkCompletionNotes" placeholder="What was done?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Complete All Selected</button>
      </form>
    </div>
  </div>

  <!-- Schedule Maintenance Modal -->
  <div id="scheduleMaintenanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Schedule Maintenance</h2>
        <button class="close-btn" onclick="closeModal('scheduleMaintenanceModal')">&times;</button>
      </div>
      <form id="scheduleMaintenanceForm" onsubmit="scheduleMaintenance(event)">
        <div class="form-group">
          <label for="scheduleEquipment">Equipment *</label>
          <select id="scheduleEquipment" required></select>
        </div>
        <div class="form-group">
          <label for="scheduleDate">Scheduled Date *</label>
          <input type="date" id="scheduleDate" required>
        </div>
        <div class="form-group">
          <label for="scheduleNotes">Maintenance Notes</label>
          <textarea id="scheduleNotes" placeholder="What maintenance is scheduled?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Schedule Maintenance</button>
      </form>
    </div>
  </div>
  
  <!-- Edit Schedule Modal -->
  <div id="editScheduleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Scheduled Maintenance</h2>
        <button class="close-btn" onclick="closeModal('editScheduleModal')">&times;</button>
      </div>
      <form id="editScheduleForm" onsubmit="updateSchedule(event)">
        <input type="hidden" id="editScheduleId">
        <div class="form-group">
          <label for="editScheduleEquipment">Equipment *</label>
          <select id="editScheduleEquipment" required></select>
        </div>
        <div class="form-group">
          <label for="editScheduleDate">Scheduled Date *</label>
          <input type="date" id="editScheduleDate" required>
        </div>
        <div class="form-group">
          <label for="editScheduleNotes">Maintenance Notes</label>
          <textarea id="editScheduleNotes" placeholder="What maintenance is scheduled?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Schedule</button>
      </form>
    </div>
  </div>
  
  <!-- Add Issue Modal -->
  <div id="addIssueModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Log Equipment Issue</h2>
        <button class="close-btn" onclick="closeModal('addIssueModal')">&times;</button>
      </div>
      <form id="addIssueForm" onsubmit="addIssue(event)">
        <div class="form-group">
          <label for="issueEquipment">Equipment *</label>
          <select id="issueEquipment" required></select>
        </div>
        <div class="form-group">
          <label for="issueTitle">Issue Title *</label>
          <input type="text" id="issueTitle" required placeholder="e.g., Hydraulic Leak">
        </div>
        <div class="form-group">
          <label for="issueSeverity">Severity *</label>
          <select id="issueSeverity" required>
            <option value="Minor">Minor - Equipment can still be used</option>
            <option value="Critical">Critical - Equipment is out of service</option>
          </select>
        </div>
        <div class="form-group">
          <label for="issueCost">Estimated Repair Cost</label>
          <input type="number" id="issueCost" step="0.01" min="0" placeholder="e.g., 250.00">
        </div>
        <div class="form-group">
          <label for="issueNotes">Issue Description/Notes *</label>
          <textarea id="issueNotes" required placeholder="Describe the issue in detail..."></textarea>
        </div>
        <div class="form-group">
          <label>Photos (optional)</label>
          <div class="photo-upload-area" id="issuePhotoArea" onclick="document.getElementById('issuePhoto').click()">
            <div id="issuePhotoPlaceholder">üì∑ Click to add photos</div>
            <input type="file" id="issuePhoto" accept="image/*" multiple style="display: none;" onchange="window.previewIssuePhotos(this)">
          </div>
          <div id="issuePhotoPreviews" class="photo-previews-container"></div>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Log Issue</button>
      </form>
    </div>
  </div>

  <!-- Edit Issue Modal -->
  <div id="editIssueModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Equipment Issue</h2>
        <button class="close-btn" onclick="closeModal('editIssueModal')">&times;</button>
      </div>
      <form id="editIssueForm" onsubmit="updateIssue(event)">
        <input type="hidden" id="editIssueId">
        <div class="form-group">
          <label for="editIssueEquipment">Equipment *</label>
          <select id="editIssueEquipment" required></select>
        </div>
        <div class="form-group">
          <label for="editIssueTitle">Issue Title *</label>
          <input type="text" id="editIssueTitle" required placeholder="e.g., Hydraulic Leak">
        </div>
        <div class="form-group">
          <label for="editIssueSeverity">Severity *</label>
          <select id="editIssueSeverity" required>
            <option value="Minor">Minor - Equipment can still be used</option>
            <option value="Critical">Critical - Equipment is out of service</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editIssueReportedDate">Reported Date *</label>
          <input type="date" id="editIssueReportedDate" required>
        </div>
        <div class="form-group">
          <label for="editIssueCost">Estimated Repair Cost</label>
          <input type="number" id="editIssueCost" step="0.01" min="0" placeholder="e.g., 250.00">
        </div>
        <div class="form-group">
          <label for="editIssueNotes">Issue Description/Notes *</label>
          <textarea id="editIssueNotes" required placeholder="Describe the issue in detail..."></textarea>
        </div>
        <div class="form-group">
          <label>Photos</label>
          <div id="editIssueCurrentPhotos" class="photo-previews-container" style="margin-bottom: 0.5rem;"></div>
          <div class="photo-upload-area" id="editIssuePhotoArea" onclick="document.getElementById('editIssuePhoto').click()">
            <div id="editIssuePhotoPlaceholder">üì∑ Click to add more photos</div>
            <input type="file" id="editIssuePhoto" accept="image/*" multiple style="display: none;" onchange="window.previewEditIssuePhotos(this)">
          </div>
          <div id="editIssueNewPhotos" class="photo-previews-container"></div>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Issue</button>
      </form>
    </div>
  </div>
  
  <!-- Add Maintenance Item Modal -->
  <div id="addMaintenanceItemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Maintenance Item</h2>
        <button class="close-btn" onclick="closeModal('addMaintenanceItemModal')">&times;</button>
      </div>
      <form id="addMaintenanceItemForm" onsubmit="addMaintenanceItem(event)">
        <div class="form-group">
          <label for="maintenanceItemName">Maintenance Item Name *</label>
          <input type="text" id="maintenanceItemName" required placeholder="e.g., Oil Change">
        </div>
        <div class="form-group">
          <label for="maintenanceItemInterval">Interval (days)</label>
          <input type="number" id="maintenanceItemInterval" min="1" placeholder="e.g., 90 (leave blank if hour-based only)">
        </div>
        <div class="form-group">
          <label for="maintenanceItemHourInterval">Interval (hours/miles)</label>
          <input type="number" id="maintenanceItemHourInterval" min="1" placeholder="e.g., 250 (leave blank if time-based only)">
        </div>
        <div class="form-group">
          <label for="maintenanceItemDescription">Description/Instructions</label>
          <textarea id="maintenanceItemDescription" placeholder="Detailed instructions for this maintenance item..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Maintenance Item</button>
      </form>
    </div>
  </div>
  
  <!-- Edit Maintenance Item Modal -->
  <div id="editMaintenanceItemModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit Maintenance Item</h2>
        <button class="close-btn" onclick="closeModal('editMaintenanceItemModal')">&times;</button>
      </div>
      <form id="editMaintenanceItemForm" onsubmit="window.updateMaintenanceItem(event)">
        <input type="hidden" id="editMaintenanceItemId">
        <div class="form-group">
          <label for="editMaintenanceItemName">Maintenance Item Name *</label>
          <input type="text" id="editMaintenanceItemName" required placeholder="e.g., Oil Change">
        </div>
        <div class="form-group">
          <label for="editMaintenanceItemInterval">Interval (days)</label>
          <input type="number" id="editMaintenanceItemInterval" min="1" placeholder="e.g., 90 (leave blank if hour-based only)">
        </div>
        <div class="form-group">
          <label for="editMaintenanceItemHourInterval">Interval (hours/miles)</label>
          <input type="number" id="editMaintenanceItemHourInterval" min="1" placeholder="e.g., 250 (leave blank if time-based only)">
        </div>
        <div class="form-group">
          <label for="editMaintenanceItemDescription">Description/Instructions</label>
          <textarea id="editMaintenanceItemDescription" placeholder="Detailed instructions for this maintenance item..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Update Maintenance Item</button>
      </form>
    </div>
  </div>

  <!-- Check Out Equipment Modal -->
  <div id="checkOutModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Check Out Equipment</h2>
        <button class="close-btn" onclick="closeModal('checkOutModal')">&times;</button>
      </div>
      <form id="checkOutForm" onsubmit="window.checkOutEquipment(event)">
        <div class="form-group">
          <label for="checkOutEquipment">Equipment *</label>
          <select id="checkOutEquipment" required></select>
        </div>
        <div class="form-group">
          <label for="checkOutCustomer">Customer Name *</label>
          <input type="text" id="checkOutCustomer" required placeholder="e.g., John Smith">
        </div>
        <div class="form-group">
          <label for="checkOutDate">Check Out Date *</label>
          <input type="date" id="checkOutDate" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Check Out</button>
      </form>
    </div>
  </div>
  
  <!-- Email Digest Modal -->
  <div id="emailDigestModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Email Maintenance Digest</h2>
        <button class="close-btn" onclick="closeModal('emailDigestModal')">&times;</button>
      </div>
      <div class="email-config">
        <div class="form-group">
          <label for="digestEmail">Email Address *</label>
          <input type="email" id="digestEmail" required placeholder="recipient@example.com">
        </div>
        <div class="form-group">
          <label for="digestDays">Include items due within (days)</label>
          <select id="digestDays">
            <option value="7">Next 7 days</option>
            <option value="14">Next 14 days</option>
            <option value="30" selected>Next 30 days</option>
            <option value="60">Next 60 days</option>
          </select>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn" onclick="window.generateDigestPreview()">Preview Digest</button>
          <button class="btn btn-primary" onclick="window.sendEmailDigest()">üìß Send Email</button>
          <button class="btn" onclick="window.copyDigestToClipboard()">üìã Copy to Clipboard</button>
        </div>
      </div>
      <div id="digestPreview" class="email-preview" style="display: none;"></div>
    </div>
  </div>

  <!-- Photo Viewer Modal -->
  <div id="photoViewerModal" class="modal" onclick="closeModal('photoViewerModal')">
    <div class="modal-content" style="max-width: 90vw; background: transparent; box-shadow: none; text-align: center;">
      <img id="photoViewerImage" style="max-width: 100%; max-height: 85vh; border-radius: 8px;">
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDVqhdUUCMcASjEewt9Yv1Nky0hr2-FTmQ",
      authDomain: "pm-log.firebaseapp.com",
      projectId: "pm-log",
      storageBucket: "pm-log.firebasestorage.app",
      messagingSenderId: "993822676610",
      appId: "1:993822676610:web:1e001809e089a6c6a0069b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    let equipment = [];
    let templates = [];
    let schedules = [];
    let issues = [];
    let locations = [];
    let products = [];
    let loads = [];
    let tasks = [];
    let orders = [];
    let unitOfMeasures = [];
    let assignedOptions = [];
    let collapsedLoads = new Set();
    let selectedOrders = new Set();
    let currentEquipmentId = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let calendarViewMode = 'month'; // 'month' or 'week'
    let currentWeekStart = getWeekStart(new Date());
    let currentIssuePhotos = [];
    let editIssueExistingPhotos = [];
    let editIssueNewPhotos = [];

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      d.setDate(d.getDate() - day);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    // Loading overlay functions
    function showLoading(message = 'Loading...') {
      document.getElementById('loadingText').textContent = message;
      document.getElementById('loadingOverlay').classList.add('active');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Toast notification function
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      let icon = '‚úì';
      if (type === 'error') icon = '‚úï';
      if (type === 'warning') icon = '‚ö†';

      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
      `;

      container.appendChild(toast);

      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 10);

      // Remove after 3 seconds
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Compress image to ensure it's under target size for Firestore storage
    // Target ~200KB per image to allow multiple photos while staying under 1MB document limit
    function compressImage(file, targetSizeKB = 200) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            let maxWidth = 1200;
            let quality = 0.8;

            // Function to compress with current settings
            function tryCompress() {
              // Scale down if needed
              if (width > maxWidth) {
                const ratio = maxWidth / width;
                width = maxWidth;
                height = height * ratio;
              }

              canvas.width = width;
              canvas.height = height;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // Convert to compressed JPEG
              const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

              // Check size (base64 is ~33% larger than binary)
              const sizeKB = (compressedDataUrl.length * 0.75) / 1024;

              if (sizeKB <= targetSizeKB || quality <= 0.1) {
                // Either we're under target or at minimum quality
                resolve(compressedDataUrl);
              } else {
                // Reduce quality and/or size and try again
                if (quality > 0.3) {
                  quality -= 0.1;
                } else {
                  // At low quality, also reduce dimensions
                  maxWidth = Math.max(400, maxWidth - 200);
                  width = img.width;
                  height = img.height;
                  quality = Math.max(0.1, quality - 0.05);
                }
                tryCompress();
              }
            }

            tryCompress();
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function loadData(showLoadingIndicator = true) {
      if (showLoadingIndicator) showLoading('Loading data...');
      try {
        const equipmentSnapshot = await getDocs(collection(db, 'equipment'));
        equipment = equipmentSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const templatesSnapshot = await getDocs(collection(db, 'maintenanceTemplates'));
        templates = templatesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const schedulesSnapshot = await getDocs(collection(db, 'schedules'));
        schedules = schedulesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const issuesSnapshot = await getDocs(collection(db, 'issues'));
        issues = issuesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const locationsSnapshot = await getDocs(collection(db, 'locations'));
        locations = locationsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const productsSnapshot = await getDocs(collection(db, 'products'));
        products = productsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const loadsSnapshot = await getDocs(collection(db, 'loads'));
        loads = loadsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        const tasksSnapshot = await getDocs(collection(db, 'tasks'));
        tasks = tasksSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Load orders
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        orders = ordersSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // Load unit of measures
        const uomSnapshot = await getDocs(collection(db, 'unitOfMeasures'));
        unitOfMeasures = uomSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        // Initialize default UOMs if empty
        if (unitOfMeasures.length === 0) {
          const defaultUoms = ['Each', 'Tons', 'Trailers', 'Gallons', 'Acres'];
          for (const name of defaultUoms) {
            await addDoc(collection(db, 'unitOfMeasures'), { name });
          }
          const refreshUom = await getDocs(collection(db, 'unitOfMeasures'));
          unitOfMeasures = refreshUom.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // Load assigned options for load tracking
        const assignedOptionsSnapshot = await getDocs(collection(db, 'assignedOptions'));
        assignedOptions = assignedOptionsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        renderEquipment();
        renderTemplates();
        populateEquipmentSelects();
        populateProductSelects();
        populateTaskOwnerFilter();
        populateOrderAssignedFilter();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data. Please refresh the page.', 'error');
      } finally {
        if (showLoadingIndicator) hideLoading();
      }
    }
    
    function populateEquipmentSelects() {
      const scheduleEquipmentSelect = document.getElementById('scheduleEquipment');
      const editScheduleEquipmentSelect = document.getElementById('editScheduleEquipment');
      const scheduleFilterSelect = document.getElementById('scheduleEquipmentFilter');
      const issueEquipmentSelect = document.getElementById('issueEquipment');
      const editIssueEquipmentSelect = document.getElementById('editIssueEquipment');
      const issueFilterSelect = document.getElementById('issuesEquipmentFilter');
      
      // Group equipment by type
      const grouped = {};
      equipment.forEach(eq => {
        if (!grouped[eq.type]) {
          grouped[eq.type] = [];
        }
        grouped[eq.type].push(eq);
      });
      
      // Create grouped options HTML
      let groupedOptions = '';
      Object.keys(grouped).sort().forEach(type => {
        groupedOptions += `<optgroup label="${type}">`;
        grouped[type].forEach(eq => {
          groupedOptions += `<option value="${eq.id}">${eq.equipmentId} - ${eq.name}</option>`;
        });
        groupedOptions += '</optgroup>';
      });
      
      // Create flat options for filters
      const flatOptions = equipment.map(eq => 
        `<option value="${eq.id}">${eq.equipmentId} - ${eq.name}</option>`
      ).join('');
      
      if (scheduleEquipmentSelect) {
        scheduleEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>' + groupedOptions;
      }
      
      if (editScheduleEquipmentSelect) {
        editScheduleEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>' + groupedOptions;
      }
      
      if (scheduleFilterSelect) {
        scheduleFilterSelect.innerHTML = '<option value="">All Equipment</option>' + flatOptions;
      }
      
      if (issueEquipmentSelect) {
        issueEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>' + groupedOptions;
      }
      
      if (editIssueEquipmentSelect) {
        editIssueEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>' + groupedOptions;
      }
      
      if (issueFilterSelect) {
        // Group filters by equipment type
        let filterGroupedOptions = '<option value="">All Equipment</option>';
        Object.keys(grouped).sort().forEach(type => {
          filterGroupedOptions += `<optgroup label="${type}">`;
          grouped[type].forEach(eq => {
            filterGroupedOptions += `<option value="${eq.id}">${eq.equipmentId} - ${eq.name}</option>`;
          });
          filterGroupedOptions += '</optgroup>';
        });
        issueFilterSelect.innerHTML = filterGroupedOptions;
      }
      
      // Location tab selects
      const checkOutEquipmentSelect = document.getElementById('checkOutEquipment');
      const locationFilterSelect = document.getElementById('locationEquipmentFilter');
      
      if (checkOutEquipmentSelect) {
        checkOutEquipmentSelect.innerHTML = '<option value="">Select Equipment</option>' + groupedOptions;
      }
      
      if (locationFilterSelect) {
        let locationFilterGroupedOptions = '<option value="">All Equipment</option>';
        Object.keys(grouped).sort().forEach(type => {
          locationFilterGroupedOptions += `<optgroup label="${type}">`;
          grouped[type].forEach(eq => {
            locationFilterGroupedOptions += `<option value="${eq.id}">${eq.equipmentId} - ${eq.name}</option>`;
          });
          locationFilterGroupedOptions += '</optgroup>';
        });
        locationFilterSelect.innerHTML = locationFilterGroupedOptions;
      }
      
      // Cost Repair tab select
      const costRepairFilterSelect = document.getElementById('costRepairEquipmentFilter');
      if (costRepairFilterSelect) {
        let costRepairFilterGroupedOptions = '<option value="">Select Equipment</option>';
        Object.keys(grouped).sort().forEach(type => {
          costRepairFilterGroupedOptions += `<optgroup label="${type}">`;
          grouped[type].forEach(eq => {
            costRepairFilterGroupedOptions += `<option value="${eq.id}">${eq.equipmentId} - ${eq.name}</option>`;
          });
          costRepairFilterGroupedOptions += '</optgroup>';
        });
        costRepairFilterSelect.innerHTML = costRepairFilterGroupedOptions;
      }
    }
    
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        if (tabName === 'schedule') {
          renderScheduleCalendar();
        } else if (tabName === 'issues') {
          renderIssues();
        } else if (tabName === 'dashboard') {
          renderDashboard();
        } else if (tabName === 'location') {
          renderLocations();
        } else if (tabName === 'costrepair') {
          renderCostRepair();
        } else if (tabName === 'products') {
          renderProducts();
        } else if (tabName === 'loads') {
          renderLoads();
        } else if (tabName === 'tasks') {
          renderTasks();
        } else if (tabName === 'orders') {
          renderOrders();
        }
      });
    });
    
    window.openAddEquipmentModal = function() {
      document.getElementById('addEquipmentModal').classList.add('active');
      document.getElementById('templateLoadSection').style.display = 'none';
    }
    
    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    window.loadMaintenanceTemplates = function() {
      const type = document.getElementById('equipmentType').value;
      const section = document.getElementById('templateLoadSection');
      const container = document.getElementById('availableTemplates');
      
      if (!type) {
        section.style.display = 'none';
        return;
      }
      
      const typeTemplates = templates.filter(t => t.equipmentType === type);
      
      if (typeTemplates.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      container.innerHTML = typeTemplates.map(t => `
        <div class="checkbox-group">
          <input type="checkbox" id="template-${t.id}" value="${t.id}" checked>
          <label for="template-${t.id}" style="margin: 0; text-transform: none; font-weight: normal; color: var(--text-primary);">
            ${t.name} (Every ${t.interval} days)
          </label>
        </div>
      `).join('');
    }
    
    window.addEquipment = async function(event) {
      event.preventDefault();

      const equipmentIdValue = document.getElementById('equipmentId').value.trim();

      // Check for duplicate Equipment ID
      const existingEquipment = equipment.find(eq =>
        eq.equipmentId.toLowerCase() === equipmentIdValue.toLowerCase()
      );
      if (existingEquipment) {
        showToast(`Equipment ID "${equipmentIdValue}" already exists. Please use a unique ID.`, 'error');
        return;
      }

      const type = document.getElementById('equipmentType').value;
      const selectedTemplates = Array.from(document.querySelectorAll('#availableTemplates input[type="checkbox"]:checked'))
        .map(cb => cb.value);

      const maintenanceItems = selectedTemplates.map(templateId => {
        const template = templates.find(t => t.id === templateId);
        return {
          id: Date.now() + Math.random(),
          name: template.name,
          interval: template.interval,
          description: template.description,
          lastCompleted: null,
          history: []
        };
      });

      const hourMeterValue = document.getElementById('equipmentHourMeter').value;

      const newEquipment = {
        equipmentId: equipmentIdValue,
        name: document.getElementById('equipmentName').value,
        snvin: document.getElementById('equipmentSNVIN').value,
        type: type,
        location: document.getElementById('equipmentLocation').value,
        hourMeter: hourMeterValue ? parseFloat(hourMeterValue) : null,
        maintenanceItems: maintenanceItems,
        createdAt: new Date().toISOString()
      };

      showLoading('Adding equipment...');

      try {
        await addDoc(collection(db, 'equipment'), newEquipment);
        await loadData(false);
        hideLoading();
        showToast('Equipment added successfully');
        document.getElementById('addEquipmentForm').reset();
        closeModal('addEquipmentModal');
      } catch (error) {
        console.error('Error adding equipment:', error);
        hideLoading();
        showToast('Error adding equipment. Please try again.', 'error');
      }
    }
    
    window.addTemplate = async function(event) {
      event.preventDefault();

      const newTemplate = {
        equipmentType: document.getElementById('templateEquipmentType').value,
        name: document.getElementById('templateName').value,
        interval: parseInt(document.getElementById('templateInterval').value),
        description: document.getElementById('templateDescription').value,
        createdAt: new Date().toISOString()
      };

      showLoading('Creating template...');

      try {
        await addDoc(collection(db, 'maintenanceTemplates'), newTemplate);
        await loadData(false);
        hideLoading();
        showToast('Template created successfully');
        document.getElementById('addTemplateForm').reset();
        closeModal('addTemplateModal');
      } catch (error) {
        console.error('Error adding template:', error);
        hideLoading();
        showToast('Error adding template. Please try again.', 'error');
      }
    }
    
    function getMaintenanceStatus(item, eq = null) {
      // Check if never completed
      if (!item.lastCompleted && !item.lastCompletedHours) {
        return { status: 'danger', daysUntil: -999, nextDue: 'Never Done', statusText: 'Past Due', hoursUntil: null };
      }

      let dayStatus = null;
      let hourStatus = null;
      let daysUntil = 999;
      let hoursUntil = null;
      let nextDue = '';

      // Check day-based interval
      if (item.interval && item.lastCompleted) {
        const lastDate = new Date(item.lastCompleted);
        const today = new Date();
        const nextDueDate = new Date(lastDate);
        nextDueDate.setDate(nextDueDate.getDate() + item.interval);
        daysUntil = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
        nextDue = nextDueDate.toLocaleDateString();

        if (daysUntil < 0) dayStatus = 'danger';
        else if (daysUntil <= 7) dayStatus = 'warning';
        else dayStatus = 'good';
      }

      // Check hour-based interval
      if (item.hourInterval && eq && eq.hourMeter !== null && eq.hourMeter !== undefined) {
        const lastHours = item.lastCompletedHours || 0;
        const currentHours = eq.hourMeter;
        const nextDueHours = lastHours + item.hourInterval;
        hoursUntil = nextDueHours - currentHours;

        if (hoursUntil < 0) hourStatus = 'danger';
        else if (hoursUntil <= 25) hourStatus = 'warning'; // Within 25 hours
        else hourStatus = 'good';

        // Add hours info to next due string
        if (nextDue) {
          nextDue += ` or ${nextDueHours.toLocaleString()} hrs`;
        } else {
          nextDue = `${nextDueHours.toLocaleString()} hrs`;
        }
      }

      // Determine overall status (worst of the two)
      let status = 'good';
      if (dayStatus === 'danger' || hourStatus === 'danger') status = 'danger';
      else if (dayStatus === 'warning' || hourStatus === 'warning') status = 'warning';

      let statusText = 'On Schedule';
      if (status === 'danger') statusText = 'Past Due';
      else if (status === 'warning') statusText = 'Coming Due';

      return {
        status,
        daysUntil: daysUntil !== 999 ? daysUntil : (hoursUntil !== null ? Math.round(hoursUntil) : -999),
        hoursUntil,
        nextDue: nextDue || 'Not Set',
        statusText
      };
    }

    function getEquipmentOverallStatus(eq) {
      if (!eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        return { status: 'good', itemsOverdue: 0, itemsDueSoon: 0 };
      }

      let itemsOverdue = 0;
      let itemsDueSoon = 0;

      eq.maintenanceItems.forEach(item => {
        const { status } = getMaintenanceStatus(item, eq);
        if (status === 'danger') itemsOverdue++;
        else if (status === 'warning') itemsDueSoon++;
      });

      let overallStatus = 'good';
      if (itemsOverdue > 0) overallStatus = 'danger';
      else if (itemsDueSoon > 0) overallStatus = 'warning';

      return { status: overallStatus, itemsOverdue, itemsDueSoon };
    }
    
    function hasActiveIssues(equipmentId) {
      return issues.filter(i => i.equipmentId === equipmentId && i.status === 'Pending').length;
    }
    
    function isCheckedOut(equipmentId) {
      return locations.filter(l => l.equipmentId === equipmentId && l.status === 'Checked Out').length > 0;
    }
    
    function renderEquipment(searchTerm = '') {
      const grid = document.getElementById('equipmentGrid');
      const searchInput = document.getElementById('equipmentSearch');
      const term = searchTerm || (searchInput ? searchInput.value.toLowerCase().trim() : '');

      // Filter equipment based on search term
      let filteredEquipment = equipment;
      if (term) {
        filteredEquipment = equipment.filter(eq =>
          eq.equipmentId.toLowerCase().includes(term) ||
          eq.name.toLowerCase().includes(term) ||
          eq.type.toLowerCase().includes(term) ||
          (eq.snvin && eq.snvin.toLowerCase().includes(term)) ||
          (eq.location && eq.location.toLowerCase().includes(term))
        );
      }

      if (filteredEquipment.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">${term ? 'üîç' : 'üöú'}</div>
            <h3>${term ? 'No Equipment Found' : 'No Equipment Added'}</h3>
            <p>${term ? 'Try a different search term' : 'Click "Add Equipment" to start tracking your fleet'}</p>
          </div>
        `;
        return;
      }

      // Group equipment by type
      const grouped = {};
      filteredEquipment.forEach(eq => {
        if (!grouped[eq.type]) {
          grouped[eq.type] = [];
        }
        grouped[eq.type].push(eq);
      });
      
      // Render grouped equipment
      let html = '';
      Object.keys(grouped).sort().forEach(type => {
        html += `
          <div style="grid-column: 1 / -1; margin-top: 2rem;">
            <h2 style="font-family: 'Roboto Condensed', sans-serif; color: var(--helena-green); font-size: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--helena-green);">
              ${type}
            </h2>
          </div>
        `;
        
        grouped[type].forEach(eq => {
          const { status, itemsOverdue, itemsDueSoon } = getEquipmentOverallStatus(eq);
          const pendingIssues = hasActiveIssues(eq.id);
          const hasCriticalIssue = issues.filter(i => i.equipmentId === eq.id && i.status === 'Pending' && i.severity === 'Critical').length > 0;
          const checkedOut = isCheckedOut(eq.id);
          
          let statusText = 'All Good';
          let statusClass = 'status-good';
          
          if (status === 'danger') {
            statusText = `${itemsOverdue} Overdue`;
            statusClass = 'status-danger';
          } else if (status === 'warning') {
            statusText = `${itemsDueSoon} Due Soon`;
            statusClass = 'status-warning';
          }
          
          // Get next due item info
          let nextDueInfo = null;
          if (eq.maintenanceItems && eq.maintenanceItems.length > 0) {
            let soonest = null;
            eq.maintenanceItems.forEach(item => {
              const itemStatus = getMaintenanceStatus(item, eq);
              if (!soonest || itemStatus.daysUntil < soonest.daysUntil) {
                soonest = { ...itemStatus, name: item.name };
              }
            });
            nextDueInfo = soonest;
          }

          html += `
            <div class="equipment-card ${pendingIssues > 0 ? 'has-issues' : ''}">
              ${pendingIssues > 0 ? `<div class="repair-badge" style="${hasCriticalIssue ? 'background: var(--danger);' : ''}">${checkedOut ? 'üìç ' : ''}‚ö† ${pendingIssues} Issue${pendingIssues > 1 ? 's' : ''}</div>` : checkedOut ? `<div class="repair-badge" style="background: #2196F3;">üìç Checked Out</div>` : ''}
              <div class="equipment-header">
                <div>
                  <div class="equipment-id">${eq.equipmentId}</div>
                  <div class="equipment-name">${eq.name}</div>
                  <div class="equipment-type">${eq.type}</div>
                  ${eq.snvin ? `<div class="equipment-snvin">SN/VIN: ${eq.snvin}</div>` : ''}
                  ${eq.hourMeter ? `<div class="hour-meter-display">üïê <strong>${eq.hourMeter.toLocaleString()}</strong> hours/miles</div>` : ''}
                </div>
                <span class="status-badge ${statusClass}">${statusText}</span>
              </div>

              <div class="equipment-stats">
                <div class="stat-item">
                  <div class="stat-label">Items</div>
                  <div class="stat-value">${eq.maintenanceItems ? eq.maintenanceItems.length : 0}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Overdue</div>
                  <div class="stat-value" style="color: var(--danger);">${itemsOverdue}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Due Soon</div>
                  <div class="stat-value" style="color: var(--warning);">${itemsDueSoon}</div>
                </div>
              </div>

              ${nextDueInfo ? `
                <div class="next-due-badge ${nextDueInfo.status === 'danger' ? 'overdue' : nextDueInfo.status === 'warning' ? 'soon' : 'ok'}">
                  ${nextDueInfo.status === 'danger' ? '‚ö†Ô∏è' : nextDueInfo.status === 'warning' ? '‚è∞' : '‚úì'}
                  Next: ${nextDueInfo.name} ${nextDueInfo.daysUntil === -999 ? '(Never done)' : nextDueInfo.daysUntil < 0 ? `(${Math.abs(nextDueInfo.daysUntil)}d overdue)` : `(${nextDueInfo.daysUntil}d)`}
                </div>
              ` : ''}

              <div class="quick-actions">
                <button class="quick-action-btn" onclick="event.stopPropagation(); window.quickLogIssue('${eq.id}')">‚ö†Ô∏è Log Issue</button>
                <button class="quick-action-btn" onclick="event.stopPropagation(); window.viewEquipmentDetails('${eq.id}')">üìã Details</button>
              </div>

              <div class="equipment-actions">
                <button class="btn btn-small btn-primary" onclick="window.viewEquipmentDetails('${eq.id}')">View Details</button>
                <button class="btn btn-small" onclick="window.openEditEquipmentModal('${eq.id}')">Edit</button>
                <button class="btn btn-small" onclick="window.deleteEquipment('${eq.id}')">Delete</button>
              </div>
            </div>
          `;
        });
      });
      
      grid.innerHTML = html;
    }
    
    function renderTemplates() {
      const container = document.getElementById('templatesList');
      
      if (templates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>No Templates Created</h3>
            <p>Create maintenance templates that will auto-load when adding equipment</p>
          </div>
        `;
        return;
      }
      
      const grouped = {};
      templates.forEach(t => {
        if (!grouped[t.equipmentType]) {
          grouped[t.equipmentType] = [];
        }
        grouped[t.equipmentType].push(t);
      });
      
      container.innerHTML = Object.keys(grouped).sort().map(type => `
        <div class="template-section">
          <h3 style="font-family: 'Roboto Condensed', sans-serif; color: var(--helena-green); margin-bottom: 1rem;">${type}</h3>
          ${grouped[type].map(t => `
            <div class="template-item">
              <div class="template-info">
                <div class="template-name">${t.name}</div>
                <div class="template-desc">Every ${t.interval} days${t.description ? ' - ' + t.description : ''}</div>
              </div>
              <button class="btn btn-small" onclick="window.deleteTemplate('${t.id}')">Delete</button>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    
    // Equipment search/filter function
    window.filterEquipment = function() {
      renderEquipment();
    }

    window.viewEquipmentDetails = function(equipmentId) {
      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;

      currentEquipmentId = equipmentId;

      document.getElementById('detailsEquipmentName').textContent = `${eq.equipmentId} - ${eq.name}`;

      const content = document.getElementById('equipmentDetailsContent');
      const isCurrentlyCheckedOut = isCheckedOut(equipmentId);

      // Equipment info section
      let infoHTML = `
        <div style="background: var(--bg-primary); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div><strong>Type:</strong> ${eq.type}</div>
            <div><strong>Location:</strong> ${eq.location || 'Not specified'}</div>
            ${eq.snvin ? `<div><strong>SN/VIN:</strong> ${eq.snvin}</div>` : ''}
            ${eq.hourMeter ? `<div><strong>Hour Meter:</strong> ${eq.hourMeter.toLocaleString()} hrs/mi</div>` : ''}
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
            <button class="btn btn-small" onclick="window.viewEquipmentTimeline('${eq.id}')">üìú View Timeline</button>
            ${!isCurrentlyCheckedOut ? `<button class="btn btn-small" onclick="window.quickCheckOut('${eq.id}')">üìç Check Out</button>` : `<button class="btn btn-small" style="background: #2196F3; color: white; border-color: #2196F3;">üìç Currently Checked Out</button>`}
            <button class="btn btn-small" onclick="window.quickLogIssue('${eq.id}'); closeModal('equipmentDetailsModal');">‚ö†Ô∏è Log Issue</button>
          </div>
        </div>
      `;

      if (!eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        content.innerHTML = infoHTML + `
          <div class="empty-state">
            <p>No maintenance items configured for this equipment.</p>
          </div>
        `;
      } else {
        // Sort by urgency first, then by interval
        const sortedItems = [...eq.maintenanceItems].sort((a, b) => {
          const aStatus = getMaintenanceStatus(a, eq);
          const bStatus = getMaintenanceStatus(b, eq);
          // Sort by urgency (danger first, then warning, then good)
          const statusOrder = { danger: 0, warning: 1, good: 2 };
          if (statusOrder[aStatus.status] !== statusOrder[bStatus.status]) {
            return statusOrder[aStatus.status] - statusOrder[bStatus.status];
          }
          // Then by days until due
          return aStatus.daysUntil - bStatus.daysUntil;
        });

        // Bulk complete header
        let bulkActionsHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-primary); border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin: 0;">
                <input type="checkbox" id="selectAllMaintenance" onchange="window.toggleAllMaintenance(this.checked)" style="width: 18px; height: 18px;">
                <span style="font-weight: 600;">Select All</span>
              </label>
              <span id="selectedCount" style="color: var(--text-secondary); font-size: 0.85rem;">(0 selected)</span>
            </div>
            <button class="btn btn-small btn-primary" onclick="window.openBulkCompleteModal('${eq.id}')" id="bulkCompleteBtn" disabled>Complete Selected</button>
          </div>
        `;

        content.innerHTML = infoHTML + bulkActionsHTML + `
          <div class="maintenance-list">
            ${sortedItems.map(item => {
              const { status, daysUntil, hoursUntil, nextDue, statusText } = getMaintenanceStatus(item, eq);

              let statusClass = 'status-good';
              let statusBadgeText = 'Up to Date';

              if (status === 'danger') {
                statusClass = 'status-danger';
                statusBadgeText = daysUntil === -999 ? 'Never Done' : `${Math.abs(daysUntil)} Overdue`;
              } else if (status === 'warning') {
                statusClass = 'status-warning';
                statusBadgeText = `Due in ${daysUntil}${item.hourInterval ? ' days/hrs' : ' days'}`;
              } else {
                statusBadgeText = `Due in ${daysUntil}${item.hourInterval ? ' days/hrs' : ' days'}`;
              }

              // Build interval string
              let intervalStr = '';
              if (item.interval) intervalStr += `${item.interval} days`;
              if (item.interval && item.hourInterval) intervalStr += ' or ';
              if (item.hourInterval) intervalStr += `${item.hourInterval} hours`;

              return `
                <div class="maintenance-item" style="position: relative;">
                  <div style="position: absolute; top: 1rem; left: 1rem;">
                    <input type="checkbox" class="maintenance-checkbox" data-item-id="${item.id}" data-item-name="${item.name}" onchange="window.updateSelectedCount()" style="width: 18px; height: 18px; cursor: pointer;">
                  </div>
                  <div style="margin-left: 2rem;">
                    <div class="maintenance-header">
                      <div>
                        <div class="maintenance-title">${item.name}</div>
                        <div class="maintenance-interval">Every ${intervalStr}</div>
                      </div>
                      <span class="status-badge ${statusClass}">${statusBadgeText}</span>
                    </div>
                    ${item.description ? `<div class="maintenance-description">${item.description}</div>` : ''}
                    <div class="maintenance-status">
                      <strong>Last Completed:</strong> ${item.lastCompleted ? new Date(item.lastCompleted).toLocaleDateString() : 'Never'}
                      ${item.lastCompletedHours ? ` @ ${item.lastCompletedHours.toLocaleString()} hrs` : ''}<br>
                      <strong>Next Due:</strong> ${nextDue}<br>
                      <strong>Status:</strong> ${statusText}
                    </div>
                    <div class="equipment-actions" style="margin-top: 1rem;">
                      <button class="btn btn-small btn-primary" onclick="window.openCompleteModal('${eq.id}', '${item.id}')">Mark Complete</button>
                      <button class="btn btn-small" onclick="window.openEditMaintenanceItemModal('${eq.id}', '${item.id}')">Edit</button>
                      <button class="btn btn-small" onclick="window.deleteMaintenanceItem('${eq.id}', '${item.id}')">Delete</button>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      document.getElementById('equipmentDetailsModal').classList.add('active');
    }

    // Quick checkout from equipment details
    window.quickCheckOut = function(equipmentId) {
      document.getElementById('checkOutEquipment').value = equipmentId;
      document.getElementById('checkOutDate').value = new Date().toISOString().split('T')[0];
      closeModal('equipmentDetailsModal');
      document.getElementById('checkOutModal').classList.add('active');
    }
    
    window.openCompleteModal = function(equipmentId, maintenanceId) {
      const eq = equipment.find(e => e.id === equipmentId);
      const item = eq.maintenanceItems.find(m => m.id == maintenanceId);
      
      document.getElementById('completeEquipmentId').value = equipmentId;
      document.getElementById('completeMaintenanceId').value = maintenanceId;
      document.getElementById('completeMaintenanceName').textContent = item.name;
      document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
      
      document.getElementById('completeMaintenanceModal').classList.add('active');
    }
    
    window.completeMaintenance = async function(event) {
      event.preventDefault();

      const equipmentId = document.getElementById('completeEquipmentId').value;
      const maintenanceId = document.getElementById('completeMaintenanceId').value;
      const date = document.getElementById('completionDate').value;
      const hoursValue = document.getElementById('completionHours').value;
      const notes = document.getElementById('completionNotes').value;

      const eq = equipment.find(e => e.id === equipmentId);
      const item = eq.maintenanceItems.find(m => m.id == maintenanceId);

      if (!item.history) item.history = [];

      const historyEntry = {
        date: date,
        notes: notes,
        completedAt: new Date().toISOString()
      };

      // Add hours if provided
      if (hoursValue) {
        historyEntry.hours = parseFloat(hoursValue);
        item.lastCompletedHours = parseFloat(hoursValue);
        // Also update equipment hour meter
        eq.hourMeter = parseFloat(hoursValue);
      }

      item.history.push(historyEntry);
      item.lastCompleted = date;

      showLoading('Saving maintenance record...');

      try {
        const updateData = {
          maintenanceItems: eq.maintenanceItems
        };
        // Update hour meter if changed
        if (hoursValue) {
          updateData.hourMeter = parseFloat(hoursValue);
        }

        await updateDoc(doc(db, 'equipment', equipmentId), updateData);

        await loadData(false);
        hideLoading();
        showToast('Maintenance marked complete');
        document.getElementById('completeMaintenanceForm').reset();
        closeModal('completeMaintenanceModal');
        viewEquipmentDetails(equipmentId);
      } catch (error) {
        console.error('Error completing maintenance:', error);
        hideLoading();
        showToast('Error saving maintenance. Please try again.', 'error');
      }
    }

    // Bulk maintenance completion functions
    window.toggleAllMaintenance = function(checked) {
      const checkboxes = document.querySelectorAll('.maintenance-checkbox');
      checkboxes.forEach(cb => cb.checked = checked);
      updateSelectedCount();
    }

    window.updateSelectedCount = function() {
      const checkboxes = document.querySelectorAll('.maintenance-checkbox:checked');
      const count = checkboxes.length;
      document.getElementById('selectedCount').textContent = `(${count} selected)`;
      document.getElementById('bulkCompleteBtn').disabled = count === 0;

      // Update select all checkbox state
      const allCheckboxes = document.querySelectorAll('.maintenance-checkbox');
      const selectAll = document.getElementById('selectAllMaintenance');
      if (count === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (count === allCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    window.openBulkCompleteModal = function(equipmentId) {
      const checkboxes = document.querySelectorAll('.maintenance-checkbox:checked');
      if (checkboxes.length === 0) {
        showToast('Please select at least one item', 'error');
        return;
      }

      // Store equipment ID for bulk completion
      document.getElementById('bulkCompleteForm').dataset.equipmentId = equipmentId;

      // Build list of selected items
      const itemsList = document.getElementById('bulkCompleteItemsList');
      let itemsHTML = '';
      checkboxes.forEach(cb => {
        const itemName = cb.dataset.itemName;
        const itemId = cb.dataset.itemId;
        itemsHTML += `<div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border);" data-item-id="${itemId}">‚úì ${itemName}</div>`;
      });
      itemsList.innerHTML = itemsHTML;

      // Set default date
      document.getElementById('bulkCompletionDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('bulkCompletionHours').value = '';
      document.getElementById('bulkCompletionNotes').value = '';

      document.getElementById('bulkCompleteModal').classList.add('active');
    }

    window.bulkCompleteMaintenance = async function(event) {
      event.preventDefault();

      const equipmentId = document.getElementById('bulkCompleteForm').dataset.equipmentId;
      const date = document.getElementById('bulkCompletionDate').value;
      const hoursValue = document.getElementById('bulkCompletionHours').value;
      const notes = document.getElementById('bulkCompletionNotes').value;

      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;

      // Get selected item IDs from the list
      const selectedItems = document.querySelectorAll('#bulkCompleteItemsList > div');
      const itemIds = Array.from(selectedItems).map(div => div.dataset.itemId);

      showLoading(`Completing ${itemIds.length} maintenance items...`);

      try {
        // Update each selected maintenance item
        itemIds.forEach(itemId => {
          const item = eq.maintenanceItems.find(m => m.id == itemId);
          if (item) {
            if (!item.history) item.history = [];

            const historyEntry = {
              date: date,
              notes: notes,
              completedAt: new Date().toISOString()
            };

            if (hoursValue) {
              historyEntry.hours = parseFloat(hoursValue);
              item.lastCompletedHours = parseFloat(hoursValue);
            }

            item.history.push(historyEntry);
            item.lastCompleted = date;
          }
        });

        const updateData = {
          maintenanceItems: eq.maintenanceItems
        };

        // Update hour meter if provided
        if (hoursValue) {
          updateData.hourMeter = parseFloat(hoursValue);
          eq.hourMeter = parseFloat(hoursValue);
        }

        await updateDoc(doc(db, 'equipment', equipmentId), updateData);

        await loadData(false);
        hideLoading();
        showToast(`${itemIds.length} maintenance items marked complete`);
        document.getElementById('bulkCompleteForm').reset();
        closeModal('bulkCompleteModal');
        viewEquipmentDetails(equipmentId);
      } catch (error) {
        console.error('Error completing bulk maintenance:', error);
        hideLoading();
        showToast('Error saving maintenance. Please try again.', 'error');
      }
    }

    window.deleteEquipment = async function(equipmentId) {
      if (!confirm('Are you sure you want to delete this equipment and all its maintenance records?')) {
        return;
      }

      showLoading('Deleting equipment...');

      try {
        await deleteDoc(doc(db, 'equipment', equipmentId));
        await loadData(false);
        hideLoading();
        showToast('Equipment deleted successfully');
      } catch (error) {
        console.error('Error deleting equipment:', error);
        hideLoading();
        showToast('Error deleting equipment. Please try again.', 'error');
      }
    }

    window.deleteTemplate = async function(templateId) {
      if (!confirm('Are you sure you want to delete this template?')) {
        return;
      }

      showLoading('Deleting template...');

      try {
        await deleteDoc(doc(db, 'maintenanceTemplates', templateId));
        await loadData(false);
        hideLoading();
        showToast('Template deleted successfully');
      } catch (error) {
        console.error('Error deleting template:', error);
        hideLoading();
        showToast('Error deleting template. Please try again.', 'error');
      }
    }
    
    // CHANGES 2 & 3: PRINT WITH SORTED ITEMS, STATUS COLUMN, AND NOTES SECTION
    window.printReport = function() {
      const eq = equipment.find(e => e.id === currentEquipmentId);
      if (!eq || !eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        alert('No maintenance items to print');
        return;
      }

      // SORT BY INTERVAL - SMALLEST TO LARGEST
      const sortedItems = [...eq.maintenanceItems].sort((a, b) => a.interval - b.interval);
      
      const logoSVG = '<svg width="120" height="68" viewBox="0 0 157 90" xmlns="http://www.w3.org/2000/svg"><g fill="#215530"><path d="M78.487013,73.5487013 C57.974026,73.5487013 38.6298701,69.9837662 24.0194805,63.4967532 C8.53246753,56.6006494 0,47.1331169 0,36.788961 C0,26.4155844 8.53246753,16.9480519 24.0194805,10.0519481 C38.6298701,3.56493506 57.974026,0 78.487013,0 C99,0 118.344156,3.56493506 132.954545,10.0519481 C148.441558,16.9480519 156.974026,26.4155844 156.974026,36.7597403 C156.974026,47.1038961 148.441558,56.6006494 132.954545,63.4675325 C118.373377,69.9837662 99.0292208,73.5487013 78.487013,73.5487013 Z M78.487013,6.8961039 C58.9090909,6.8961039 40.5584416,10.2564935 26.7954545,16.3636364 C14.1136364,22.0032468 6.86688312,29.4253247 6.86688312,36.788961 C6.86688312,44.1525974 14.1428571,51.5746753 26.7954545,57.2142857 C40.5292208,63.3214286 58.9090909,66.6818182 78.487013,66.6818182 C98.0649351,66.6818182 116.415584,63.3214286 130.178571,57.2142857 C142.86039,51.5746753 150.107143,44.1525974 150.107143,36.788961 C150.107143,29.4253247 142.831169,22.0032468 130.178571,16.3636364 C116.444805,10.2564935 98.0649351,6.8961039 78.487013,6.8961039 Z"/><polygon points="25.5681818 49.1785714 25.5681818 39.5357143 32.5227273 39.5357143 32.5227273 49.1785714 39.9155844 49.1785714 39.9155844 24.3116883 32.5227273 24.3116883 32.5227273 32.6980519 25.5681818 32.6980519 25.5681818 24.3116883 18.1753247 24.3116883 18.1753247 49.1785714"/><polygon points="58.8506494 49.1785714 58.8506494 43.3928571 48.7402597 43.3928571 48.7402597 39.4772727 58.0324675 39.4772727 58.0324675 33.6623377 48.7402597 33.6623377 48.7402597 30.0974026 58.4123377 30.0974026 58.4123377 24.3116883 41.3474026 24.3116883 41.3474026 49.1785714"/><polygon points="75.4188312 49.1785714 75.4188312 42.9545455 67.8798701 42.9545455 67.8798701 24.3116883 60.487013 24.3116883 60.487013 49.1785714"/><polygon points="94.1201299 49.1785714 94.1201299 43.3928571 84.0097403 43.3928571 84.0097403 39.4772727 93.3019481 39.4772727 93.3019481 33.6623377 84.0097403 33.6623377 84.0097403 30.0974026 93.6818182 30.0974026 93.6818182 24.3116883 76.6168831 24.3116883 76.6168831 49.1785714"/><polygon points="104.172078 24.3116883 95.5519481 24.3116883 95.5519481 49.1785714 102.623377 49.1785714 102.623377 41.3181818 102.331169 35.6493506 108.642857 49.1785714 117.262987 49.1785714 117.262987 24.3116883 110.220779 24.3116883 110.220779 32.2305195 110.483766 37.8993506"/><polygon points="121.87987 37.8409091 132.691558 37.8409091 132.691558 43.9188312 121.87987 43.9188312"/><polygon points="122.931818 24.5746753 132.662338 24.5746753 139.587662 49.1785714 133.042208 49.1785714 127.811688 30.1558442 122.727273 49.1785714 115.275974 49.1785714"/></g></svg>';
      
      let printHTML = '<html><head><title>Maintenance Report</title>';
      printHTML += '<style>';
      printHTML += 'body{font-family:Arial,sans-serif;padding:15px;font-size:11px;} ';
      printHTML += 'h1{color:#215530;font-size:18px;margin:0 0 5px;text-transform:uppercase;} ';
      printHTML += 'h2{color:#215530;font-size:14px;margin:15px 0 8px;border-bottom:2px solid #215530;padding-bottom:4px;} ';
      printHTML += '.header{display:flex;align-items:center;gap:15px;margin-bottom:15px;border-bottom:2px solid #215530;padding-bottom:10px;} ';
      printHTML += '.info{background:#f8f9fa;padding:8px;margin:0 0 10px;border-left:3px solid #215530;font-size:10px;} ';
      printHTML += '.info p{margin:2px 0;} ';
      printHTML += 'table{width:100%;border-collapse:collapse;font-size:10px;} ';
      printHTML += 'th{background:#215530;color:white;padding:6px 8px;text-align:left;font-size:10px;} ';
      printHTML += 'td{padding:6px 8px;border-bottom:1px solid #ddd;vertical-align:top;} ';
      printHTML += 'tr:nth-child(even) td{background:#f8f9fa;} ';
      printHTML += '.desc{font-size:9px;color:#666;margin-top:2px;} ';
      printHTML += '.notes-section{border:1px solid #ddd;padding:10px;margin-top:15px;min-height:100px;} ';
      printHTML += '.notes-title{font-weight:700;margin-bottom:5px;color:#215530;} ';
      printHTML += '.sign{border-top:1px solid #215530;margin-top:15px;padding-top:8px;font-size:10px;} ';
      printHTML += '@page{margin:0.5in;}';
      printHTML += '</style></head><body>';
      
      printHTML += '<div class="header">' + logoSVG;
      printHTML += '<div><h1>Preventive Maintenance Report</h1>';
      printHTML += '<div style="font-size:10px;color:#666;">Helena Agri-Enterprises</div></div></div>';
      
      printHTML += '<div class="info">';
      printHTML += '<p><b>Equipment ID:</b> ' + eq.equipmentId + ' &nbsp;&nbsp; <b>Name:</b> ' + eq.name + '</p>';
      printHTML += '<p><b>Type:</b> ' + eq.type + ' &nbsp;&nbsp; <b>Location:</b> ' + (eq.location || 'N/A') + ' &nbsp;&nbsp; <b>Date:</b> ' + new Date().toLocaleDateString() + '</p>';
      printHTML += '</div>';
      
      printHTML += '<h2>Maintenance Schedule</h2>';
      printHTML += '<table><tr><th>Item</th><th>Interval</th><th>Last Completed</th><th>Status</th><th>Instructions</th><th>‚úì</th></tr>';
      
      sortedItems.forEach(item => {
        const { statusText } = getMaintenanceStatus(item);
        const last = item.lastCompleted ? new Date(item.lastCompleted).toLocaleDateString() : 'Never';
        printHTML += '<tr>';
        printHTML += '<td><b>' + item.name + '</b></td>';
        printHTML += '<td>' + item.interval + ' days</td>';
        printHTML += '<td>' + last + '</td>';
        printHTML += '<td><b>' + statusText + '</b></td>';
        printHTML += '<td style="font-size:9px;">' + (item.description ? item.description.substring(0,60) + (item.description.length > 60 ? '...' : '') : '') + '</td>';
        printHTML += '<td style="width:40px;">‚òê</td>';
        printHTML += '</tr>';
      });
      
      printHTML += '</table>';
      
      // NOTES SECTION
      printHTML += '<div class="notes-section">';
      printHTML += '<div class="notes-title">Issues Found During Inspection:</div>';
      printHTML += '<div style="line-height:1.8;">_________________________________________________________________</div>';
      printHTML += '<div style="line-height:1.8;">_________________________________________________________________</div>';
      printHTML += '<div style="line-height:1.8;">_________________________________________________________________</div>';
      printHTML += '<div style="line-height:1.8;">_________________________________________________________________</div>';
      printHTML += '</div>';
      
      printHTML += '<div class="sign">';
      printHTML += '<table style="border:none;"><tr><td style="border:none;width:50%;"><b>Employee Signature:</b> ____________________________________</td>';
      printHTML += '<td style="border:none;width:50%;"><b>Date:</b> _________________________________</td></tr></table>';
      printHTML += '</div>';
      
      printHTML += '</body></html>';
      
      const win = window.open('', '_blank');
      win.document.write(printHTML);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 250);
    }
    
    // CALENDAR FUNCTIONS
    window.setCalendarView = function(view) {
      calendarViewMode = view;
      document.getElementById('weekViewBtn').classList.toggle('active', view === 'week');
      document.getElementById('monthViewBtn').classList.toggle('active', view === 'month');

      if (view === 'week') {
        // Set week start to current month's first day's week if switching
        currentWeekStart = getWeekStart(new Date(currentYear, currentMonth, 1));
      }
      renderScheduleCalendar();
    }

    window.renderScheduleCalendar = function() {
      if (calendarViewMode === 'week') {
        renderWeekView();
      } else {
        renderMonthView();
      }
    }

    function renderMonthView() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

      document.getElementById('calendarMonth').textContent = `${monthNames[currentMonth]} ${currentYear}`;
      document.getElementById('calendar').classList.remove('week-view');

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const daysInPrevMonth = new Date(currentYear, currentMonth, 0).getDate();

      const filterEquipment = document.getElementById('scheduleEquipmentFilter').value;

      let calendarHTML = '';

      // Day headers
      daysOfWeek.forEach(day => {
        calendarHTML += `<div class="calendar-day-header">${day}</div>`;
      });

      const today = new Date();
      const isCurrentMonth = today.getMonth() === currentMonth && today.getFullYear() === currentYear;

      // Previous month days
      for (let i = firstDay - 1; i >= 0; i--) {
        calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${daysInPrevMonth - i}</div></div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        let daySchedules = schedules.filter(s => s.date === dateStr);

        if (filterEquipment) {
          daySchedules = daySchedules.filter(s => s.equipmentId === filterEquipment);
        }

        const isToday = isCurrentMonth && day === today.getDate();
        const hasSchedule = daySchedules.length > 0;

        // Get weather for this date
        const weather = getWeatherForDate(dateStr);

        calendarHTML += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasSchedule ? 'has-schedule' : ''} ${weather && weather.isWindy ? 'windy-day' : ''}" onclick="openScheduleModal('${dateStr}')">`;
        calendarHTML += `<div class="calendar-day-number" style="display: flex; justify-content: space-between; align-items: center;">`;
        calendarHTML += `<span>${day}</span>`;
        if (weather) {
          let weatherTitle = `${weather.high}¬∞/${weather.low}¬∞ - ${weather.precipitation}% rain\nWind: ${weather.windDir} ${weather.windSpeed} mph`;
          if (weather.windGust > weather.windSpeed + 5) {
            weatherTitle += `, gusts ${weather.windGust} mph`;
          }
          calendarHTML += `<span style="font-size: 0.7rem;" title="${weatherTitle}">${weather.icon}${weather.isWindy ? 'üí®' : ''}</span>`;
        }
        calendarHTML += `</div>`;
        if (weather) {
          calendarHTML += `<div style="font-size: 0.55rem; color: var(--text-secondary); text-align: center;">${weather.high}¬∞/${weather.low}¬∞</div>`;
          // Show wind info
          let windInfo = `${weather.windDir} ${weather.windSpeed}`;
          if (weather.windGust > weather.windSpeed + 5) {
            windInfo += `/${weather.windGust}`;
          }
          windInfo += ' mph';
          calendarHTML += `<div style="font-size: 0.5rem; color: ${weather.isWindy ? 'var(--danger)' : 'var(--text-secondary)'}; text-align: center;">${weather.isWindy ? 'üí®' : ''}${windInfo}</div>`;
        }
        if (daySchedules.length > 0) {
          calendarHTML += '<div class="calendar-events">';
          daySchedules.slice(0, 2).forEach(s => {
            const eq = equipment.find(e => e.id === s.equipmentId);
            if (eq) {
              calendarHTML += `<div class="calendar-event">${eq.equipmentId}</div>`;
            }
          });
          if (daySchedules.length > 2) {
            calendarHTML += `<div class="calendar-event">+${daySchedules.length - 2} more</div>`;
          }
          calendarHTML += '</div>';
        }
        calendarHTML += '</div>';
      }

      // Next month days
      const remainingDays = 42 - (firstDay + daysInMonth);
      for (let day = 1; day <= remainingDays; day++) {
        calendarHTML += `<div class="calendar-day other-month"><div class="calendar-day-number">${day}</div></div>`;
      }

      document.getElementById('calendar').innerHTML = calendarHTML;
      renderSchedule();
    }

    function renderWeekView() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      // Format title: "Jan 5 - Jan 11, 2025" or "Jan 28 - Feb 3, 2025"
      const startMonth = monthNames[currentWeekStart.getMonth()].substring(0, 3);
      const endMonth = monthNames[weekEnd.getMonth()].substring(0, 3);
      let titleText = `${startMonth} ${currentWeekStart.getDate()}`;
      if (startMonth !== endMonth) {
        titleText += ` - ${endMonth} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;
      } else {
        titleText += ` - ${weekEnd.getDate()}, ${currentWeekStart.getFullYear()}`;
      }

      document.getElementById('calendarMonth').textContent = titleText;
      document.getElementById('calendar').classList.add('week-view');

      const filterEquipment = document.getElementById('scheduleEquipmentFilter').value;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let calendarHTML = '';

      // Day headers with dates
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        calendarHTML += `<div class="calendar-day-header">${daysOfWeek[i].substring(0, 3)} ${date.getDate()}</div>`;
      }

      // Week days
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        let daySchedules = schedules.filter(s => s.date === dateStr);
        if (filterEquipment) {
          daySchedules = daySchedules.filter(s => s.equipmentId === filterEquipment);
        }

        const isToday = date.getTime() === today.getTime();
        const hasSchedule = daySchedules.length > 0;
        const weather = getWeatherForDate(dateStr);

        calendarHTML += `<div class="calendar-day ${isToday ? 'today' : ''} ${hasSchedule ? 'has-schedule' : ''} ${weather && weather.isWindy ? 'windy-day' : ''}" onclick="openScheduleModal('${dateStr}')">`;

        // Weather section
        if (weather) {
          calendarHTML += `<div style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 0.5rem;">`;
          calendarHTML += `<span style="font-size: 1.2rem;">${weather.icon}</span><br>`;
          calendarHTML += `${weather.high}¬∞/${weather.low}¬∞`;
          let windInfo = ` ‚Ä¢ ${weather.windDir} ${weather.windSpeed}`;
          if (weather.windGust > weather.windSpeed + 5) {
            windInfo += `/${weather.windGust}`;
          }
          windInfo += ' mph';
          calendarHTML += `<br><span style="color: ${weather.isWindy ? 'var(--danger)' : 'inherit'}">${weather.isWindy ? 'üí®' : ''}${windInfo}</span>`;
          calendarHTML += `</div>`;
        }

        // Scheduled items - show all in week view
        if (daySchedules.length > 0) {
          calendarHTML += '<div class="calendar-events" style="max-height: none;">';
          daySchedules.forEach(s => {
            const eq = equipment.find(e => e.id === s.equipmentId);
            if (eq) {
              calendarHTML += `<div class="calendar-event" style="white-space: normal;">${eq.equipmentId} - ${eq.name}</div>`;
            }
          });
          calendarHTML += '</div>';
        } else {
          calendarHTML += `<div style="color: var(--text-secondary); font-size: 0.75rem; text-align: center; margin-top: 0.5rem;">No scheduled maintenance</div>`;
        }

        calendarHTML += '</div>';
      }

      document.getElementById('calendar').innerHTML = calendarHTML;
      renderSchedule();
    }

    window.previousPeriod = function() {
      if (calendarViewMode === 'week') {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      } else {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
      }
      renderScheduleCalendar();
    }

    window.nextPeriod = function() {
      if (calendarViewMode === 'week') {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      } else {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
      }
      renderScheduleCalendar();
    }

    window.goToToday = function() {
      const today = new Date();
      currentMonth = today.getMonth();
      currentYear = today.getFullYear();
      currentWeekStart = getWeekStart(today);
      renderScheduleCalendar();
    }
    
    window.openScheduleModal = function(dateStr) {
      document.getElementById('scheduleDate').value = dateStr;
      document.getElementById('scheduleMaintenanceModal').classList.add('active');
    }
    
    window.scheduleMaintenance = async function(event) {
      event.preventDefault();

      const newSchedule = {
        equipmentId: document.getElementById('scheduleEquipment').value,
        date: document.getElementById('scheduleDate').value,
        notes: document.getElementById('scheduleNotes').value,
        createdAt: new Date().toISOString()
      };

      showLoading('Scheduling maintenance...');

      try {
        await addDoc(collection(db, 'schedules'), newSchedule);
        await loadData(false);
        hideLoading();
        showToast('Maintenance scheduled successfully');
        document.getElementById('scheduleMaintenanceForm').reset();
        closeModal('scheduleMaintenanceModal');
        renderScheduleCalendar();
      } catch (error) {
        console.error('Error scheduling maintenance:', error);
        hideLoading();
        showToast('Error scheduling maintenance. Please try again.', 'error');
      }
    }
    
    window.openEditScheduleModal = function(scheduleId) {
      const schedule = schedules.find(s => s.id === scheduleId);
      if (!schedule) return;
      
      document.getElementById('editScheduleId').value = scheduleId;
      document.getElementById('editScheduleEquipment').value = schedule.equipmentId;
      document.getElementById('editScheduleDate').value = schedule.date;
      document.getElementById('editScheduleNotes').value = schedule.notes || '';
      
      document.getElementById('editScheduleModal').classList.add('active');
    }
    
    window.updateSchedule = async function(event) {
      event.preventDefault();

      const scheduleId = document.getElementById('editScheduleId').value;

      const updatedSchedule = {
        equipmentId: document.getElementById('editScheduleEquipment').value,
        date: document.getElementById('editScheduleDate').value,
        notes: document.getElementById('editScheduleNotes').value
      };

      showLoading('Updating schedule...');

      try {
        await updateDoc(doc(db, 'schedules', scheduleId), updatedSchedule);
        await loadData(false);
        hideLoading();
        showToast('Schedule updated successfully');
        document.getElementById('editScheduleForm').reset();
        closeModal('editScheduleModal');
        renderScheduleCalendar();
      } catch (error) {
        console.error('Error updating schedule:', error);
        hideLoading();
        showToast('Error updating schedule. Please try again.', 'error');
      }
    }

    window.deleteSchedule = async function(scheduleId) {
      if (!confirm('Delete this scheduled maintenance?')) return;

      showLoading('Deleting schedule...');

      try {
        await deleteDoc(doc(db, 'schedules', scheduleId));
        await loadData(false);
        hideLoading();
        showToast('Schedule deleted successfully');
        renderScheduleCalendar();
      } catch (error) {
        console.error('Error deleting schedule:', error);
        hideLoading();
        showToast('Error deleting schedule. Please try again.', 'error');
      }
    }
    
    function renderSchedule() {
      const container = document.getElementById('scheduleView');
      
      // Show actual scheduled maintenance from schedules collection
      const sortedSchedules = [...schedules].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      if (sortedSchedules.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üìÖ</div><h3>No Scheduled Maintenance</h3></div>';
        return;
      }
      
      container.innerHTML = '<h3 style="font-family: \'Roboto Condensed\', sans-serif; color: var(--helena-green); margin-bottom: 1rem;">Upcoming Scheduled Maintenance</h3><div class="maintenance-list">' + sortedSchedules.map(schedule => {
        const eq = equipment.find(e => e.id === schedule.equipmentId);
        const scheduleDate = new Date(schedule.date);
        const today = new Date();
        today.setHours(0,0,0,0);
        scheduleDate.setHours(0,0,0,0);
        const daysUntil = Math.ceil((scheduleDate - today) / (1000 * 60 * 60 * 24));
        
        let statusClass = 'status-good';
        let statusText = '';
        
        if (daysUntil < 0) {
          statusClass = 'status-danger';
          statusText = `${Math.abs(daysUntil)} days overdue`;
        } else if (daysUntil === 0) {
          statusClass = 'status-warning';
          statusText = 'Due today';
        } else if (daysUntil <= 7) {
          statusClass = 'status-warning';
          statusText = `Due in ${daysUntil} day${daysUntil > 1 ? 's' : ''}`;
        } else {
          statusText = `Due in ${daysUntil} days`;
        }
        
        return `
          <div class="maintenance-item">
            <div class="maintenance-header">
              <div>
                <div class="equipment-id">${eq ? eq.equipmentId : 'Unknown'}</div>
                <div class="maintenance-title">Scheduled Maintenance</div>
                <div class="equipment-type">${eq ? `${eq.name} - ${eq.type}` : 'Unknown Equipment'}</div>
              </div>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            <div class="maintenance-status">
              <strong>Date:</strong> ${new Date(schedule.date).toLocaleDateString()}<br>
              ${schedule.notes ? '<strong>Notes:</strong> ' + schedule.notes : ''}
            </div>
            <div class="equipment-actions" style="margin-top: 1rem;">
              <button class="btn btn-small" onclick="window.openEditScheduleModal('${schedule.id}')">Edit</button>
              <button class="btn btn-small" onclick="window.deleteSchedule('${schedule.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('') + '</div>';
    }
    
    // ISSUES FUNCTIONS
    window.openAddIssueModal = function() {
      // Reset photo state
      currentIssuePhotos = [];
      document.getElementById('issuePhotoPreviews').innerHTML = '';
      document.getElementById('issuePhotoPlaceholder').textContent = 'üì∑ Click to add photos';
      document.getElementById('issuePhotoArea').classList.remove('has-photo');
      document.getElementById('addIssueForm').reset();
      document.getElementById('addIssueModal').classList.add('active');
    }

    // Quick log issue from equipment card
    window.quickLogIssue = function(equipmentId) {
      // Reset photo state
      currentIssuePhotos = [];
      document.getElementById('issuePhotoPreviews').innerHTML = '';
      document.getElementById('issuePhotoPlaceholder').textContent = 'üì∑ Click to add photos';
      document.getElementById('issuePhotoArea').classList.remove('has-photo');
      document.getElementById('addIssueForm').reset();
      document.getElementById('issueEquipment').value = equipmentId;
      document.getElementById('addIssueModal').classList.add('active');
    }

    window.addIssue = async function(event) {
      event.preventDefault();

      const costValue = document.getElementById('issueCost').value;

      const newIssue = {
        equipmentId: document.getElementById('issueEquipment').value,
        title: document.getElementById('issueTitle').value,
        severity: document.getElementById('issueSeverity').value,
        cost: costValue ? parseFloat(costValue) : null,
        notes: document.getElementById('issueNotes').value,
        photos: currentIssuePhotos.length > 0 ? currentIssuePhotos : [],
        status: 'Pending',
        createdAt: new Date().toISOString(),
        completedAt: null
      };

      showLoading('Logging issue...');

      try {
        await addDoc(collection(db, 'issues'), newIssue);
        await loadData(false);
        hideLoading();
        showToast('Issue logged successfully');
        // Reset photo state
        currentIssuePhotos = [];
        document.getElementById('issuePhotoPreviews').innerHTML = '';
        document.getElementById('issuePhotoPlaceholder').style.display = 'block';
        document.getElementById('issuePhotoArea').classList.remove('has-photo');
        document.getElementById('addIssueForm').reset();
        closeModal('addIssueModal');
        renderIssues();
      } catch (error) {
        console.error('Error adding issue:', error);
        hideLoading();
        showToast('Error adding issue. Please try again.', 'error');
      }
    }
    
    // Helper function to render issue photos (supports both old 'photo' and new 'photos' fields)
    function renderIssuePhotosHTML(issue) {
      let photos = [];
      if (issue.photos && issue.photos.length > 0) {
        photos = issue.photos;
      } else if (issue.photo) {
        photos = [issue.photo];
      }

      if (photos.length === 0) return '';

      if (photos.length === 1) {
        return `<img src="${photos[0]}" class="issue-photo" onclick="window.viewPhoto('${photos[0]}')" alt="Issue photo">`;
      }

      return `<div class="issue-photos-gallery">${photos.map(photo =>
        `<img src="${photo}" onclick="window.viewPhoto('${photo}')" alt="Issue photo">`
      ).join('')}</div>`;
    }

    window.renderIssues = function() {
      const container = document.getElementById('issuesList');
      const filterEquipment = document.getElementById('issuesEquipmentFilter').value;
      const showCompleted = document.getElementById('showCompletedIssues').checked;
      
      let filteredIssues = issues.filter(i => {
        const matchesEquipment = !filterEquipment || i.equipmentId === filterEquipment;
        const matchesStatus = showCompleted || i.status === 'Pending';
        return matchesEquipment && matchesStatus;
      });
      
      // Sort: Critical first, then by created date (newest first)
      filteredIssues.sort((a, b) => {
        // Default to Minor if severity doesn't exist
        const aSeverity = a.severity || 'Minor';
        const bSeverity = b.severity || 'Minor';
        
        // Critical issues always come first
        if (aSeverity === 'Critical' && bSeverity !== 'Critical') return -1;
        if (aSeverity !== 'Critical' && bSeverity === 'Critical') return 1;
        // Then sort by date
        return new Date(b.createdAt) - new Date(a.createdAt);
      });
      
      if (filteredIssues.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <h3>No Issues Found</h3>
            <p>All equipment is running smoothly!</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredIssues.map(issue => {
        const eq = equipment.find(e => e.id === issue.equipmentId);
        const isCompleted = issue.status === 'Completed';
        const severity = issue.severity || 'Minor'; // Default to Minor if not set
        const isCritical = severity === 'Critical';
        
        return `
          <div class="issue-card ${isCompleted ? 'completed' : ''} ${isCritical ? 'critical' : ''}">
            <div class="issue-header">
              <div>
                <div class="issue-equipment">${eq ? `${eq.equipmentId} - ${eq.name}` : 'Unknown'}</div>
                <div class="issue-title">
                  ${issue.title}
                  <span class="severity-badge severity-${severity.toLowerCase()}">${severity}</span>
                </div>
              </div>
              <span class="status-badge ${isCompleted ? 'status-good' : 'status-warning'}">${issue.status}</span>
            </div>
            <div class="issue-notes">${issue.notes}</div>
            ${renderIssuePhotosHTML(issue)}
            <div class="issue-meta">
              <span><strong>Reported:</strong> ${new Date(issue.createdAt).toLocaleDateString()}</span>
              ${issue.cost ? `<span><strong>Estimated Cost:</strong> $${parseFloat(issue.cost).toFixed(2)}</span>` : ''}
              ${isCompleted ? `<span><strong>Completed:</strong> ${new Date(issue.completedAt).toLocaleDateString()}</span>` : ''}
            </div>
            <div class="issue-actions">
              ${!isCompleted ? `<button class="btn btn-small" onclick="window.openEditIssueModal('${issue.id}')">Edit</button>` : ''}
              ${!isCompleted ? `<button class="btn btn-small btn-primary" onclick="window.completeIssue('${issue.id}')">Mark Complete</button>` : ''}
              <button class="btn btn-small" onclick="window.deleteIssue('${issue.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    window.completeIssue = async function(issueId) {
      showLoading('Completing issue...');

      try {
        await updateDoc(doc(db, 'issues', issueId), {
          status: 'Completed',
          completedAt: new Date().toISOString()
        });

        await loadData(false);
        hideLoading();
        showToast('Issue marked as complete');
        renderIssues();
      } catch (error) {
        console.error('Error completing issue:', error);
        hideLoading();
        showToast('Error completing issue. Please try again.', 'error');
      }
    }
    
    // Edit issue photo handling - multiple photos
    window.previewEditIssuePhotos = async function(input) {
      if (input.files && input.files.length > 0) {
        document.getElementById('editIssuePhotoPlaceholder').textContent = 'üì∑ Processing photos...';

        for (const file of Array.from(input.files)) {
          try {
            const compressedPhoto = await compressImage(file);
            editIssueNewPhotos.push(compressedPhoto);
            renderEditIssueNewPhotos();
          } catch (error) {
            console.error('Error processing photo:', error);
            showToast('Error processing photo', 'error');
          }
        }

        input.value = ''; // Reset input to allow selecting same files again
        document.getElementById('editIssuePhotoPlaceholder').textContent = 'üì∑ Click to add more photos';
      }
    }

    function renderEditIssueExistingPhotos() {
      const container = document.getElementById('editIssueCurrentPhotos');
      if (editIssueExistingPhotos.length === 0) {
        container.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.85rem;">No existing photos</span>';
        return;
      }
      container.innerHTML = editIssueExistingPhotos.map((photo, index) => `
        <div class="photo-preview-item">
          <img src="${photo}" onclick="window.viewPhoto('${photo}')" title="Click to view">
          <button type="button" class="remove-photo" onclick="window.removeEditIssueExistingPhoto(${index})" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    function renderEditIssueNewPhotos() {
      const container = document.getElementById('editIssueNewPhotos');
      if (editIssueNewPhotos.length === 0) {
        container.innerHTML = '';
        return;
      }
      container.innerHTML = '<div style="font-size: 0.85rem; color: var(--text-secondary); width: 100%; margin-bottom: 0.25rem;">New photos to add:</div>' +
        editIssueNewPhotos.map((photo, index) => `
        <div class="photo-preview-item">
          <img src="${photo}" onclick="window.viewPhoto('${photo}')" title="Click to view">
          <button type="button" class="remove-photo" onclick="window.removeEditIssueNewPhoto(${index})" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    window.removeEditIssueExistingPhoto = function(index) {
      editIssueExistingPhotos.splice(index, 1);
      renderEditIssueExistingPhotos();
    }

    window.removeEditIssueNewPhoto = function(index) {
      editIssueNewPhotos.splice(index, 1);
      renderEditIssueNewPhotos();
    }

    window.openEditIssueModal = function(issueId) {
      const issue = issues.find(i => i.id === issueId);
      if (!issue) return;

      // Reset photo state
      editIssueExistingPhotos = [];
      editIssueNewPhotos = [];

      // Load existing photos (support both old 'photo' field and new 'photos' array)
      if (issue.photos && issue.photos.length > 0) {
        editIssueExistingPhotos = [...issue.photos];
      } else if (issue.photo) {
        // Backwards compatibility with single photo
        editIssueExistingPhotos = [issue.photo];
      }

      document.getElementById('editIssueId').value = issueId;
      document.getElementById('editIssueEquipment').value = issue.equipmentId;
      document.getElementById('editIssueTitle').value = issue.title;
      document.getElementById('editIssueSeverity').value = issue.severity || 'Minor';
      document.getElementById('editIssueReportedDate').value = issue.createdAt ? issue.createdAt.split('T')[0] : new Date().toISOString().split('T')[0];
      document.getElementById('editIssueCost').value = issue.cost || '';
      document.getElementById('editIssueNotes').value = issue.notes;

      // Render existing photos
      renderEditIssueExistingPhotos();
      renderEditIssueNewPhotos();

      document.getElementById('editIssueModal').classList.add('active');
    }

    window.updateIssue = async function(event) {
      event.preventDefault();

      const issueId = document.getElementById('editIssueId').value;
      const reportedDate = document.getElementById('editIssueReportedDate').value;
      const costValue = document.getElementById('editIssueCost').value;

      // Combine existing and new photos
      const allPhotos = [...editIssueExistingPhotos, ...editIssueNewPhotos];

      const updatedIssue = {
        equipmentId: document.getElementById('editIssueEquipment').value,
        title: document.getElementById('editIssueTitle').value,
        severity: document.getElementById('editIssueSeverity').value,
        cost: costValue ? parseFloat(costValue) : null,
        notes: document.getElementById('editIssueNotes').value,
        createdAt: new Date(reportedDate).toISOString(),
        photos: allPhotos
      };

      showLoading('Updating issue...');

      try {
        await updateDoc(doc(db, 'issues', issueId), updatedIssue);
        await loadData(false);
        hideLoading();
        showToast('Issue updated successfully');
        document.getElementById('editIssueForm').reset();
        closeModal('editIssueModal');
        renderIssues();
      } catch (error) {
        console.error('Error updating issue:', error);
        hideLoading();
        showToast('Error updating issue. Please try again.', 'error');
      }
    }
    
    window.deleteIssue = async function(issueId) {
      if (!confirm('Delete this issue?')) return;

      showLoading('Deleting issue...');

      try {
        await deleteDoc(doc(db, 'issues', issueId));
        await loadData(false);
        hideLoading();
        showToast('Issue deleted successfully');
        renderIssues();
      } catch (error) {
        console.error('Error deleting issue:', error);
        hideLoading();
        showToast('Error deleting issue. Please try again.', 'error');
      }
    }
    
    // MAINTENANCE ITEM MANAGEMENT FUNCTIONS
    window.openAddMaintenanceItemModal = function() {
      if (!currentEquipmentId) {
        alert('Please select equipment first');
        return;
      }
      document.getElementById('addMaintenanceItemModal').classList.add('active');
    }
    
    window.addMaintenanceItem = async function(event) {
      event.preventDefault();

      if (!currentEquipmentId) {
        showToast('No equipment selected', 'error');
        return;
      }

      const eq = equipment.find(e => e.id === currentEquipmentId);
      if (!eq) {
        showToast('Equipment not found', 'error');
        return;
      }

      const dayInterval = document.getElementById('maintenanceItemInterval').value;
      const hourInterval = document.getElementById('maintenanceItemHourInterval').value;

      if (!dayInterval && !hourInterval) {
        showToast('Please enter at least a day interval or hour interval', 'warning');
        return;
      }

      const newItem = {
        id: Date.now() + Math.random(),
        name: document.getElementById('maintenanceItemName').value,
        interval: dayInterval ? parseInt(dayInterval) : null,
        hourInterval: hourInterval ? parseInt(hourInterval) : null,
        description: document.getElementById('maintenanceItemDescription').value,
        lastCompleted: null,
        lastCompletedHours: null,
        history: []
      };

      if (!eq.maintenanceItems) {
        eq.maintenanceItems = [];
      }

      eq.maintenanceItems.push(newItem);

      showLoading('Adding maintenance item...');

      try {
        await updateDoc(doc(db, 'equipment', currentEquipmentId), {
          maintenanceItems: eq.maintenanceItems
        });

        await loadData(false);
        hideLoading();
        showToast('Maintenance item added successfully');
        document.getElementById('addMaintenanceItemForm').reset();
        closeModal('addMaintenanceItemModal');
        viewEquipmentDetails(currentEquipmentId);
      } catch (error) {
        console.error('Error adding maintenance item:', error);
        hideLoading();
        showToast('Error adding maintenance item. Please try again.', 'error');
      }
    }
    
    window.deleteMaintenanceItem = async function(equipmentId, itemId) {
      if (!confirm('Are you sure you want to delete this maintenance item?')) return;

      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) {
        showToast('Equipment not found', 'error');
        return;
      }

      showLoading('Deleting maintenance item...');
      eq.maintenanceItems = eq.maintenanceItems.filter(item => item.id != itemId);

      try {
        await updateDoc(doc(db, 'equipment', equipmentId), {
          maintenanceItems: eq.maintenanceItems
        });

        await loadData(false);
        hideLoading();
        showToast('Maintenance item deleted successfully');
        viewEquipmentDetails(equipmentId);
      } catch (error) {
        console.error('Error deleting maintenance item:', error);
        hideLoading();
        showToast('Error deleting maintenance item. Please try again.', 'error');
      }
    }

    // Edit maintenance item functions
    window.openEditMaintenanceItemModal = function(equipmentId, itemId) {
      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;

      const item = eq.maintenanceItems.find(m => m.id == itemId);
      if (!item) return;

      document.getElementById('editMaintenanceItemId').value = itemId;
      document.getElementById('editMaintenanceItemName').value = item.name;
      document.getElementById('editMaintenanceItemInterval').value = item.interval || '';
      document.getElementById('editMaintenanceItemHourInterval').value = item.hourInterval || '';
      document.getElementById('editMaintenanceItemDescription').value = item.description || '';

      document.getElementById('editMaintenanceItemModal').classList.add('active');
    }

    window.updateMaintenanceItem = async function(event) {
      event.preventDefault();

      if (!currentEquipmentId) {
        showToast('No equipment selected', 'error');
        return;
      }

      const eq = equipment.find(e => e.id === currentEquipmentId);
      if (!eq) {
        showToast('Equipment not found', 'error');
        return;
      }

      const itemId = document.getElementById('editMaintenanceItemId').value;
      const item = eq.maintenanceItems.find(m => m.id == itemId);
      if (!item) {
        showToast('Maintenance item not found', 'error');
        return;
      }

      showLoading('Updating maintenance item...');

      const dayInterval = document.getElementById('editMaintenanceItemInterval').value;
      const hourInterval = document.getElementById('editMaintenanceItemHourInterval').value;

      if (!dayInterval && !hourInterval) {
        hideLoading();
        showToast('Please enter at least a day interval or hour interval', 'warning');
        return;
      }

      item.name = document.getElementById('editMaintenanceItemName').value;
      item.interval = dayInterval ? parseInt(dayInterval) : null;
      item.hourInterval = hourInterval ? parseInt(hourInterval) : null;
      item.description = document.getElementById('editMaintenanceItemDescription').value;

      try {
        await updateDoc(doc(db, 'equipment', currentEquipmentId), {
          maintenanceItems: eq.maintenanceItems
        });

        await loadData(false);
        hideLoading();
        showToast('Maintenance item updated successfully');
        document.getElementById('editMaintenanceItemForm').reset();
        closeModal('editMaintenanceItemModal');
        viewEquipmentDetails(currentEquipmentId);
      } catch (error) {
        console.error('Error updating maintenance item:', error);
        hideLoading();
        showToast('Error updating maintenance item. Please try again.', 'error');
      }
    }
    
    // EDIT EQUIPMENT FUNCTIONS
    window.openEditEquipmentModal = function(equipmentId) {
      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;
      
      document.getElementById('editEquipmentDbId').value = equipmentId;
      document.getElementById('editEquipmentId').value = eq.equipmentId;
      document.getElementById('editEquipmentName').value = eq.name;
      document.getElementById('editEquipmentSNVIN').value = eq.snvin || '';
      document.getElementById('editEquipmentLocation').value = eq.location || '';
      document.getElementById('editEquipmentHourMeter').value = eq.hourMeter || '';

      document.getElementById('editEquipmentModal').classList.add('active');
    }
    
    window.updateEquipment = async function(event) {
      event.preventDefault();

      const equipmentDbId = document.getElementById('editEquipmentDbId').value;
      const newEquipmentId = document.getElementById('editEquipmentId').value.trim();

      // Check for duplicate Equipment ID (excluding current equipment)
      const existingEquipment = equipment.find(eq =>
        eq.equipmentId.toLowerCase() === newEquipmentId.toLowerCase() && eq.id !== equipmentDbId
      );
      if (existingEquipment) {
        showToast(`Equipment ID "${newEquipmentId}" already exists. Please use a unique ID.`, 'error');
        return;
      }

      const hourMeterValue = document.getElementById('editEquipmentHourMeter').value;

      const updatedEquipment = {
        equipmentId: newEquipmentId,
        name: document.getElementById('editEquipmentName').value,
        snvin: document.getElementById('editEquipmentSNVIN').value,
        location: document.getElementById('editEquipmentLocation').value,
        hourMeter: hourMeterValue ? parseFloat(hourMeterValue) : null
      };

      showLoading('Updating equipment...');

      try {
        await updateDoc(doc(db, 'equipment', equipmentDbId), updatedEquipment);
        await loadData(false);
        hideLoading();
        showToast('Equipment updated successfully');
        document.getElementById('editEquipmentForm').reset();
        closeModal('editEquipmentModal');
      } catch (error) {
        console.error('Error updating equipment:', error);
        hideLoading();
        showToast('Error updating equipment. Please try again.', 'error');
      }
    }
    
    // DASHBOARD FUNCTIONS
    function renderDashboard() {
      // Calculate stats
      let overdueCount = 0;
      let upToDateCount = 0;
      let dueThisWeekItems = [];

      equipment.forEach(eq => {
        let hasOverdue = false;
        if (eq.maintenanceItems) {
          eq.maintenanceItems.forEach(item => {
            const maintenanceStatus = getMaintenanceStatus(item, eq);
            if (maintenanceStatus.status === 'danger') {
              hasOverdue = true;
              dueThisWeekItems.push({ equipment: eq, item: item, ...maintenanceStatus });
            } else if (maintenanceStatus.daysUntil <= 7 && maintenanceStatus.daysUntil > 0) {
              dueThisWeekItems.push({ equipment: eq, item: item, ...maintenanceStatus });
            }
          });
        }
        if (hasOverdue) {
          overdueCount++;
        } else {
          upToDateCount++;
        }
      });

      // Sort by urgency
      dueThisWeekItems.sort((a, b) => a.daysUntil - b.daysUntil);

      const criticalIssues = issues.filter(i => i.status === 'Pending' && i.severity === 'Critical');
      const minorIssues = issues.filter(i => i.status === 'Pending' && i.severity === 'Minor');
      const checkedOutItems = locations.filter(l => l.status === 'Checked Out');

      document.getElementById('dashOverdueCount').textContent = overdueCount;
      document.getElementById('dashUpToDateCount').textContent = upToDateCount;
      document.getElementById('dashOutOfServiceCount').textContent = criticalIssues.length;
      document.getElementById('dashMinorIssuesCount').textContent = minorIssues.length;
      document.getElementById('dashCheckedOutCount').textContent = checkedOutItems.length;
      document.getElementById('dashDueThisWeekCount').textContent = dueThisWeekItems.filter(i => i.daysUntil > 0 && i.daysUntil <= 7).length;

      // Render Needs Attention This Week section
      const needsAttentionContainer = document.getElementById('dashboardNeedsAttention');
      if (dueThisWeekItems.length > 0) {
        needsAttentionContainer.innerHTML = `
          <div class="dashboard-section">
            <h3 class="dashboard-section-title">üìã Needs Attention This Week</h3>
            ${dueThisWeekItems.slice(0, 10).map(item => {
              const isOverdue = item.status === 'danger';
              return `
                <div class="dashboard-issue-item ${isOverdue ? '' : 'minor'}" style="cursor: pointer;" onclick="window.viewEquipmentDetails('${item.equipment.id}')">
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment</div>
                    <div class="dashboard-issue-field-value">${item.equipment.equipmentId}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Type</div>
                    <div class="dashboard-issue-field-value">${item.equipment.type}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Maintenance Item</div>
                    <div class="dashboard-issue-field-value">${item.item.name}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Next Due</div>
                    <div class="dashboard-issue-field-value">${item.nextDue}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Status</div>
                    <div class="days-down" style="color: ${isOverdue ? 'var(--danger)' : 'var(--warning)'};">
                      ${item.daysUntil === -999 ? 'Never Done' : item.daysUntil < 0 ? `${Math.abs(item.daysUntil)}d overdue` : `${item.daysUntil}d left`}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
            ${dueThisWeekItems.length > 10 ? `<p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">+${dueThisWeekItems.length - 10} more items...</p>` : ''}
          </div>
        `;
      } else {
        needsAttentionContainer.innerHTML = `
          <div class="dashboard-section">
            <h3 class="dashboard-section-title">üìã Needs Attention This Week</h3>
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úì</div>
              <p>All maintenance is up to date for this week!</p>
            </div>
          </div>
        `;
      }
      
      // Render Checked Out Equipment Section
      const checkedOutContainer = document.getElementById('dashboardCheckedOut');
      if (checkedOutItems.length > 0) {
        checkedOutContainer.innerHTML = `
          <div class="dashboard-section">
            <h3 class="dashboard-section-title">üìç Equipment Checked Out</h3>
            ${checkedOutItems.map(location => {
              const eq = equipment.find(e => e.id === location.equipmentId);
              const checkOutDate = new Date(location.checkOutDate);
              const today = new Date();
              const daysOut = Math.floor((today - checkOutDate) / (1000 * 60 * 60 * 24));
              
              return `
                <div class="dashboard-issue-item" style="border-left-color: #2196F3;">
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment ID</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.equipmentId : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment Type</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.type : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Customer</div>
                    <div class="dashboard-issue-field-value">${location.customer}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Checked Out Date</div>
                    <div class="dashboard-issue-field-value">${checkOutDate.toLocaleDateString()}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Days Out</div>
                    <div class="days-down" style="color: #2196F3;">${daysOut}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        checkedOutContainer.innerHTML = '';
      }
      
      // Render Critical Issues Section
      const criticalContainer = document.getElementById('dashboardCriticalIssues');
      if (criticalIssues.length > 0) {
        criticalContainer.innerHTML = `
          <div class="dashboard-section">
            <h3 class="dashboard-section-title">üõë Critical Issues - Out of Service</h3>
            ${criticalIssues.map(issue => {
              const eq = equipment.find(e => e.id === issue.equipmentId);
              const reportedDate = new Date(issue.createdAt);
              const today = new Date();
              const daysDown = Math.floor((today - reportedDate) / (1000 * 60 * 60 * 24));
              
              return `
                <div class="dashboard-issue-item">
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment ID</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.equipmentId : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment Type</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.type : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Issue Title</div>
                    <div class="dashboard-issue-field-value">${issue.title}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Description</div>
                    <div class="dashboard-issue-field-value">${issue.notes}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Days Down</div>
                    <div class="days-down">${daysDown}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Reported: ${reportedDate.toLocaleDateString()}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        criticalContainer.innerHTML = '';
      }
      
      // Render Minor Issues Section
      const minorContainer = document.getElementById('dashboardMinorIssues');
      if (minorIssues.length > 0) {
        minorContainer.innerHTML = `
          <div class="dashboard-section">
            <h3 class="dashboard-section-title">üîß Minor Issues - Needs Repair</h3>
            ${minorIssues.map(issue => {
              const eq = equipment.find(e => e.id === issue.equipmentId);
              const reportedDate = new Date(issue.createdAt);
              const today = new Date();
              const daysDown = Math.floor((today - reportedDate) / (1000 * 60 * 60 * 24));
              
              return `
                <div class="dashboard-issue-item minor">
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment ID</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.equipmentId : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Equipment Type</div>
                    <div class="dashboard-issue-field-value">${eq ? eq.type : 'Unknown'}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Issue Title</div>
                    <div class="dashboard-issue-field-value">${issue.title}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Description</div>
                    <div class="dashboard-issue-field-value">${issue.notes}</div>
                  </div>
                  <div class="dashboard-issue-field">
                    <div class="dashboard-issue-field-label">Days Open</div>
                    <div class="days-down" style="color: var(--warning);">${daysDown}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Reported: ${reportedDate.toLocaleDateString()}</div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else {
        minorContainer.innerHTML = '';
      }
    }
    
    // LOCATION TRACKING FUNCTIONS
    window.openCheckOutModal = function() {
      document.getElementById('checkOutDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('checkOutModal').classList.add('active');
    }
    
    window.checkOutEquipment = async function(event) {
      event.preventDefault();

      const equipmentId = document.getElementById('checkOutEquipment').value;
      const customer = document.getElementById('checkOutCustomer').value;
      const checkOutDate = document.getElementById('checkOutDate').value;

      if (!equipmentId || !customer || !checkOutDate) {
        showToast('Please fill in all required fields', 'warning');
        return;
      }

      const newLocation = {
        equipmentId: equipmentId,
        customer: customer,
        checkOutDate: checkOutDate,
        returnDate: null,
        status: 'Checked Out',
        createdAt: new Date().toISOString()
      };

      showLoading('Checking out equipment...');

      try {
        await addDoc(collection(db, 'locations'), newLocation);
        await loadData(false);
        hideLoading();
        showToast('Equipment checked out successfully');
        document.getElementById('checkOutForm').reset();
        closeModal('checkOutModal');
        renderLocations();
      } catch (error) {
        console.error('Error checking out equipment:', error);
        hideLoading();
        showToast('Error checking out equipment. Please try again.', 'error');
      }
    }
    
    window.renderLocations = function() {
      const container = document.getElementById('locationsList');
      const filterEquipment = document.getElementById('locationEquipmentFilter').value;
      const showReturned = document.getElementById('showReturnedItems').checked;

      let filteredLocations = locations.filter(l => {
        const matchesEquipment = !filterEquipment || l.equipmentId === filterEquipment;
        const matchesStatus = showReturned || l.status === 'Checked Out';
        return matchesEquipment && matchesStatus;
      });
      
      // Sort: Checked Out first, then by check out date (newest first)
      filteredLocations.sort((a, b) => {
        if (a.status === 'Checked Out' && b.status !== 'Checked Out') return -1;
        if (a.status !== 'Checked Out' && b.status === 'Checked Out') return 1;
        return new Date(b.checkOutDate) - new Date(a.checkOutDate);
      });
      
      if (filteredLocations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìç</div>
            <h3>No Equipment Checked Out</h3>
            <p>All equipment is in inventory</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredLocations.map(location => {
        const eq = equipment.find(e => e.id === location.equipmentId);
        const isReturned = location.status === 'Returned';
        
        return `
          <div class="issue-card ${isReturned ? 'completed' : ''}">
            <div class="issue-header">
              <div>
                <div class="issue-equipment">${eq ? `${eq.equipmentId} - ${eq.name}` : 'Unknown'}</div>
                <div class="issue-title">Customer: ${location.customer}</div>
              </div>
              <span class="status-badge ${isReturned ? 'status-good' : 'status-warning'}">${location.status}</span>
            </div>
            <div class="issue-meta">
              <span><strong>Checked Out:</strong> ${new Date(location.checkOutDate).toLocaleDateString()}</span>
              ${isReturned ? `<span><strong>Returned:</strong> ${new Date(location.returnDate).toLocaleDateString()}</span>` : ''}
            </div>
            <div class="issue-actions">
              ${!isReturned ? `<button class="btn btn-small btn-primary" onclick="window.returnEquipment('${location.id}')">Mark Returned</button>` : ''}
              <button class="btn btn-small" onclick="window.deleteLocation('${location.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.returnEquipment = async function(locationId) {
      showLoading('Returning equipment...');

      try {
        await updateDoc(doc(db, 'locations', locationId), {
          status: 'Returned',
          returnDate: new Date().toISOString()
        });

        await loadData(false);
        hideLoading();
        showToast('Equipment returned successfully');
        renderLocations();
      } catch (error) {
        console.error('Error returning equipment:', error);
        hideLoading();
        showToast('Error returning equipment. Please try again.', 'error');
      }
    }

    window.deleteLocation = async function(locationId) {
      if (!confirm('Delete this location record?')) return;

      showLoading('Deleting record...');

      try {
        await deleteDoc(doc(db, 'locations', locationId));
        await loadData(false);
        hideLoading();
        showToast('Location record deleted');
        renderLocations();
      } catch (error) {
        console.error('Error deleting location:', error);
        hideLoading();
        showToast('Error deleting location. Please try again.', 'error');
      }
    }
    
    // COST REPAIR ANALYSIS FUNCTIONS
    let costChart = null;
    
    window.renderCostRepair = function() {
      const selectedEquipmentId = document.getElementById('costRepairEquipmentFilter').value;
      const listContainer = document.getElementById('costRepairList');
      const chartContainer = document.getElementById('costRepairChart');
      const printBtn = document.getElementById('printCostRepairBtn');
      
      if (!selectedEquipmentId) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üí∞</div>
            <h3>Select Equipment</h3>
            <p>Choose equipment from the dropdown to view repair cost analysis</p>
          </div>
        `;
        chartContainer.style.display = 'none';
        printBtn.style.display = 'none';
        return;
      }
      
      const eq = equipment.find(e => e.id === selectedEquipmentId);
      const equipmentIssues = issues.filter(i => i.equipmentId === selectedEquipmentId);
      
      if (equipmentIssues.length === 0) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">‚úÖ</div>
            <h3>No Repair Costs</h3>
            <p>${eq ? eq.equipmentId : 'This equipment'} has no recorded repair issues</p>
          </div>
        `;
        chartContainer.style.display = 'none';
        printBtn.style.display = 'none';
        return;
      }
      
      printBtn.style.display = 'inline-block';
      
      // Calculate costs by year
      const costsByYear = {};
      let totalCost = 0;
      
      equipmentIssues.forEach(issue => {
        if (issue.cost) {
          const year = new Date(issue.createdAt).getFullYear();
          if (!costsByYear[year]) {
            costsByYear[year] = 0;
          }
          costsByYear[year] += parseFloat(issue.cost);
          totalCost += parseFloat(issue.cost);
        }
      });
      
      // Render chart
      const years = Object.keys(costsByYear).sort();
      const costs = years.map(year => costsByYear[year]);
      
      if (years.length > 0) {
        chartContainer.style.display = 'block';
        
        const ctx = document.getElementById('costChartCanvas').getContext('2d');
        
        if (costChart) {
          costChart.destroy();
        }
        
        costChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: years,
            datasets: [{
              label: 'Repair Costs ($)',
              data: costs,
              backgroundColor: '#215530',
              borderColor: '#215530',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false
              },
              title: {
                display: true,
                text: `${eq ? eq.equipmentId : 'Equipment'} - Total Repair Costs by Year`,
                font: {
                  size: 16,
                  weight: 'bold',
                  family: "'Roboto Condensed', sans-serif"
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(0);
                  }
                }
              }
            }
          }
        });
      } else {
        chartContainer.style.display = 'none';
      }
      
      // Render issue list with costs
      listContainer.innerHTML = `
        <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="font-family: 'Roboto Condensed', sans-serif; color: var(--helena-green); margin-bottom: 1rem;">
            ${eq ? `${eq.equipmentId} - ${eq.name}` : 'Equipment'} Repair History
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 6px;">
              <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Issues</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--helena-green);">${equipmentIssues.length}</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 6px;">
              <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Issues with Cost</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--helena-green);">${equipmentIssues.filter(i => i.cost).length}</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: var(--bg-primary); border-radius: 6px;">
              <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Total Cost</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--danger);">$${totalCost.toFixed(2)}</div>
            </div>
          </div>
        </div>
        
        <div style="background: white; padding: 1.5rem; border-radius: 8px;">
          <h4 style="font-family: 'Roboto Condensed', sans-serif; color: var(--helena-green); margin-bottom: 1rem;">Detailed Issue List</h4>
          ${equipmentIssues.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).map(issue => {
            const severity = issue.severity || 'Minor';
            return `
              <div style="border: 1px solid var(--border); border-left: 4px solid ${severity === 'Critical' ? 'var(--danger)' : 'var(--warning)'}; border-radius: 6px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                  <div>
                    <div style="font-weight: 700; color: var(--text-primary);">${issue.title}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                      <span class="severity-badge severity-${severity.toLowerCase()}">${severity}</span>
                      <span style="margin-left: 0.5rem;">Reported: ${new Date(issue.createdAt).toLocaleDateString()}</span>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 1.25rem; font-weight: 700; color: ${issue.cost ? 'var(--danger)' : 'var(--text-secondary)'};">
                      ${issue.cost ? '$' + parseFloat(issue.cost).toFixed(2) : 'No Cost'}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${issue.status}</div>
                  </div>
                </div>
                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">${issue.notes}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    window.printCostRepairReport = function() {
      const selectedEquipmentId = document.getElementById('costRepairEquipmentFilter').value;
      if (!selectedEquipmentId) {
        alert('Please select equipment first');
        return;
      }
      
      const eq = equipment.find(e => e.id === selectedEquipmentId);
      const equipmentIssues = issues.filter(i => i.equipmentId === selectedEquipmentId);
      
      // Calculate costs by year
      const costsByYear = {};
      let totalCost = 0;
      
      equipmentIssues.forEach(issue => {
        if (issue.cost) {
          const year = new Date(issue.createdAt).getFullYear();
          if (!costsByYear[year]) {
            costsByYear[year] = 0;
          }
          costsByYear[year] += parseFloat(issue.cost);
          totalCost += parseFloat(issue.cost);
        }
      });
      
      const years = Object.keys(costsByYear).sort();
      
      const logoSVG = '<svg width="120" height="68" viewBox="0 0 157 90" xmlns="http://www.w3.org/2000/svg"><g fill="#215530"><path d="M78.487013,73.5487013 C57.974026,73.5487013 38.6298701,69.9837662 24.0194805,63.4967532 C8.53246753,56.6006494 0,47.1331169 0,36.788961 C0,26.4155844 8.53246753,16.9480519 24.0194805,10.0519481 C38.6298701,3.56493506 57.974026,0 78.487013,0 C99,0 118.344156,3.56493506 132.954545,10.0519481 C148.441558,16.9480519 156.974026,26.4155844 156.974026,36.7597403 C156.974026,47.1038961 148.441558,56.6006494 132.954545,63.4675325 C118.373377,69.9837662 99.0292208,73.5487013 78.487013,73.5487013 Z M78.487013,6.8961039 C58.9090909,6.8961039 40.5584416,10.2564935 26.7954545,16.3636364 C14.1136364,22.0032468 6.86688312,29.4253247 6.86688312,36.788961 C6.86688312,44.1525974 14.1428571,51.5746753 26.7954545,57.2142857 C40.5292208,63.3214286 58.9090909,66.6818182 78.487013,66.6818182 C98.0649351,66.6818182 116.415584,63.3214286 130.178571,57.2142857 C142.86039,51.5746753 150.107143,44.1525974 150.107143,36.788961 C150.107143,29.4253247 142.831169,22.0032468 130.178571,16.3636364 C116.444805,10.2564935 98.0649351,6.8961039 78.487013,6.8961039 Z"/><polygon points="25.5681818 49.1785714 25.5681818 39.5357143 32.5227273 39.5357143 32.5227273 49.1785714 39.9155844 49.1785714 39.9155844 24.3116883 32.5227273 24.3116883 32.5227273 32.6980519 25.5681818 32.6980519 25.5681818 24.3116883 18.1753247 24.3116883 18.1753247 49.1785714"/><polygon points="58.8506494 49.1785714 58.8506494 43.3928571 48.7402597 43.3928571 48.7402597 39.4772727 58.0324675 39.4772727 58.0324675 33.6623377 48.7402597 33.6623377 48.7402597 30.0974026 58.4123377 30.0974026 58.4123377 24.3116883 41.3474026 24.3116883 41.3474026 49.1785714"/><polygon points="75.4188312 49.1785714 75.4188312 42.9545455 67.8798701 42.9545455 67.8798701 24.3116883 60.487013 24.3116883 60.487013 49.1785714"/><polygon points="94.1201299 49.1785714 94.1201299 43.3928571 84.0097403 43.3928571 84.0097403 39.4772727 93.3019481 39.4772727 93.3019481 33.6623377 84.0097403 33.6623377 84.0097403 30.0974026 93.6818182 30.0974026 93.6818182 24.3116883 76.6168831 24.3116883 76.6168831 49.1785714"/><polygon points="104.172078 24.3116883 95.5519481 24.3116883 95.5519481 49.1785714 102.623377 49.1785714 102.623377 41.3181818 102.331169 35.6493506 108.642857 49.1785714 117.262987 49.1785714 117.262987 24.3116883 110.220779 24.3116883 110.220779 32.2305195 110.483766 37.8993506"/><polygon points="121.87987 37.8409091 132.691558 37.8409091 132.691558 43.9188312 121.87987 43.9188312"/><polygon points="122.931818 24.5746753 132.662338 24.5746753 139.587662 49.1785714 133.042208 49.1785714 127.811688 30.1558442 122.727273 49.1785714 115.275974 49.1785714"/></g></svg>';
      
      let printHTML = '<html><head><title>Cost Analysis Report</title>';
      printHTML += '<style>';
      printHTML += 'body{font-family:Arial,sans-serif;padding:15px;font-size:11px;} ';
      printHTML += 'h1{color:#215530;font-size:20px;margin:0 0 5px;text-transform:uppercase;} ';
      printHTML += 'h2{color:#215530;font-size:16px;margin:15px 0 8px;border-bottom:2px solid #215530;padding-bottom:4px;} ';
      printHTML += 'h3{color:#215530;font-size:14px;margin:10px 0 6px;} ';
      printHTML += '.header{display:flex;align-items:center;gap:15px;margin-bottom:15px;border-bottom:2px solid #215530;padding-bottom:10px;} ';
      printHTML += '.info{background:#f8f9fa;padding:8px;margin:0 0 10px;border-left:3px solid #215530;font-size:10px;} ';
      printHTML += '.info p{margin:2px 0;} ';
      printHTML += '.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:15px 0;} ';
      printHTML += '.summary-box{background:#f8f9fa;padding:10px;text-align:center;border-radius:4px;} ';
      printHTML += '.summary-label{font-size:9px;color:#666;margin-bottom:4px;} ';
      printHTML += '.summary-value{font-size:18px;font-weight:700;color:#215530;} ';
      printHTML += 'table{width:100%;border-collapse:collapse;font-size:10px;margin:10px 0;} ';
      printHTML += 'th{background:#215530;color:white;padding:6px 8px;text-align:left;font-size:10px;} ';
      printHTML += 'td{padding:6px 8px;border-bottom:1px solid #ddd;vertical-align:top;} ';
      printHTML += 'tr:nth-child(even) td{background:#f8f9fa;} ';
      printHTML += '.critical{border-left:3px solid #dc3545;} ';
      printHTML += '.minor{border-left:3px solid #ffc107;} ';
      printHTML += '@page{margin:0.5in;}';
      printHTML += '</style></head><body>';
      
      printHTML += '<div class="header">' + logoSVG;
      printHTML += '<div><h1>Equipment Repair Cost Analysis</h1>';
      printHTML += '<div style="font-size:10px;color:#666;">Helena Agri-Enterprises</div></div></div>';
      
      printHTML += '<div class="info">';
      printHTML += '<p><b>Equipment ID:</b> ' + eq.equipmentId + ' &nbsp;&nbsp; <b>Name:</b> ' + eq.name + '</p>';
      printHTML += '<p><b>Type:</b> ' + eq.type + ' &nbsp;&nbsp; <b>Report Date:</b> ' + new Date().toLocaleDateString() + '</p>';
      printHTML += '</div>';
      
      printHTML += '<div class="summary">';
      printHTML += '<div class="summary-box"><div class="summary-label">Total Issues</div><div class="summary-value">' + equipmentIssues.length + '</div></div>';
      printHTML += '<div class="summary-box"><div class="summary-label">Issues with Cost Data</div><div class="summary-value">' + equipmentIssues.filter(i => i.cost).length + '</div></div>';
      printHTML += '<div class="summary-box"><div class="summary-label">Total Repair Cost</div><div class="summary-value" style="color:#dc3545;">$' + totalCost.toFixed(2) + '</div></div>';
      printHTML += '</div>';
      
      if (years.length > 0) {
        printHTML += '<h2>Cost Summary by Year</h2>';
        printHTML += '<table><tr><th>Year</th><th>Total Cost</th><th>Number of Issues</th><th>Average Cost per Issue</th></tr>';
        years.forEach(year => {
          const yearIssues = equipmentIssues.filter(i => i.cost && new Date(i.createdAt).getFullYear().toString() === year);
          const avgCost = costsByYear[year] / yearIssues.length;
          printHTML += '<tr>';
          printHTML += '<td><b>' + year + '</b></td>';
          printHTML += '<td>$' + costsByYear[year].toFixed(2) + '</td>';
          printHTML += '<td>' + yearIssues.length + '</td>';
          printHTML += '<td>$' + avgCost.toFixed(2) + '</td>';
          printHTML += '</tr>';
        });
        printHTML += '</table>';
      }
      
      printHTML += '<h2>Detailed Issue History</h2>';
      printHTML += '<table><tr><th>Date</th><th>Issue</th><th>Severity</th><th>Cost</th><th>Status</th></tr>';
      
      equipmentIssues.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(issue => {
        const severity = issue.severity || 'Minor';
        printHTML += '<tr class="' + severity.toLowerCase() + '">';
        printHTML += '<td>' + new Date(issue.createdAt).toLocaleDateString() + '</td>';
        printHTML += '<td><b>' + issue.title + '</b><br><span style="font-size:9px;color:#666;">' + issue.notes + '</span></td>';
        printHTML += '<td>' + severity + '</td>';
        printHTML += '<td><b>' + (issue.cost ? '$' + parseFloat(issue.cost).toFixed(2) : 'N/A') + '</b></td>';
        printHTML += '<td>' + issue.status + '</td>';
        printHTML += '</tr>';
      });
      
      printHTML += '</table>';
      printHTML += '</body></html>';
      
      const win = window.open('', '_blank');
      win.document.write(printHTML);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 250);
    }
    
    window.openAddTemplateModal = function() {
      document.getElementById('addTemplateModal').classList.add('active');
    }
    
    // WEATHER AND TIME UPDATE
    function updateDateTime() {
      const now = new Date();
      
      // Update date
      const dateOptions = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
      document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', dateOptions);
      
      // Update time
      const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true };
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', timeOptions);
    }
    
    // Convert wind direction degrees to cardinal direction
    function getWindDirection(degrees) {
      const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
      const index = Math.round(degrees / 22.5) % 16;
      return directions[index];
    }

    // Convert km/h to mph
    function kmhToMph(kmh) {
      return Math.round(kmh * 0.621371);
    }

    async function updateWeather() {
      try {
        // Using Open-Meteo API (free, no API key needed)
        // Coweta, Oklahoma coordinates: 35.9512¬∞ N, 95.6508¬∞ W
        // Added current wind data and gusts
        const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.9512&longitude=-95.6508&current=temperature_2m,windspeed_10m,winddirection_10m,windgusts_10m&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America%2FChicago');
        const data = await response.json();

        if (data.current) {
          const temp = Math.round(data.current.temperature_2m);
          const windSpeed = Math.round(data.current.windspeed_10m);
          const windDir = getWindDirection(data.current.winddirection_10m);
          const windGust = Math.round(data.current.windgusts_10m);

          document.getElementById('currentWeather').textContent = `${temp}¬∞F`;

          let windText = `üí® ${windDir} ${windSpeed} mph`;
          if (windGust > windSpeed + 5) {
            windText += ` (gusts ${windGust})`;
          }
          document.getElementById('currentWind').textContent = windText;
        }
      } catch (error) {
        console.error('Error fetching weather:', error);
        document.getElementById('currentWeather').textContent = '';
        document.getElementById('currentWind').textContent = '';
      }
    }
    
    // Update time every second
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Update weather every 10 minutes
    updateWeather();
    setInterval(updateWeather, 600000);

    // ALERTS BANNER FUNCTIONS
    let alertsDismissed = false;

    function renderAlertsBanner() {
      if (alertsDismissed) return;

      const banner = document.getElementById('alertsBanner');
      const content = document.getElementById('alertsContent');

      // Calculate alerts
      let overdueItems = 0;
      let dueThisWeek = 0;
      let criticalIssues = issues.filter(i => i.status === 'Pending' && i.severity === 'Critical').length;
      let checkedOutCount = locations.filter(l => l.status === 'Checked Out').length;

      equipment.forEach(eq => {
        if (eq.maintenanceItems) {
          eq.maintenanceItems.forEach(item => {
            const { status, daysUntil } = getMaintenanceStatus(item, eq);
            if (status === 'danger') overdueItems++;
            else if (daysUntil <= 7 && daysUntil > 0) dueThisWeek++;
          });
        }
      });

      const totalAlerts = overdueItems + dueThisWeek + criticalIssues;

      if (totalAlerts === 0) {
        banner.classList.remove('show', 'has-critical');
        return;
      }

      banner.classList.add('show');
      if (criticalIssues > 0 || overdueItems > 0) {
        banner.classList.add('has-critical');
      } else {
        banner.classList.remove('has-critical');
      }

      let alertsHTML = '';

      if (overdueItems > 0) {
        alertsHTML += `<div class="alert-item" onclick="switchToTab('equipment')">
          <span class="alert-count critical">${overdueItems}</span>
          <span>Overdue Maintenance</span>
        </div>`;
      }

      if (dueThisWeek > 0) {
        alertsHTML += `<div class="alert-item" onclick="switchToTab('schedule')">
          <span class="alert-count warning">${dueThisWeek}</span>
          <span>Due This Week</span>
        </div>`;
      }

      if (criticalIssues > 0) {
        alertsHTML += `<div class="alert-item" onclick="switchToTab('issues')">
          <span class="alert-count critical">${criticalIssues}</span>
          <span>Critical Issues</span>
        </div>`;
      }

      if (checkedOutCount > 0) {
        alertsHTML += `<div class="alert-item" onclick="switchToTab('location')">
          <span class="alert-count info">${checkedOutCount}</span>
          <span>Equipment Checked Out</span>
        </div>`;
      }

      content.innerHTML = alertsHTML;
    }

    window.dismissAlerts = function() {
      alertsDismissed = true;
      document.getElementById('alertsBanner').classList.remove('show');
    }

    function switchToTab(tabName) {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.tab === tabName) tab.classList.add('active');
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');

      // Render the tab content
      if (tabName === 'schedule') renderScheduleCalendar();
      if (tabName === 'issues') renderIssues();
      if (tabName === 'location') renderLocations();
      if (tabName === 'dashboard') renderDashboard();
      if (tabName === 'products') renderProducts();
      if (tabName === 'loads') renderLoads();
      if (tabName === 'tasks') renderTasks();
      if (tabName === 'orders') renderOrders();
    }

    // PHOTO HANDLING FUNCTIONS - Multiple photos support
    window.previewIssuePhotos = async function(input) {
      if (input.files && input.files.length > 0) {
        document.getElementById('issuePhotoPlaceholder').textContent = 'üì∑ Processing photos...';

        for (const file of Array.from(input.files)) {
          try {
            const compressedPhoto = await compressImage(file);
            currentIssuePhotos.push(compressedPhoto);
            renderIssuePhotoPreviews();
          } catch (error) {
            console.error('Error processing photo:', error);
            showToast('Error processing photo', 'error');
          }
        }

        input.value = ''; // Reset to allow selecting same files
        document.getElementById('issuePhotoPlaceholder').textContent = 'üì∑ Click to add more photos';
        document.getElementById('issuePhotoArea').classList.add('has-photo');
      }
    }

    function renderIssuePhotoPreviews() {
      const container = document.getElementById('issuePhotoPreviews');
      if (currentIssuePhotos.length === 0) {
        container.innerHTML = '';
        document.getElementById('issuePhotoPlaceholder').textContent = 'üì∑ Click to add photos';
        document.getElementById('issuePhotoArea').classList.remove('has-photo');
        return;
      }
      container.innerHTML = currentIssuePhotos.map((photo, index) => `
        <div class="photo-preview-item">
          <img src="${photo}" onclick="window.viewPhoto('${photo}')" title="Click to view">
          <button type="button" class="remove-photo" onclick="window.removeIssuePhoto(${index})" title="Remove">√ó</button>
        </div>
      `).join('');
    }

    window.removeIssuePhoto = function(index) {
      currentIssuePhotos.splice(index, 1);
      renderIssuePhotoPreviews();
    }

    window.viewPhoto = function(photoData) {
      document.getElementById('photoViewerImage').src = photoData;
      document.getElementById('photoViewerModal').classList.add('active');
    }

    // PRODUCTS FUNCTIONS
    function populateProductSelects() {
      const loadProductSelect = document.getElementById('loadProduct');
      const loadProductFilter = document.getElementById('loadProductFilter');

      const sortedProducts = [...products].sort((a, b) => a.partNumber.localeCompare(b.partNumber));

      // Load product dropdown
      if (loadProductSelect) {
        loadProductSelect.innerHTML = '<option value="">Select Product</option>' +
          sortedProducts.map(p => `<option value="${p.id}">${p.partNumber} - ${p.description}</option>`).join('');
      }

      // Load product filter
      if (loadProductFilter) {
        loadProductFilter.innerHTML = '<option value="">All Products</option>' +
          sortedProducts.map(p => `<option value="${p.id}">${p.partNumber}</option>`).join('');
      }
    }

    window.openAddProductModal = function() {
      document.getElementById('addProductForm').reset();
      document.getElementById('addProductModal').classList.add('active');
    }

    window.addProduct = async function(event) {
      event.preventDefault();

      const newProduct = {
        partNumber: document.getElementById('productPartNumber').value.trim(),
        description: document.getElementById('productDescription').value.trim(),
        type: document.getElementById('productType').value,
        createdAt: new Date().toISOString()
      };

      // Check for duplicate part number
      if (products.some(p => p.partNumber.toLowerCase() === newProduct.partNumber.toLowerCase())) {
        showToast('A product with this part number already exists', 'error');
        return;
      }

      showLoading('Adding product...');

      try {
        await addDoc(collection(db, 'products'), newProduct);
        await loadData(false);
        hideLoading();
        showToast('Product added successfully');
        document.getElementById('addProductForm').reset();
        closeModal('addProductModal');
        renderProducts();
      } catch (error) {
        console.error('Error adding product:', error);
        hideLoading();
        showToast('Error adding product. Please try again.', 'error');
      }
    }

    window.renderProducts = function() {
      const container = document.getElementById('productsList');
      const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';

      let filteredProducts = products.filter(p => {
        return p.partNumber.toLowerCase().includes(searchTerm) ||
               p.description.toLowerCase().includes(searchTerm);
      });

      filteredProducts.sort((a, b) => a.partNumber.localeCompare(b.partNumber));

      if (filteredProducts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h3>No Products Found</h3>
            <p>Add products to start tracking loads.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filteredProducts.map(product => `
        <div class="product-card">
          <div class="product-part-number">${product.partNumber}</div>
          <div class="product-description">${product.description}</div>
          <span class="product-type ${product.type.toLowerCase()}">${product.type} Fertilizer</span>
          <div class="product-actions">
            <button class="btn btn-small" onclick="window.openEditProductModal('${product.id}')">Edit</button>
            <button class="btn btn-small" onclick="window.deleteProduct('${product.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    window.filterProducts = function() {
      renderProducts();
    }

    window.openEditProductModal = function(productId) {
      const product = products.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('editProductId').value = productId;
      document.getElementById('editProductPartNumber').value = product.partNumber;
      document.getElementById('editProductDescription').value = product.description;
      document.getElementById('editProductType').value = product.type;

      document.getElementById('editProductModal').classList.add('active');
    }

    window.updateProduct = async function(event) {
      event.preventDefault();

      const productId = document.getElementById('editProductId').value;
      const updatedProduct = {
        partNumber: document.getElementById('editProductPartNumber').value.trim(),
        description: document.getElementById('editProductDescription').value.trim(),
        type: document.getElementById('editProductType').value
      };

      // Check for duplicate part number (excluding current product)
      if (products.some(p => p.id !== productId && p.partNumber.toLowerCase() === updatedProduct.partNumber.toLowerCase())) {
        showToast('A product with this part number already exists', 'error');
        return;
      }

      showLoading('Updating product...');

      try {
        await updateDoc(doc(db, 'products', productId), updatedProduct);
        await loadData(false);
        hideLoading();
        showToast('Product updated successfully');
        closeModal('editProductModal');
        renderProducts();
      } catch (error) {
        console.error('Error updating product:', error);
        hideLoading();
        showToast('Error updating product. Please try again.', 'error');
      }
    }

    window.deleteProduct = async function(productId) {
      // Check if product is used in any loads
      const usedInLoads = loads.some(l => l.productId === productId);
      if (usedInLoads) {
        showToast('Cannot delete product - it is used in existing loads', 'error');
        return;
      }

      if (!confirm('Are you sure you want to delete this product?')) return;

      showLoading('Deleting product...');

      try {
        await deleteDoc(doc(db, 'products', productId));
        await loadData(false);
        hideLoading();
        showToast('Product deleted successfully');
        renderProducts();
      } catch (error) {
        console.error('Error deleting product:', error);
        hideLoading();
        showToast('Error deleting product. Please try again.', 'error');
      }
    }

    // LOAD TRACKING FUNCTIONS
    window.openAddLoadModal = function() {
      document.getElementById('addLoadForm').reset();
      document.getElementById('loadProductInfo').style.display = 'none';
      document.getElementById('releaseFieldsContainer').innerHTML = '';
      populateProductSelects();
      document.getElementById('addLoadModal').classList.add('active');
    }

    window.fillProductInfo = function() {
      const productId = document.getElementById('loadProduct').value;
      const infoDiv = document.getElementById('loadProductInfo');

      if (!productId) {
        infoDiv.style.display = 'none';
        return;
      }

      const product = products.find(p => p.id === productId);
      if (product) {
        document.getElementById('loadProductDescription').textContent = product.description;
        document.getElementById('loadProductType').textContent = product.type + ' Fertilizer';
        infoDiv.style.display = 'block';
        generateReleaseFields();
      }
    }

    window.generateReleaseFields = function() {
      const quantity = parseInt(document.getElementById('loadQuantity').value) || 1;
      const container = document.getElementById('releaseFieldsContainer');

      let html = '<div style="margin-top: 1rem;"><strong>Release Numbers:</strong></div>';
      for (let i = 1; i <= quantity; i++) {
        html += `
          <div class="release-field-group">
            <label>Load ${i} - Release Number</label>
            <input type="text" id="releaseNumber${i}" placeholder="Enter release number">
          </div>
        `;
      }
      container.innerHTML = html;
    }

    window.addLoad = async function(event) {
      event.preventDefault();

      const productId = document.getElementById('loadProduct').value;
      const product = products.find(p => p.id === productId);
      const quantity = parseInt(document.getElementById('loadQuantity').value);

      if (!product) {
        showToast('Please select a product', 'error');
        return;
      }

      // Gather release numbers
      const loadLines = [];
      for (let i = 1; i <= quantity; i++) {
        const releaseNumber = document.getElementById(`releaseNumber${i}`).value.trim();
        loadLines.push({
          lineNumber: i,
          releaseNumber: releaseNumber,
          assigned: false,
          delivered: false
        });
      }

      const newLoad = {
        productId: product.id,
        partNumber: product.partNumber,
        description: product.description,
        type: product.type,
        loadLines: loadLines,
        createdAt: new Date().toISOString()
      };

      showLoading('Creating load request...');

      try {
        await addDoc(collection(db, 'loads'), newLoad);
        await loadData(false);
        hideLoading();
        showToast('Load request created successfully');
        closeModal('addLoadModal');
        renderLoads();
      } catch (error) {
        console.error('Error creating load:', error);
        hideLoading();
        showToast('Error creating load request. Please try again.', 'error');
      }
    }

    window.renderLoads = function() {
      const container = document.getElementById('loadsList');
      const statusFilter = document.getElementById('loadStatusFilter')?.value || '';
      const productFilter = document.getElementById('loadProductFilter')?.value || '';

      let filteredLoads = [...loads];

      // Apply product filter
      if (productFilter) {
        filteredLoads = filteredLoads.filter(l => l.productId === productFilter);
      }

      // Apply status filter
      if (statusFilter) {
        filteredLoads = filteredLoads.filter(l => {
          const status = getLoadStatus(l);
          if (statusFilter === 'active') {
            return status === 'open' || status === 'partial';
          }
          return status === statusFilter;
        });
      }

      // Sort by created date (newest first), then by open status
      filteredLoads.sort((a, b) => {
        const aStatus = getLoadStatus(a);
        const bStatus = getLoadStatus(b);
        // Open loads first, then partial, then complete
        const statusOrder = { open: 0, partial: 1, complete: 2 };
        if (statusOrder[aStatus] !== statusOrder[bStatus]) {
          return statusOrder[aStatus] - statusOrder[bStatus];
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      if (filteredLoads.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üöö</div>
            <h3>No Loads Found</h3>
            <p>Create a new load request to start tracking deliveries.</p>
          </div>
        `;
        return;
      }

      // Build assigned options dropdown HTML
      const assignedOptionsHTML = assignedOptions.length > 0
        ? `<option value="">-- Select --</option>` + assignedOptions.map(opt => `<option value="${opt.name}">${opt.name}</option>`).join('')
        : `<option value="">No options</option>`;

      container.innerHTML = filteredLoads.map(load => {
        const status = getLoadStatus(load);
        const deliveredCount = load.loadLines.filter(l => l.delivered).length;
        const totalCount = load.loadLines.length;
        const progressPercent = totalCount > 0 ? (deliveredCount / totalCount) * 100 : 0;
        const isCollapsed = collapsedLoads.has(load.id);

        return `
          <div class="load-card ${status} ${isCollapsed ? 'collapsed' : ''}" data-load-id="${load.id}">
            <div class="load-card-header" onclick="window.toggleLoadCollapse('${load.id}')">
              <div class="load-header" style="flex: 1; pointer-events: none;">
                <div class="load-product-info">
                  <div class="load-part-number">${load.partNumber}</div>
                  <div class="load-description">${load.description} <span class="product-type ${load.type.toLowerCase()}" style="font-size: 0.7rem; padding: 0.15rem 0.5rem;">${load.type}</span></div>
                </div>
                <div class="load-progress">
                  <div class="load-progress-text">${deliveredCount} / ${totalCount} Delivered</div>
                  <div class="load-progress-bar">
                    <div class="load-progress-fill" style="width: ${progressPercent}%"></div>
                  </div>
                </div>
              </div>
              <button class="load-collapse-btn" title="Collapse/Expand">‚ñº</button>
            </div>
            <div class="load-lines">
              <div class="load-line" style="background: var(--helena-green); color: white; font-weight: 600; font-size: 0.8rem;">
                <div>Load #</div>
                <div>Release #</div>
                <div>Assigned To</div>
                <div>Received</div>
                <div>Unload Req</div>
                <div>Delivered</div>
              </div>
              ${load.loadLines.map(line => `
                <div class="load-line">
                  <div class="load-line-number">Load ${line.lineNumber}</div>
                  <div class="load-line-release">${line.releaseNumber || '<em style="color: var(--text-secondary);">--</em>'}</div>
                  <div class="load-line-status">
                    <select onchange="window.updateLoadLineStatus('${load.id}', ${line.lineNumber}, 'assignedTo', this.value)">
                      ${assignedOptions.length > 0
                        ? `<option value="">--</option>` + assignedOptions.map(opt => `<option value="${opt.name}" ${line.assignedTo === opt.name ? 'selected' : ''}>${opt.name}</option>`).join('')
                        : `<option value="">--</option>`}
                    </select>
                  </div>
                  <div class="load-line-status">
                    <input type="checkbox" ${line.receivedIn ? 'checked' : ''} onchange="window.updateLoadLineStatus('${load.id}', ${line.lineNumber}, 'receivedIn', this.checked)" title="Received In">
                  </div>
                  <div class="load-line-status">
                    <input type="checkbox" ${line.unloadRequested ? 'checked' : ''} onchange="window.updateLoadLineStatus('${load.id}', ${line.lineNumber}, 'unloadRequested', this.checked)" title="Unload Requested">
                  </div>
                  <div class="load-line-status delivered">
                    <input type="checkbox" ${line.delivered ? 'checked' : ''} onchange="window.updateLoadLineStatus('${load.id}', ${line.lineNumber}, 'delivered', this.checked)" title="Delivered">
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="load-actions">
              ${status !== 'complete' ? `<button class="btn btn-small btn-primary" onclick="window.completeLoad('${load.id}')">‚úì Complete</button>` : ''}
              <button class="btn btn-small" onclick="window.openEditLoadModal('${load.id}')">Edit</button>
              <button class="btn btn-small" onclick="window.deleteLoad('${load.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function getLoadStatus(load) {
      const deliveredCount = load.loadLines.filter(l => l.delivered).length;
      const totalCount = load.loadLines.length;

      if (deliveredCount === 0) return 'open';
      if (deliveredCount === totalCount) return 'complete';
      return 'partial';
    }

    window.updateLoadLineStatus = async function(loadId, lineNumber, field, value) {
      const load = loads.find(l => l.id === loadId);
      if (!load) return;

      const loadLine = load.loadLines.find(l => l.lineNumber === lineNumber);
      if (!loadLine) return;

      loadLine[field] = value;

      // If marking receivedIn as checked, also check unloadRequested
      if (field === 'receivedIn' && value) {
        loadLine.unloadRequested = true;
      }

      try {
        await updateDoc(doc(db, 'loads', loadId), {
          loadLines: load.loadLines
        });
        await loadData(false);
        renderLoads();
      } catch (error) {
        console.error('Error updating load status:', error);
        showToast('Error updating status. Please try again.', 'error');
      }
    }

    window.openEditLoadModal = function(loadId) {
      const load = loads.find(l => l.id === loadId);
      if (!load) return;

      document.getElementById('editLoadId').value = loadId;
      document.getElementById('editLoadPartNumber').textContent = load.partNumber;
      document.getElementById('editLoadDescription').textContent = load.description;
      document.getElementById('editLoadType').textContent = load.type + ' Fertilizer';

      renderEditLoadLines(load);

      document.getElementById('editLoadModal').classList.add('active');
    }

    function renderEditLoadLines(load) {
      const container = document.getElementById('editReleaseFieldsContainer');

      const assignedOptionsHTML = assignedOptions.length > 0
        ? `<option value="">--</option>` + assignedOptions.map(opt => `<option value="${opt.name}">${opt.name}</option>`).join('')
        : `<option value="">--</option>`;

      container.innerHTML = load.loadLines.map(line => `
        <div class="edit-load-line" data-line-number="${line.lineNumber}">
          <div class="load-line-number">Load ${line.lineNumber}</div>
          <input type="text" value="${line.releaseNumber || ''}" placeholder="Release number" class="edit-release-input">
          <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
            <select class="edit-assigned-select" style="padding: 0.25rem; font-size: 0.85rem;">
              ${assignedOptions.length > 0
                ? `<option value="">--</option>` + assignedOptions.map(opt => `<option value="${opt.name}" ${line.assignedTo === opt.name ? 'selected' : ''}>${opt.name}</option>`).join('')
                : `<option value="">--</option>`}
            </select>
          </label>
          <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
            <input type="checkbox" ${line.receivedIn ? 'checked' : ''} class="edit-received-input"> Received
          </label>
          <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
            <input type="checkbox" ${line.unloadRequested ? 'checked' : ''} class="edit-unload-input"> Unload
          </label>
          <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
            <input type="checkbox" ${line.delivered ? 'checked' : ''} class="edit-delivered-input"> Delivered
          </label>
          <button type="button" class="remove-line-btn" onclick="this.parentElement.remove()">√ó</button>
        </div>
      `).join('');
    }

    window.addLoadLine = function() {
      const container = document.getElementById('editReleaseFieldsContainer');
      const existingLines = container.querySelectorAll('.edit-load-line');
      const nextLineNumber = existingLines.length + 1;

      const newLine = document.createElement('div');
      newLine.className = 'edit-load-line';
      newLine.dataset.lineNumber = nextLineNumber;
      newLine.innerHTML = `
        <div class="load-line-number">Load ${nextLineNumber}</div>
        <input type="text" value="" placeholder="Release number" class="edit-release-input">
        <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
          <select class="edit-assigned-select" style="padding: 0.25rem; font-size: 0.85rem;">
            ${assignedOptions.length > 0
              ? `<option value="">--</option>` + assignedOptions.map(opt => `<option value="${opt.name}">${opt.name}</option>`).join('')
              : `<option value="">--</option>`}
          </select>
        </label>
        <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
          <input type="checkbox" class="edit-received-input"> Received
        </label>
        <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
          <input type="checkbox" class="edit-unload-input"> Unload
        </label>
        <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.85rem;">
          <input type="checkbox" class="edit-delivered-input"> Delivered
        </label>
        <button type="button" class="remove-line-btn" onclick="this.parentElement.remove()">√ó</button>
      `;
      container.appendChild(newLine);
    }

    window.updateLoad = async function(event) {
      event.preventDefault();

      const loadId = document.getElementById('editLoadId').value;
      const container = document.getElementById('editReleaseFieldsContainer');
      const lineElements = container.querySelectorAll('.edit-load-line');

      if (lineElements.length === 0) {
        showToast('At least one load line is required', 'error');
        return;
      }

      const loadLines = Array.from(lineElements).map((el, index) => ({
        lineNumber: index + 1,
        releaseNumber: el.querySelector('.edit-release-input').value.trim(),
        assignedTo: el.querySelector('.edit-assigned-select')?.value || '',
        receivedIn: el.querySelector('.edit-received-input')?.checked || false,
        unloadRequested: el.querySelector('.edit-unload-input')?.checked || false,
        delivered: el.querySelector('.edit-delivered-input').checked
      }));

      showLoading('Updating load...');

      try {
        await updateDoc(doc(db, 'loads', loadId), {
          loadLines: loadLines
        });
        await loadData(false);
        hideLoading();
        showToast('Load updated successfully');
        closeModal('editLoadModal');
        renderLoads();
      } catch (error) {
        console.error('Error updating load:', error);
        hideLoading();
        showToast('Error updating load. Please try again.', 'error');
      }
    }

    window.deleteLoad = async function(loadId) {
      if (!confirm('Are you sure you want to delete this load request?')) return;

      showLoading('Deleting load...');

      try {
        await deleteDoc(doc(db, 'loads', loadId));
        await loadData(false);
        hideLoading();
        showToast('Load deleted successfully');
        renderLoads();
      } catch (error) {
        console.error('Error deleting load:', error);
        hideLoading();
        showToast('Error deleting load. Please try again.', 'error');
      }
    }

    window.completeLoad = async function(loadId) {
      if (!confirm('Mark all lines as delivered and complete this load?')) return;

      const load = loads.find(l => l.id === loadId);
      if (!load) return;

      // Mark all lines as delivered
      const updatedLines = load.loadLines.map(line => ({
        ...line,
        delivered: true,
        receivedIn: true,
        unloadRequested: true
      }));

      showLoading('Completing load...');

      try {
        await updateDoc(doc(db, 'loads', loadId), {
          loadLines: updatedLines
        });
        await loadData(false);
        hideLoading();
        showToast('Load completed successfully');
        renderLoads();
      } catch (error) {
        console.error('Error completing load:', error);
        hideLoading();
        showToast('Error completing load. Please try again.', 'error');
      }
    }

    // ASSIGNED OPTIONS MANAGEMENT
    window.openAssignedOptionsModal = function() {
      renderAssignedOptions();
      document.getElementById('assignedOptionsModal').classList.add('active');
    }

    function renderAssignedOptions() {
      const container = document.getElementById('assignedOptionsList');

      if (assignedOptions.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No options added yet.</p>';
        return;
      }

      container.innerHTML = assignedOptions.map(opt => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
          <span>${opt.name}</span>
          <button class="btn btn-small" onclick="deleteAssignedOption('${opt.id}')" style="background: #dc3545; color: white;">√ó</button>
        </div>
      `).join('');
    }

    window.addAssignedOption = async function() {
      const input = document.getElementById('newAssignedOption');
      const name = input.value.trim();

      if (!name) {
        showToast('Please enter an option name', 'error');
        return;
      }

      // Check for duplicate
      if (assignedOptions.some(opt => opt.name.toLowerCase() === name.toLowerCase())) {
        showToast('This option already exists', 'error');
        return;
      }

      try {
        await addDoc(collection(db, 'assignedOptions'), { name });
        await loadData(false);
        renderAssignedOptions();
        renderLoads();
        input.value = '';
        showToast('Option added successfully');
      } catch (error) {
        console.error('Error adding option:', error);
        showToast('Error adding option. Please try again.', 'error');
      }
    }

    window.deleteAssignedOption = async function(optionId) {
      if (!confirm('Are you sure you want to delete this option?')) return;

      try {
        await deleteDoc(doc(db, 'assignedOptions', optionId));
        await loadData(false);
        renderAssignedOptions();
        renderLoads();
        showToast('Option deleted successfully');
      } catch (error) {
        console.error('Error deleting option:', error);
        showToast('Error deleting option. Please try again.', 'error');
      }
    }

    // LOAD COLLAPSE/EXPAND FUNCTIONS
    window.toggleLoadCollapse = function(loadId) {
      if (collapsedLoads.has(loadId)) {
        collapsedLoads.delete(loadId);
      } else {
        collapsedLoads.add(loadId);
      }
      renderLoads();
    }

    window.toggleAllLoads = function() {
      const btn = document.getElementById('collapseAllBtn');
      const allCollapsed = loads.every(l => collapsedLoads.has(l.id));

      if (allCollapsed) {
        // Expand all
        collapsedLoads.clear();
        btn.textContent = 'Collapse All';
      } else {
        // Collapse all
        loads.forEach(l => collapsedLoads.add(l.id));
        btn.textContent = 'Expand All';
      }
      renderLoads();
    }

    // TASKS FUNCTIONS
    function getFrequencyLabel(interval) {
      switch (interval) {
        case 1: return 'Daily';
        case 7: return 'Weekly';
        case 14: return 'Bi-Weekly';
        case 30: return 'Monthly';
        default: return `Every ${interval} days`;
      }
    }

    // Helper to parse date string as local date (avoids timezone issues)
    function parseLocalDate(dateString) {
      if (!dateString) return null;
      const [year, month, day] = dateString.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatLocalDate(dateString) {
      const date = parseLocalDate(dateString);
      return date ? date.toLocaleDateString() : '-';
    }

    function populateTaskOwnerFilter() {
      const filterSelect = document.getElementById('taskOwnerFilter');
      if (!filterSelect) return;

      // Get unique owners
      const owners = [...new Set(tasks.map(t => t.owner).filter(Boolean))].sort();

      filterSelect.innerHTML = '<option value="">All Owners</option>' +
        owners.map(owner => `<option value="${owner}">${owner}</option>`).join('');
    }

    window.openAddTaskModal = function() {
      document.getElementById('addTaskForm').reset();
      document.getElementById('recurringIntervalGroup').style.display = 'none';
      document.getElementById('taskDueDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('addTaskModal').classList.add('active');
    }

    window.toggleRecurringFields = function() {
      const taskType = document.getElementById('taskType').value;
      const intervalGroup = document.getElementById('recurringIntervalGroup');
      intervalGroup.style.display = taskType === 'recurring' ? 'block' : 'none';
    }

    window.toggleEditRecurringFields = function() {
      const taskType = document.getElementById('editTaskType').value;
      const intervalGroup = document.getElementById('editRecurringIntervalGroup');
      const lastCompletedGroup = document.getElementById('editLastCompletedGroup');
      intervalGroup.style.display = taskType === 'recurring' ? 'block' : 'none';
      lastCompletedGroup.style.display = taskType === 'recurring' ? 'block' : 'none';
    }

    window.addTask = async function(event) {
      event.preventDefault();

      const taskType = document.getElementById('taskType').value;
      const newTask = {
        name: document.getElementById('taskName').value.trim(),
        type: taskType,
        interval: taskType === 'recurring' ? parseInt(document.getElementById('taskFrequency').value) : null,
        owner: document.getElementById('taskOwner').value.trim(),
        dueDate: document.getElementById('taskDueDate').value,
        lastCompleted: null,
        notes: document.getElementById('taskNotes').value.trim(),
        createdAt: new Date().toISOString()
      };

      showLoading('Adding task...');

      try {
        await addDoc(collection(db, 'tasks'), newTask);
        await loadData(false);
        hideLoading();
        showToast('Task added successfully');
        document.getElementById('addTaskForm').reset();
        closeModal('addTaskModal');
        renderTasks();
      } catch (error) {
        console.error('Error adding task:', error);
        hideLoading();
        showToast('Error adding task. Please try again.', 'error');
      }
    }

    window.renderTasks = function() {
      const tbody = document.getElementById('tasksTableBody');
      const ownerFilter = document.getElementById('taskOwnerFilter')?.value || '';
      const typeFilter = document.getElementById('taskTypeFilter')?.value || '';
      const sortBy = document.getElementById('taskSortBy')?.value || 'dueDate';

      let filteredTasks = [...tasks];

      // Apply filters
      if (ownerFilter) {
        filteredTasks = filteredTasks.filter(t => t.owner === ownerFilter);
      }
      if (typeFilter) {
        filteredTasks = filteredTasks.filter(t => t.type === typeFilter);
      }

      // Sort tasks
      filteredTasks.sort((a, b) => {
        if (sortBy === 'owner') {
          return (a.owner || '').localeCompare(b.owner || '');
        } else if (sortBy === 'task') {
          return (a.name || '').localeCompare(b.name || '');
        } else {
          // Sort by due date, with overdue first
          const aDate = new Date(a.dueDate);
          const bDate = new Date(b.dueDate);
          return aDate - bDate;
        }
      });

      if (filteredTasks.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
              <div>No tasks found. Add a task to get started.</div>
            </td>
          </tr>
        `;
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const weekFromNow = new Date(today);
      weekFromNow.setDate(weekFromNow.getDate() + 7);

      tbody.innerHTML = filteredTasks.map(task => {
        const dueDate = parseLocalDate(task.dueDate);

        let rowClass = '';
        let statusBadge = '';

        if (dueDate < today) {
          rowClass = 'task-overdue';
          statusBadge = '<span class="task-status-badge overdue">Overdue</span>';
        } else if (dueDate <= weekFromNow) {
          rowClass = 'task-due-soon';
          statusBadge = '<span class="task-status-badge due-soon">Due Soon</span>';
        } else {
          statusBadge = '<span class="task-status-badge on-track">On Track</span>';
        }

        return `
          <tr class="${rowClass}">
            <td>
              <div class="task-name">${task.name}</div>
              ${task.notes ? `<div style="font-size: 0.8rem; color: var(--text-secondary);">${task.notes.substring(0, 50)}${task.notes.length > 50 ? '...' : ''}</div>` : ''}
            </td>
            <td>
              <span class="task-type-badge ${task.type}">${task.type === 'recurring' ? 'Recurring' : 'Single'}</span>
              ${task.type === 'recurring' && task.interval ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${getFrequencyLabel(task.interval)}</div>` : ''}
            </td>
            <td>${task.owner || '-'}</td>
            <td>${formatLocalDate(task.dueDate)}</td>
            <td>${task.lastCompleted ? formatLocalDate(task.lastCompleted) : '-'}</td>
            <td>${statusBadge}</td>
            <td>
              <div class="task-actions">
                <button class="btn btn-small btn-primary" onclick="window.completeTask('${task.id}')">‚úì Complete</button>
                <button class="btn btn-small" onclick="window.openEditTaskModal('${task.id}')">Edit</button>
                <button class="btn btn-small" onclick="window.deleteTask('${task.id}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.openEditTaskModal = function(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      document.getElementById('editTaskId').value = taskId;
      document.getElementById('editTaskName').value = task.name;
      document.getElementById('editTaskType').value = task.type;
      document.getElementById('editTaskFrequency').value = task.interval || 30;
      document.getElementById('editTaskOwner').value = task.owner;
      document.getElementById('editTaskDueDate').value = task.dueDate;
      document.getElementById('editTaskLastCompleted').value = task.lastCompleted || '';
      document.getElementById('editTaskNotes').value = task.notes || '';

      toggleEditRecurringFields();

      document.getElementById('editTaskModal').classList.add('active');
    }

    window.updateTask = async function(event) {
      event.preventDefault();

      const taskId = document.getElementById('editTaskId').value;
      const taskType = document.getElementById('editTaskType').value;

      const updatedTask = {
        name: document.getElementById('editTaskName').value.trim(),
        type: taskType,
        interval: taskType === 'recurring' ? parseInt(document.getElementById('editTaskFrequency').value) : null,
        owner: document.getElementById('editTaskOwner').value.trim(),
        dueDate: document.getElementById('editTaskDueDate').value,
        lastCompleted: document.getElementById('editTaskLastCompleted').value || null,
        notes: document.getElementById('editTaskNotes').value.trim()
      };

      showLoading('Updating task...');

      try {
        await updateDoc(doc(db, 'tasks', taskId), updatedTask);
        await loadData(false);
        hideLoading();
        showToast('Task updated successfully');
        closeModal('editTaskModal');
        renderTasks();
      } catch (error) {
        console.error('Error updating task:', error);
        hideLoading();
        showToast('Error updating task. Please try again.', 'error');
      }
    }

    window.completeTask = async function(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      const today = new Date().toISOString().split('T')[0];

      let updateData = {
        lastCompleted: today
      };

      // For recurring tasks, calculate new due date
      if (task.type === 'recurring' && task.interval) {
        const newDueDate = new Date();
        newDueDate.setDate(newDueDate.getDate() + task.interval);
        updateData.dueDate = newDueDate.toISOString().split('T')[0];
        showToast(`Task completed! Next due: ${newDueDate.toLocaleDateString()}`);
      } else {
        // For single tasks, mark as completed by setting a past due date flag or we can delete
        if (confirm('This is a one-time task. Mark as complete and remove from list?')) {
          showLoading('Completing task...');
          try {
            await deleteDoc(doc(db, 'tasks', taskId));
            await loadData(false);
            hideLoading();
            showToast('Task completed and removed');
            renderTasks();
          } catch (error) {
            console.error('Error completing task:', error);
            hideLoading();
            showToast('Error completing task. Please try again.', 'error');
          }
          return;
        } else {
          return;
        }
      }

      showLoading('Completing task...');

      try {
        await updateDoc(doc(db, 'tasks', taskId), updateData);
        await loadData(false);
        hideLoading();
        renderTasks();
      } catch (error) {
        console.error('Error completing task:', error);
        hideLoading();
        showToast('Error completing task. Please try again.', 'error');
      }
    }

    window.deleteTask = async function(taskId) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      showLoading('Deleting task...');

      try {
        await deleteDoc(doc(db, 'tasks', taskId));
        await loadData(false);
        hideLoading();
        showToast('Task deleted successfully');
        renderTasks();
      } catch (error) {
        console.error('Error deleting task:', error);
        hideLoading();
        showToast('Error deleting task. Please try again.', 'error');
      }
    }

    window.printTaskReport = function(reportType) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const weekFromNow = new Date(today);
      weekFromNow.setDate(weekFromNow.getDate() + 7);

      let filteredTasks = [...tasks];
      let reportTitle = 'All Tasks';

      if (reportType === 'urgent') {
        filteredTasks = filteredTasks.filter(task => {
          const dueDate = parseLocalDate(task.dueDate);
          return dueDate <= weekFromNow;
        });
        reportTitle = 'Urgent Tasks - Past Due & Due This Week';
      }

      // Sort by due date
      filteredTasks.sort((a, b) => parseLocalDate(a.dueDate) - parseLocalDate(b.dueDate));

      // Apply current owner filter if set
      const ownerFilter = document.getElementById('taskOwnerFilter')?.value;
      if (ownerFilter) {
        filteredTasks = filteredTasks.filter(t => t.owner === ownerFilter);
        reportTitle += ` - ${ownerFilter}`;
      }

      let printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>${reportTitle}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 11px; }
            h1 { color: #215530; font-size: 18px; margin-bottom: 5px; }
            .date { color: #666; margin-bottom: 15px; }
            table { width: 100%; border-collapse: collapse; }
            th { background: #215530; color: white; padding: 8px; text-align: left; font-size: 10px; }
            td { padding: 8px; border-bottom: 1px solid #ddd; }
            tr.overdue { background: #ffebee; color: #c62828; }
            tr.due-soon { background: #fff8e1; color: #f57c00; }
            .status { font-weight: bold; }
            .status.overdue { color: #c62828; }
            .status.due-soon { color: #f57c00; }
            .status.on-track { color: #2e7d32; }
            @media print {
              body { margin: 0; }
            }
          </style>
        </head>
        <body>
          <h1>Helena Agri-Enterprises - ${reportTitle}</h1>
          <div class="date">Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
          <table>
            <thead>
              <tr>
                <th>Task</th>
                <th>Type</th>
                <th>Owner</th>
                <th>Due Date</th>
                <th>Last Completed</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
      `;

      filteredTasks.forEach(task => {
        const dueDate = parseLocalDate(task.dueDate);

        let rowClass = '';
        let status = '';
        let statusClass = '';

        if (dueDate < today) {
          rowClass = 'overdue';
          status = 'OVERDUE';
          statusClass = 'overdue';
        } else if (dueDate <= weekFromNow) {
          rowClass = 'due-soon';
          status = 'Due Soon';
          statusClass = 'due-soon';
        } else {
          status = 'On Track';
          statusClass = 'on-track';
        }

        printHTML += `
          <tr class="${rowClass}">
            <td><strong>${task.name}</strong>${task.notes ? '<br><small>' + task.notes.substring(0, 100) + '</small>' : ''}</td>
            <td>${task.type === 'recurring' ? 'Recurring' + (task.interval ? ' (' + getFrequencyLabel(task.interval) + ')' : '') : 'Single'}</td>
            <td>${task.owner || '-'}</td>
            <td>${formatLocalDate(task.dueDate)}</td>
            <td>${task.lastCompleted ? formatLocalDate(task.lastCompleted) : '-'}</td>
            <td><span class="status ${statusClass}">${status}</span></td>
          </tr>
        `;
      });

      printHTML += `
            </tbody>
          </table>
          <div style="margin-top: 20px; font-size: 10px; color: #666;">
            Total Tasks: ${filteredTasks.length}
          </div>
        </body>
        </html>
      `;

      const win = window.open('', '_blank');
      win.document.write(printHTML);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 250);
    }

    // ORDERS FUNCTIONS
    function populateOrderAssignedFilter() {
      const filterSelect = document.getElementById('orderAssignedFilter');
      if (!filterSelect) return;

      const assigned = [...new Set(orders.map(o => o.assigned).filter(Boolean))].sort();

      filterSelect.innerHTML = '<option value="">All Assigned</option>' +
        assigned.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    function getUomOptionsHTML(selectedValue = '') {
      return unitOfMeasures.map(u =>
        `<option value="${u.name}" ${u.name === selectedValue ? 'selected' : ''}>${u.name}</option>`
      ).join('');
    }

    window.openAddOrderModal = function() {
      document.getElementById('addOrderForm').reset();
      document.getElementById('orderServiceDatesGroup').style.display = 'none';
      document.getElementById('orderDueDate').value = new Date().toISOString().split('T')[0];

      // Initialize with one item row
      const container = document.getElementById('orderItemsContainer');
      container.innerHTML = `
        <div class="order-item-row" data-item="1">
          <input type="text" placeholder="Product/Service" class="item-description" required style="flex: 2;">
          <input type="number" placeholder="Qty" class="item-qty" min="0.01" step="0.01" value="1" required style="width: 80px;">
          <select class="item-uom" style="width: 100px;">${getUomOptionsHTML()}</select>
          <button type="button" class="btn btn-small" onclick="removeOrderItemRow(this)" style="background: #dc3545; color: white;">√ó</button>
        </div>
      `;

      document.getElementById('addOrderModal').classList.add('active');
    }

    window.addOrderItemRow = function() {
      const container = document.getElementById('orderItemsContainer');
      const itemCount = container.querySelectorAll('.order-item-row').length + 1;

      const newRow = document.createElement('div');
      newRow.className = 'order-item-row';
      newRow.dataset.item = itemCount;
      newRow.innerHTML = `
        <input type="text" placeholder="Product/Service" class="item-description" required style="flex: 2;">
        <input type="number" placeholder="Qty" class="item-qty" min="0.01" step="0.01" value="1" required style="width: 80px;">
        <select class="item-uom" style="width: 100px;">${getUomOptionsHTML()}</select>
        <button type="button" class="btn btn-small" onclick="removeOrderItemRow(this)" style="background: #dc3545; color: white;">√ó</button>
      `;
      container.appendChild(newRow);
    }

    window.removeOrderItemRow = function(btn) {
      const container = btn.closest('#orderItemsContainer') || btn.closest('#editOrderItemsContainer');
      if (container.querySelectorAll('.order-item-row').length > 1) {
        btn.closest('.order-item-row').remove();
      } else {
        showToast('At least one item is required', 'error');
      }
    }

    window.toggleOrderServiceFields = function() {
      const orderType = document.getElementById('orderType').value;
      document.getElementById('orderServiceDatesGroup').style.display = orderType === 'service' ? 'block' : 'none';
    }

    window.toggleEditOrderServiceFields = function() {
      const orderType = document.getElementById('editOrderType').value;
      document.getElementById('editOrderServiceDatesGroup').style.display = orderType === 'service' ? 'block' : 'none';
    }

    window.addOrder = async function(event) {
      event.preventDefault();

      const orderType = document.getElementById('orderType').value;

      // Collect all items
      const itemRows = document.querySelectorAll('#orderItemsContainer .order-item-row');
      const items = Array.from(itemRows).map((row, index) => ({
        lineNumber: index + 1,
        description: row.querySelector('.item-description').value.trim(),
        qty: parseFloat(row.querySelector('.item-qty').value),
        uom: row.querySelector('.item-uom').value,
        qtyDelivered: 0
      }));

      if (items.length === 0 || items.some(i => !i.description)) {
        showToast('Please add at least one item with a description', 'error');
        return;
      }

      const newOrder = {
        customer: document.getElementById('orderCustomer').value.trim(),
        orderType: orderType,
        items: items,
        dueDate: document.getElementById('orderDueDate').value,
        startDate: orderType === 'service' ? document.getElementById('orderStartDate').value : null,
        finishDate: orderType === 'service' ? document.getElementById('orderFinishDate').value : null,
        assigned: document.getElementById('orderAssigned').value.trim(),
        notes: document.getElementById('orderNotes').value.trim(),
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      showLoading('Creating order...');

      try {
        await addDoc(collection(db, 'orders'), newOrder);
        await loadData(false);
        hideLoading();
        showToast('Order created successfully');
        document.getElementById('addOrderForm').reset();
        closeModal('addOrderModal');
        renderOrders();
      } catch (error) {
        console.error('Error creating order:', error);
        hideLoading();
        showToast('Error creating order. Please try again.', 'error');
      }
    }

    window.renderOrders = function() {
      const tbody = document.getElementById('ordersTableBody');
      const assignedFilter = document.getElementById('orderAssignedFilter')?.value || '';
      const typeFilter = document.getElementById('orderTypeFilter')?.value || '';
      const statusFilter = document.getElementById('orderStatusFilter')?.value || 'active';

      let filteredOrders = [...orders];

      // Apply assigned filter
      if (assignedFilter) {
        filteredOrders = filteredOrders.filter(o => o.assigned === assignedFilter);
      }

      // Apply type filter
      if (typeFilter) {
        filteredOrders = filteredOrders.filter(o => o.orderType === typeFilter);
      }

      // Apply status filter
      if (statusFilter) {
        if (statusFilter === 'active') {
          filteredOrders = filteredOrders.filter(o => o.status !== 'complete');
        } else {
          filteredOrders = filteredOrders.filter(o => o.status === statusFilter);
        }
      }

      // Sort by due date
      filteredOrders.sort((a, b) => parseLocalDate(a.dueDate) - parseLocalDate(b.dueDate));

      if (filteredOrders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
              <div>No orders found. Create a new order to get started.</div>
            </td>
          </tr>
        `;
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      tbody.innerHTML = filteredOrders.map(order => {
        const dueDate = parseLocalDate(order.dueDate);
        const isOverdue = dueDate < today && order.status !== 'complete';
        const isComplete = order.status === 'complete';

        let rowClass = '';
        if (isOverdue) rowClass = 'order-overdue';
        if (isComplete) rowClass = 'order-complete';

        const statusLabel = {
          'pending': 'Pending',
          'in_progress': 'In Progress',
          'complete': 'Complete'
        };

        // Handle both old single-item orders and new multi-item orders
        const items = order.items || [{ description: order.productService, qty: order.qty, uom: order.uom || 'Each', qtyDelivered: order.qtyDelivered || 0 }];
        const itemsDisplay = items.map(item =>
          `<div style="font-size: 0.85rem;">${item.description}</div>`
        ).join('');
        const qtyDisplay = items.map(item =>
          `<div style="font-size: 0.85rem;">${item.qty} ${item.uom || 'Each'}${item.qtyDelivered ? ` <span style="color: var(--success);">(${item.qtyDelivered} del)</span>` : ''}</div>`
        ).join('');

        return `
          <tr class="${rowClass}">
            <td>
              <input type="checkbox" class="order-checkbox" data-order-id="${order.id}"
                ${selectedOrders.has(order.id) ? 'checked' : ''}
                onchange="toggleOrderSelection('${order.id}')">
            </td>
            <td><strong>${order.customer}</strong></td>
            <td><span class="order-type-badge ${order.orderType}">${order.orderType === 'product' ? 'Product' : 'Service'}</span></td>
            <td>
              ${itemsDisplay}
              ${order.orderType === 'service' && order.startDate ? `<div style="font-size: 0.75rem; color: var(--text-secondary);">${formatLocalDate(order.startDate)} - ${order.finishDate ? formatLocalDate(order.finishDate) : 'TBD'}</div>` : ''}
            </td>
            <td>${qtyDisplay}</td>
            <td>${formatLocalDate(order.dueDate)}</td>
            <td>${order.assigned || '-'}</td>
            <td><span class="order-status-badge ${order.status}">${statusLabel[order.status] || order.status}</span></td>
            <td>
              <div class="order-actions">
                ${order.status !== 'complete' ? `<button class="btn btn-small btn-primary" onclick="window.completeOrder('${order.id}')">‚úì</button>` : ''}
                <button class="btn btn-small" onclick="window.openEditOrderModal('${order.id}')">Edit</button>
                <button class="btn btn-small" onclick="window.deleteOrder('${order.id}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    window.toggleOrderSelection = function(orderId) {
      if (selectedOrders.has(orderId)) {
        selectedOrders.delete(orderId);
      } else {
        selectedOrders.add(orderId);
      }
      // Update select all checkbox state
      const selectAll = document.getElementById('selectAllOrders');
      if (selectAll) {
        const visibleOrders = document.querySelectorAll('.order-checkbox');
        const allChecked = Array.from(visibleOrders).every(cb => cb.checked);
        selectAll.checked = allChecked && visibleOrders.length > 0;
      }
    }

    window.toggleSelectAllOrders = function() {
      const selectAll = document.getElementById('selectAllOrders');
      const checkboxes = document.querySelectorAll('.order-checkbox');

      checkboxes.forEach(cb => {
        const orderId = cb.dataset.orderId;
        if (selectAll.checked) {
          selectedOrders.add(orderId);
          cb.checked = true;
        } else {
          selectedOrders.delete(orderId);
          cb.checked = false;
        }
      });
    }

    window.addEditOrderItemRow = function() {
      const container = document.getElementById('editOrderItemsContainer');
      const itemCount = container.querySelectorAll('.order-item-row').length + 1;

      const newRow = document.createElement('div');
      newRow.className = 'order-item-row';
      newRow.dataset.item = itemCount;
      newRow.innerHTML = `
        <input type="text" placeholder="Product/Service" class="item-description" required style="flex: 2;">
        <input type="number" placeholder="Qty Ordered" class="item-qty" min="0.01" step="0.01" value="1" required style="width: 80px;">
        <select class="item-uom" style="width: 90px;">${getUomOptionsHTML()}</select>
        <input type="number" placeholder="Delivered" class="item-qty-delivered" min="0" step="0.01" value="0" style="width: 80px;">
        <button type="button" class="btn btn-small" onclick="removeOrderItemRow(this)" style="background: #dc3545; color: white;">√ó</button>
      `;
      container.appendChild(newRow);
    }

    window.openEditOrderModal = function(orderId) {
      const order = orders.find(o => o.id === orderId);
      if (!order) return;

      document.getElementById('editOrderId').value = orderId;
      document.getElementById('editOrderCustomer').value = order.customer;
      document.getElementById('editOrderType').value = order.orderType;
      document.getElementById('editOrderDueDate').value = order.dueDate;
      document.getElementById('editOrderStartDate').value = order.startDate || '';
      document.getElementById('editOrderFinishDate').value = order.finishDate || '';
      document.getElementById('editOrderAssigned').value = order.assigned;
      document.getElementById('editOrderNotes').value = order.notes || '';
      document.getElementById('editOrderStatus').value = order.status;

      // Populate items - support both old and new format
      const items = order.items || [{ description: order.productService, qty: order.qty, uom: order.uom || 'Each', qtyDelivered: order.qtyDelivered || 0 }];
      const container = document.getElementById('editOrderItemsContainer');
      container.innerHTML = items.map((item, index) => `
        <div class="order-item-row" data-item="${index + 1}">
          <input type="text" placeholder="Product/Service" class="item-description" value="${item.description || ''}" required style="flex: 2;">
          <input type="number" placeholder="Qty Ordered" class="item-qty" min="0.01" step="0.01" value="${item.qty || 1}" required style="width: 80px;">
          <select class="item-uom" style="width: 90px;">${getUomOptionsHTML(item.uom)}</select>
          <input type="number" placeholder="Delivered" class="item-qty-delivered" min="0" step="0.01" value="${item.qtyDelivered || 0}" style="width: 80px;">
          <button type="button" class="btn btn-small" onclick="removeOrderItemRow(this)" style="background: #dc3545; color: white;">√ó</button>
        </div>
      `).join('');

      toggleEditOrderServiceFields();

      document.getElementById('editOrderModal').classList.add('active');
    }

    window.updateOrder = async function(event) {
      event.preventDefault();

      const orderId = document.getElementById('editOrderId').value;
      const orderType = document.getElementById('editOrderType').value;

      // Collect all items
      const itemRows = document.querySelectorAll('#editOrderItemsContainer .order-item-row');
      const items = Array.from(itemRows).map((row, index) => ({
        lineNumber: index + 1,
        description: row.querySelector('.item-description').value.trim(),
        qty: parseFloat(row.querySelector('.item-qty').value),
        uom: row.querySelector('.item-uom').value,
        qtyDelivered: parseFloat(row.querySelector('.item-qty-delivered').value) || 0
      }));

      if (items.length === 0 || items.some(i => !i.description)) {
        showToast('Please add at least one item with a description', 'error');
        return;
      }

      const updatedOrder = {
        customer: document.getElementById('editOrderCustomer').value.trim(),
        orderType: orderType,
        items: items,
        dueDate: document.getElementById('editOrderDueDate').value,
        startDate: orderType === 'service' ? document.getElementById('editOrderStartDate').value : null,
        finishDate: orderType === 'service' ? document.getElementById('editOrderFinishDate').value : null,
        assigned: document.getElementById('editOrderAssigned').value.trim(),
        notes: document.getElementById('editOrderNotes').value.trim(),
        status: document.getElementById('editOrderStatus').value
      };

      showLoading('Updating order...');

      try {
        await updateDoc(doc(db, 'orders', orderId), updatedOrder);
        await loadData(false);
        hideLoading();
        showToast('Order updated successfully');
        closeModal('editOrderModal');
        renderOrders();
      } catch (error) {
        console.error('Error updating order:', error);
        hideLoading();
        showToast('Error updating order. Please try again.', 'error');
      }
    }

    window.completeOrder = async function(orderId) {
      if (!confirm('Mark this order as complete?')) return;

      showLoading('Completing order...');

      try {
        await updateDoc(doc(db, 'orders', orderId), { status: 'complete' });
        await loadData(false);
        hideLoading();
        showToast('Order completed');
        renderOrders();
      } catch (error) {
        console.error('Error completing order:', error);
        hideLoading();
        showToast('Error completing order. Please try again.', 'error');
      }
    }

    window.deleteOrder = async function(orderId) {
      if (!confirm('Are you sure you want to delete this order?')) return;

      showLoading('Deleting order...');

      try {
        await deleteDoc(doc(db, 'orders', orderId));
        selectedOrders.delete(orderId);
        await loadData(false);
        hideLoading();
        showToast('Order deleted successfully');
        renderOrders();
      } catch (error) {
        console.error('Error deleting order:', error);
        hideLoading();
        showToast('Error deleting order. Please try again.', 'error');
      }
    }

    // UOM MANAGEMENT FUNCTIONS
    window.openUomModal = function() {
      renderUomOptions();
      document.getElementById('uomModal').classList.add('active');
    }

    function renderUomOptions() {
      const container = document.getElementById('uomOptionsList');

      if (unitOfMeasures.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No units added yet.</p>';
        return;
      }

      container.innerHTML = unitOfMeasures.map(uom => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color);">
          <span>${uom.name}</span>
          <button class="btn btn-small" onclick="deleteUomOption('${uom.id}')" style="background: #dc3545; color: white;">√ó</button>
        </div>
      `).join('');
    }

    window.addUomOption = async function() {
      const input = document.getElementById('newUomOption');
      const name = input.value.trim();

      if (!name) {
        showToast('Please enter a unit name', 'error');
        return;
      }

      if (unitOfMeasures.some(u => u.name.toLowerCase() === name.toLowerCase())) {
        showToast('This unit already exists', 'error');
        return;
      }

      try {
        await addDoc(collection(db, 'unitOfMeasures'), { name });
        await loadData(false);
        renderUomOptions();
        input.value = '';
        showToast('Unit added successfully');
      } catch (error) {
        console.error('Error adding unit:', error);
        showToast('Error adding unit. Please try again.', 'error');
      }
    }

    window.deleteUomOption = async function(uomId) {
      if (!confirm('Are you sure you want to delete this unit?')) return;

      try {
        await deleteDoc(doc(db, 'unitOfMeasures', uomId));
        await loadData(false);
        renderUomOptions();
        showToast('Unit deleted successfully');
      } catch (error) {
        console.error('Error deleting unit:', error);
        showToast('Error deleting unit. Please try again.', 'error');
      }
    }

    window.printSelectedOrders = function() {
      if (selectedOrders.size === 0) {
        showToast('Please select at least one order to print', 'error');
        return;
      }

      const selectedOrdersList = orders.filter(o => selectedOrders.has(o.id));

      let printHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Selected Orders Report</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { color: #1a5d1a; border-bottom: 2px solid #1a5d1a; padding-bottom: 10px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th { background: #1a5d1a; color: white; padding: 10px; text-align: left; }
            td { padding: 10px; border-bottom: 1px solid #ddd; }
            tr:nth-child(even) { background: #f9f9f9; }
            .type-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
            .type-badge.product { background: #e3f2fd; color: #1976d2; }
            .type-badge.service { background: #fff3e0; color: #e65100; }
            .status { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
            .status.pending { background: #fff8e1; color: #f57c00; }
            .status.in_progress { background: #e3f2fd; color: #1976d2; }
            .status.complete { background: #4caf50; color: white; }
            .notes { font-size: 11px; color: #666; margin-top: 4px; }
            @media print { body { padding: 0; } }
          </style>
        </head>
        <body>
          <h1>Helena Agri-Enterprises - Orders Report</h1>
          <p>Generated: ${new Date().toLocaleString()}</p>
          <p>Total Orders: ${selectedOrdersList.length}</p>
          <table>
            <thead>
              <tr>
                <th>Customer</th>
                <th>Type</th>
                <th>Product/Service</th>
                <th>Qty</th>
                <th>Due Date</th>
                <th>Assigned</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
      `;

      const statusLabel = { 'pending': 'Pending', 'in_progress': 'In Progress', 'complete': 'Complete' };

      selectedOrdersList.forEach(order => {
        // Handle both old and new format
        const items = order.items || [{ description: order.productService, qty: order.qty, uom: order.uom || 'Each', qtyDelivered: order.qtyDelivered || 0 }];
        const itemsDisplay = items.map(item =>
          `<div>${item.description}: ${item.qty} ${item.uom || 'Each'}${item.qtyDelivered ? ` (${item.qtyDelivered} delivered)` : ''}</div>`
        ).join('');

        printHTML += `
          <tr>
            <td><strong>${order.customer}</strong></td>
            <td><span class="type-badge ${order.orderType}">${order.orderType === 'product' ? 'Product' : 'Service'}</span></td>
            <td>
              ${itemsDisplay}
              ${order.orderType === 'service' && order.startDate ? `<div style="font-size: 11px; color: #666;">${formatLocalDate(order.startDate)} - ${order.finishDate ? formatLocalDate(order.finishDate) : 'TBD'}</div>` : ''}
              ${order.notes ? `<div class="notes">${order.notes}</div>` : ''}
            </td>
            <td>${items.length} item${items.length > 1 ? 's' : ''}</td>
            <td>${formatLocalDate(order.dueDate)}</td>
            <td>${order.assigned || '-'}</td>
            <td><span class="status ${order.status}">${statusLabel[order.status] || order.status}</span></td>
          </tr>
        `;
      });

      printHTML += `
            </tbody>
          </table>
        </body>
        </html>
      `;

      const win = window.open('', '_blank');
      win.document.write(printHTML);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 250);
    }

    // EMAIL DIGEST FUNCTIONS
    window.openEmailDigestModal = function() {
      document.getElementById('digestPreview').style.display = 'none';
      document.getElementById('emailDigestModal').classList.add('active');
    }

    window.generateDigestPreview = function() {
      const days = parseInt(document.getElementById('digestDays').value);
      const preview = document.getElementById('digestPreview');

      const upcomingMaintenance = [];
      const overdueItems = [];
      const pendingIssues = issues.filter(i => i.status === 'Pending');

      equipment.forEach(eq => {
        if (eq.maintenanceItems) {
          eq.maintenanceItems.forEach(item => {
            const { status, daysUntil, nextDue } = getMaintenanceStatus(item, eq);
            if (status === 'danger') {
              overdueItems.push({
                equipment: eq,
                item: item,
                daysUntil: daysUntil,
                nextDue: nextDue
              });
            } else if (daysUntil <= days && daysUntil > 0) {
              upcomingMaintenance.push({
                equipment: eq,
                item: item,
                daysUntil: daysUntil,
                nextDue: nextDue
              });
            }
          });
        }
      });

      // Sort by days until due
      upcomingMaintenance.sort((a, b) => a.daysUntil - b.daysUntil);
      overdueItems.sort((a, b) => a.daysUntil - b.daysUntil);

      let html = `
        <h3 style="color: var(--helena-green); margin-bottom: 1rem;">Helena Agri-Enterprises - Maintenance Digest</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Generated: ${new Date().toLocaleDateString()}</p>
      `;

      if (overdueItems.length > 0) {
        html += `<h4 style="color: var(--danger); margin: 1rem 0 0.5rem;">‚ö†Ô∏è Overdue Maintenance (${overdueItems.length})</h4>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
          <tr style="background: #f8d7da;">
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Equipment</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Maintenance Item</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Days Overdue</th>
          </tr>
          ${overdueItems.map(m => `
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.equipment.equipmentId} - ${m.equipment.name}</td>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.item.name}</td>
              <td style="padding: 0.5rem; border: 1px solid #ddd; color: var(--danger);">${m.daysUntil === -999 ? 'Never Done' : Math.abs(m.daysUntil) + ' days'}</td>
            </tr>
          `).join('')}
        </table>`;
      }

      if (upcomingMaintenance.length > 0) {
        html += `<h4 style="color: var(--warning); margin: 1rem 0 0.5rem;">üìÖ Upcoming Maintenance (${upcomingMaintenance.length})</h4>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
          <tr style="background: #fff3cd;">
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Equipment</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Maintenance Item</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Due In</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Due Date</th>
          </tr>
          ${upcomingMaintenance.map(m => `
            <tr>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.equipment.equipmentId} - ${m.equipment.name}</td>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.item.name}</td>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.daysUntil} days</td>
              <td style="padding: 0.5rem; border: 1px solid #ddd;">${m.nextDue}</td>
            </tr>
          `).join('')}
        </table>`;
      }

      if (pendingIssues.length > 0) {
        html += `<h4 style="color: var(--helena-green); margin: 1rem 0 0.5rem;">üîß Pending Issues (${pendingIssues.length})</h4>
        <table style="width: 100%; border-collapse: collapse;">
          <tr style="background: var(--bg-primary);">
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Equipment</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Issue</th>
            <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Severity</th>
          </tr>
          ${pendingIssues.map(issue => {
            const eq = equipment.find(e => e.id === issue.equipmentId);
            return `
              <tr>
                <td style="padding: 0.5rem; border: 1px solid #ddd;">${eq ? eq.equipmentId : 'Unknown'}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd;">${issue.title}</td>
                <td style="padding: 0.5rem; border: 1px solid #ddd; color: ${issue.severity === 'Critical' ? 'var(--danger)' : 'var(--warning)'};">${issue.severity}</td>
              </tr>
            `;
          }).join('')}
        </table>`;
      }

      if (overdueItems.length === 0 && upcomingMaintenance.length === 0 && pendingIssues.length === 0) {
        html += `<p style="color: var(--success); text-align: center; padding: 2rem;">‚úì All equipment is up to date!</p>`;
      }

      preview.innerHTML = html;
      preview.style.display = 'block';
    }

    window.copyDigestToClipboard = function() {
      const preview = document.getElementById('digestPreview');
      if (preview.style.display === 'none') {
        generateDigestPreview();
      }

      // Create plain text version
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = preview.innerHTML;
      const text = tempDiv.textContent || tempDiv.innerText;

      navigator.clipboard.writeText(text).then(() => {
        showToast('Digest copied to clipboard');
      }).catch(() => {
        showToast('Failed to copy to clipboard', 'error');
      });
    }

    window.sendEmailDigest = function() {
      const email = document.getElementById('digestEmail').value;
      if (!email) {
        showToast('Please enter an email address', 'warning');
        return;
      }

      // Generate digest if not already done
      if (document.getElementById('digestPreview').style.display === 'none') {
        generateDigestPreview();
      }

      // Create mailto link with digest content
      const subject = encodeURIComponent('Helena Agri-Enterprises - Maintenance Digest');
      const preview = document.getElementById('digestPreview');
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = preview.innerHTML;
      const body = encodeURIComponent(tempDiv.textContent || tempDiv.innerText);

      window.open(`mailto:${email}?subject=${subject}&body=${body}`);
      showToast('Opening email client...');
    }

    // EQUIPMENT TIMELINE FUNCTION
    window.viewEquipmentTimeline = function(equipmentId) {
      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;

      // Gather all events
      const events = [];

      // Maintenance history
      if (eq.maintenanceItems) {
        eq.maintenanceItems.forEach(item => {
          if (item.history) {
            item.history.forEach(h => {
              events.push({
                type: 'maintenance',
                date: new Date(h.date || h.completedAt),
                title: item.name,
                description: h.notes || 'Maintenance completed',
                hours: h.hours
              });
            });
          }
        });
      }

      // Issues
      const equipmentIssues = issues.filter(i => i.equipmentId === equipmentId);
      equipmentIssues.forEach(issue => {
        // Support both old 'photo' and new 'photos' fields
        let photos = [];
        if (issue.photos && issue.photos.length > 0) {
          photos = issue.photos;
        } else if (issue.photo) {
          photos = [issue.photo];
        }
        events.push({
          type: issue.severity === 'Critical' ? 'critical' : 'issue',
          date: new Date(issue.createdAt),
          title: issue.title,
          description: issue.notes,
          status: issue.status,
          photos: photos
        });
        if (issue.completedAt) {
          events.push({
            type: 'maintenance',
            date: new Date(issue.completedAt),
            title: `Issue Resolved: ${issue.title}`,
            description: 'Issue marked as complete'
          });
        }
      });

      // Location history
      const equipmentLocations = locations.filter(l => l.equipmentId === equipmentId);
      equipmentLocations.forEach(loc => {
        events.push({
          type: 'checkout',
          date: new Date(loc.checkOutDate),
          title: `Checked out to ${loc.customer}`,
          description: ''
        });
        if (loc.returnDate) {
          events.push({
            type: 'maintenance',
            date: new Date(loc.returnDate),
            title: 'Equipment returned',
            description: `Returned from ${loc.customer}`
          });
        }
      });

      // Sort by date descending
      events.sort((a, b) => b.date - a.date);

      // Build timeline HTML
      let timelineHTML = `
        <h4 style="margin-bottom: 1rem; color: var(--helena-green);">Equipment Timeline</h4>
        <div class="timeline">
      `;

      if (events.length === 0) {
        timelineHTML += '<p style="color: var(--text-secondary);">No history recorded yet.</p>';
      } else {
        events.forEach(event => {
          let photosHTML = '';
          if (event.photos && event.photos.length > 0) {
            photosHTML = `<div class="timeline-photo" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
              ${event.photos.map(photo => `<img src="${photo}" alt="Issue photo" onclick="window.viewPhoto('${photo}')" style="max-width: 100px; max-height: 75px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--border);">`).join('')}
            </div>`;
          }
          timelineHTML += `
            <div class="timeline-item ${event.type}">
              <div class="timeline-date">${event.date.toLocaleDateString()} ${event.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
              <div class="timeline-content">
                <div class="timeline-title">${event.title}</div>
                ${event.description ? `<div class="timeline-description">${event.description}</div>` : ''}
                ${event.hours ? `<div class="timeline-description">Hours: ${event.hours}</div>` : ''}
                ${event.status ? `<div class="timeline-description">Status: ${event.status}</div>` : ''}
                ${photosHTML}
              </div>
            </div>
          `;
        });
      }

      timelineHTML += '</div>';

      // Show in equipment details
      const detailsContent = document.getElementById('equipmentDetailsContent');
      const existingTimeline = detailsContent.querySelector('.timeline');
      if (existingTimeline) {
        existingTimeline.parentElement.remove();
      }

      const timelineSection = document.createElement('div');
      timelineSection.style.marginTop = '2rem';
      timelineSection.style.paddingTop = '2rem';
      timelineSection.style.borderTop = '2px solid var(--border)';
      timelineSection.innerHTML = timelineHTML;
      detailsContent.appendChild(timelineSection);
    }

    // WEATHER FORECAST FOR SCHEDULING
    let weatherForecast = null;

    async function fetchWeatherForecast() {
      try {
        // Added wind speed and gusts to forecast
        const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=35.9512&longitude=-95.6508&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,weathercode,windspeed_10m_max,windgusts_10m_max,winddirection_10m_dominant&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America%2FChicago&forecast_days=14');
        const data = await response.json();
        weatherForecast = data.daily;
      } catch (error) {
        console.error('Error fetching weather forecast:', error);
      }
    }

    function getWeatherIcon(code) {
      if (code === 0) return '‚òÄÔ∏è';
      if (code <= 3) return '‚õÖ';
      if (code <= 48) return 'üå´Ô∏è';
      if (code <= 67) return 'üåßÔ∏è';
      if (code <= 77) return 'üå®Ô∏è';
      if (code <= 82) return 'üåßÔ∏è';
      if (code <= 86) return 'üå®Ô∏è';
      if (code >= 95) return '‚õàÔ∏è';
      return 'üå§Ô∏è';
    }

    function getWeatherForDate(dateStr) {
      if (!weatherForecast) return null;
      const idx = weatherForecast.time.indexOf(dateStr);
      if (idx === -1) return null;

      const windSpeed = Math.round(weatherForecast.windspeed_10m_max[idx]);
      const windGust = Math.round(weatherForecast.windgusts_10m_max[idx]);
      const windDir = getWindDirection(weatherForecast.winddirection_10m_dominant[idx]);
      const isWindy = windSpeed >= 15 || windGust >= 25; // Consider windy if 15+ mph or gusts 25+

      return {
        high: Math.round(weatherForecast.temperature_2m_max[idx]),
        low: Math.round(weatherForecast.temperature_2m_min[idx]),
        precipitation: weatherForecast.precipitation_probability_max[idx],
        icon: getWeatherIcon(weatherForecast.weathercode[idx]),
        windSpeed: windSpeed,
        windGust: windGust,
        windDir: windDir,
        isWindy: isWindy
      };
    }

    // Fetch weather on load
    fetchWeatherForecast();

    // Update loadData to render alerts
    const originalLoadData = loadData;
    loadData = async function(showLoadingIndicator = true) {
      await originalLoadData(showLoadingIndicator);
      renderAlertsBanner();
    };

    loadData();
  </script>
</body>
</html>
