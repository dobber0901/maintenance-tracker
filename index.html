<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Maintenance Tracker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800;900&family=Rajdhani:wght@300;400;600;700&display=swap');
    
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-card: #1c2128;
      --accent-primary: #ff6b35;
      --accent-secondary: #f7931e;
      --accent-success: #00ff88;
      --accent-warning: #ffd60a;
      --accent-danger: #ff006e;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --border: #30363d;
      --shadow: rgba(255, 107, 53, 0.15);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 107, 53, 0.03) 2px, rgba(255, 107, 53, 0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255, 107, 53, 0.03) 2px, rgba(255, 107, 53, 0.03) 4px);
      pointer-events: none;
      z-index: 0;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
      position: relative;
      z-index: 1;
    }
    
    header {
      background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
      border: 2px solid var(--accent-primary);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      position: relative;
      overflow: hidden;
      animation: slideDown 0.6s ease-out;
    }
    
    header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 107, 53, 0.1) 0%, transparent 70%);
      animation: pulse 4s ease-in-out infinite;
    }
    
    h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }
    
    .subtitle {
      font-size: 1.1rem;
      color: var(--text-secondary);
      font-weight: 400;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    
    .nav-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      animation: fadeIn 0.8s ease-out 0.2s backwards;
    }
    
    .nav-tab {
      font-family: 'Orbitron', sans-serif;
      background: var(--bg-card);
      border: 2px solid var(--border);
      color: var(--text-secondary);
      padding: 1rem 2rem;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
    }
    
    .nav-tab:hover {
      border-color: var(--accent-primary);
      color: var(--text-primary);
      transform: translateY(-2px);
    }
    
    .nav-tab.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-primary);
      box-shadow: 0 0 30px var(--shadow);
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .action-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      font-family: 'Orbitron', sans-serif;
      padding: 0.9rem 1.8rem;
      border: 2px solid var(--border);
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.3s ease;
      clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: var(--accent-primary);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
      z-index: -1;
    }
    
    .btn:hover::before {
      width: 400px;
      height: 400px;
    }
    
    .btn:hover {
      border-color: var(--accent-primary);
      color: var(--bg-primary);
    }
    
    .btn-primary {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-primary);
    }
    
    .btn-primary::before {
      background: var(--accent-secondary);
    }
    
    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }
    
    .equipment-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      animation: scaleIn 0.5s ease-out backwards;
      clip-path: polygon(12px 0, 100% 0, 100% calc(100% - 12px), calc(100% - 12px) 100%, 0 100%, 0 12px);
    }
    
    .equipment-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }
    
    .equipment-card:hover {
      border-color: var(--accent-primary);
      box-shadow: 0 12px 40px var(--shadow);
      transform: translateY(-4px);
    }
    
    .equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    
    .equipment-id {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent-primary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.25rem;
    }
    
    .equipment-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .equipment-type {
      font-size: 0.95rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .status-badge {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border: 2px solid;
    }
    
    .status-good {
      background: rgba(0, 255, 136, 0.2);
      color: var(--accent-success);
      border-color: var(--accent-success);
    }
    
    .status-warning {
      background: rgba(255, 214, 10, 0.2);
      color: var(--accent-warning);
      border-color: var(--accent-warning);
    }
    
    .status-danger {
      background: rgba(255, 0, 110, 0.2);
      color: var(--accent-danger);
      border-color: var(--accent-danger);
    }
    
    .equipment-stats {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 8px;
    }
    
    .stat-item {
      flex: 1;
      text-align: center;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }
    
    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-primary);
    }
    
    .equipment-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .btn-small {
      flex: 1;
      padding: 0.6rem 1rem;
      font-size: 0.75rem;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--bg-card);
      border: 2px solid var(--accent-primary);
      border-radius: 16px;
      padding: 2rem;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(255, 107, 53, 0.4);
      animation: scaleIn 0.4s ease-out;
      clip-path: polygon(16px 0, 100% 0, 100% calc(100% - 16px), calc(100% - 16px) 100%, 0 100%, 0 16px);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border);
    }
    
    .modal-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--accent-primary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 2rem;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      color: var(--accent-danger);
      transform: rotate(90deg);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--accent-primary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.9rem 1.2rem;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    }
    
    select {
      cursor: pointer;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
      font-family: 'Rajdhani', sans-serif;
    }
    
    .maintenance-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .maintenance-item {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      transition: all 0.3s ease;
      animation: slideRight 0.4s ease-out backwards;
    }
    
    .maintenance-item:hover {
      border-color: var(--accent-primary);
    }
    
    .maintenance-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .maintenance-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .maintenance-interval {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      color: var(--accent-secondary);
      font-weight: 600;
    }
    
    .maintenance-description {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin-top: 0.5rem;
    }
    
    .maintenance-status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .print-report {
      background: white;
      color: black;
      padding: 2rem;
      max-width: 210mm;
      margin: 0 auto;
      font-family: Arial, sans-serif;
    }
    
    .print-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 3px solid #ff6b35;
    }
    
    .print-title {
      font-family: Arial, sans-serif;
      font-size: 2rem;
      font-weight: 900;
      color: #ff6b35;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    
    .print-equipment-info {
      background: #f5f5f5;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border-left: 4px solid #ff6b35;
    }
    
    .print-info-row {
      display: flex;
      margin-bottom: 0.5rem;
    }
    
    .print-label {
      font-weight: 700;
      width: 150px;
      color: #333;
    }
    
    .print-value {
      color: #666;
    }
    
    .print-maintenance-list {
      margin-top: 2rem;
    }
    
    .print-maintenance-item {
      border: 1px solid #ddd;
      padding: 1rem;
      margin-bottom: 1rem;
      page-break-inside: avoid;
    }
    
    .print-item-header {
      background: #ff6b35;
      color: white;
      padding: 0.5rem 1rem;
      margin: -1rem -1rem 1rem -1rem;
      font-weight: 700;
    }
    
    @media print {
      .container, .bg-pattern {
        display: none !important;
      }
      
      #printReport {
        display: block !important;
      }
      
      .print-report {
        display: block !important;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      
      .btn {
        display: none !important;
      }
      
      @page {
        margin: 1cm;
      }
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    .template-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid var(--border);
    }
    
    .template-item {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .template-info {
      flex: 1;
    }
    
    .template-name {
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .template-desc {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .add-template-btn {
      padding: 0.5rem 1rem;
      font-size: 0.75rem;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideRight {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    @media (max-width: 768px) {
      h1 { font-size: 2rem; }
      .equipment-grid { grid-template-columns: 1fr; }
      .nav-tabs { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  
  <div class="container">
    <header>
      <h1>üîß FLEET MAINTENANCE</h1>
      <p class="subtitle">Equipment Management System</p>
    </header>
    
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="equipment">Equipment Fleet</button>
      <button class="nav-tab" data-tab="templates">Maintenance Templates</button>
      <button class="nav-tab" data-tab="schedule">Schedule</button>
    </div>
    
    <div id="equipment-tab" class="tab-content active">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddEquipmentModal()">+ Add Equipment</button>
      </div>
      <div class="equipment-grid" id="equipmentGrid"></div>
    </div>
    
    <div id="templates-tab" class="tab-content">
      <div class="action-bar">
        <button class="btn btn-primary" onclick="openAddTemplateModal()">+ Create Template</button>
      </div>
      <div id="templatesList"></div>
    </div>
    
    <div id="schedule-tab" class="tab-content">
      <div id="scheduleView"></div>
    </div>
  </div>
  
  <!-- Add Equipment Modal -->
  <div id="addEquipmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add Equipment</h2>
        <button class="close-btn" onclick="closeModal('addEquipmentModal')">&times;</button>
      </div>
      <form id="addEquipmentForm" onsubmit="addEquipment(event)">
        <div class="form-group">
          <label for="equipmentId">Equipment ID *</label>
          <input type="text" id="equipmentId" required placeholder="e.g., FB-001">
        </div>
        <div class="form-group">
          <label for="equipmentName">Equipment Name *</label>
          <input type="text" id="equipmentName" required placeholder="e.g., John Deere Fertilizer Buggy">
        </div>
        <div class="form-group">
          <label for="equipmentType">Equipment Type *</label>
          <select id="equipmentType" required onchange="loadMaintenanceTemplates()">
            <option value="">Select Type</option>
            <option value="Fertilizer Buggy">Fertilizer Buggy</option>
            <option value="Seed Trailer">Seed Trailer</option>
            <option value="Tender">Tender</option>
            <option value="Nurse Trailer">Nurse Trailer</option>
            <option value="Tank Trailer">Tank Trailer</option>
            <option value="Tractor">Tractor</option>
            <option value="Truck">Truck</option>
            <option value="Flatbed">Flatbed</option>
            <option value="Equipment">Equipment</option>
            <option value="Forklift">Forklift</option>
          </select>
        </div>
        <div class="form-group">
          <label for="equipmentLocation">Location</label>
          <input type="text" id="equipmentLocation" placeholder="e.g., Main Yard">
        </div>
        <div id="templateLoadSection" style="display: none;">
          <div class="form-group">
            <label>Auto-Load Maintenance Items</label>
            <div id="availableTemplates"></div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Equipment</button>
      </form>
    </div>
  </div>
  
  <!-- Add Template Modal -->
  <div id="addTemplateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Maintenance Template</h2>
        <button class="close-btn" onclick="closeModal('addTemplateModal')">&times;</button>
      </div>
      <form id="addTemplateForm" onsubmit="addTemplate(event)">
        <div class="form-group">
          <label for="templateEquipmentType">Equipment Type *</label>
          <select id="templateEquipmentType" required>
            <option value="">Select Type</option>
            <option value="Fertilizer Buggy">Fertilizer Buggy</option>
            <option value="Seed Trailer">Seed Trailer</option>
            <option value="Tender">Tender</option>
            <option value="Nurse Trailer">Nurse Trailer</option>
            <option value="Tank Trailer">Tank Trailer</option>
            <option value="Tractor">Tractor</option>
            <option value="Truck">Truck</option>
            <option value="Flatbed">Flatbed</option>
            <option value="Equipment">Equipment</option>
            <option value="Forklift">Forklift</option>
          </select>
        </div>
        <div class="form-group">
          <label for="templateName">Maintenance Item Name *</label>
          <input type="text" id="templateName" required placeholder="e.g., Oil Change">
        </div>
        <div class="form-group">
          <label for="templateInterval">Interval (days) *</label>
          <input type="number" id="templateInterval" required min="1" placeholder="e.g., 90">
        </div>
        <div class="form-group">
          <label for="templateDescription">Description/Instructions</label>
          <textarea id="templateDescription" placeholder="Detailed instructions for this maintenance item..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Create Template</button>
      </form>
    </div>
  </div>
  
  <!-- Equipment Details Modal -->
  <div id="equipmentDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="detailsEquipmentName"></h2>
        <button class="close-btn" onclick="closeModal('equipmentDetailsModal')">&times;</button>
      </div>
      <div id="equipmentDetailsContent"></div>
      <div class="action-bar" style="margin-top: 2rem;">
        <button class="btn btn-primary" onclick="printReport()">üìÑ Print Report</button>
        <button class="btn" onclick="closeModal('equipmentDetailsModal')">Close</button>
      </div>
    </div>
  </div>
  
  <!-- Complete Maintenance Modal -->
  <div id="completeMaintenanceModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Complete Maintenance</h2>
        <button class="close-btn" onclick="closeModal('completeMaintenanceModal')">&times;</button>
      </div>
      <form id="completeMaintenanceForm" onsubmit="completeMaintenance(event)">
        <input type="hidden" id="completeEquipmentId">
        <input type="hidden" id="completeMaintenanceId">
        <div class="form-group">
          <label>Maintenance Item</label>
          <p id="completeMaintenanceName" style="color: var(--text-primary); font-size: 1.1rem; font-weight: 600;"></p>
        </div>
        <div class="form-group">
          <label for="completionDate">Completion Date *</label>
          <input type="date" id="completionDate" required>
        </div>
        <div class="form-group">
          <label for="completionNotes">Notes</label>
          <textarea id="completionNotes" placeholder="What was done? Any issues found?"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Mark Complete</button>
      </form>
    </div>
  </div>
  
  <!-- Print Report Container -->
  <div id="printReport" style="display: none;">
    <div class="print-report">
      <div class="print-header">
        <h1 class="print-title">MAINTENANCE REPORT</h1>
        <p>Generated: <span id="printDate"></span></p>
      </div>
      <div class="print-equipment-info" id="printEquipmentInfo"></div>
      <h2 style="font-family: 'Orbitron', sans-serif; color: #ff6b35; margin-bottom: 1rem;">Maintenance Items</h2>
      <div class="print-maintenance-list" id="printMaintenanceList"></div>
    </div>
  </div>
  
  <script type="module">
    // Firebase configuration - USER WILL REPLACE THIS
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDVqhdUUCMcASjEewt9Yv1Nky0hr2-FTmQ",
      authDomain: "pm-log.firebaseapp.com",
      projectId: "pm-log",
      storageBucket: "pm-log.firebasestorage.app",
      messagingSenderId: "993822676610",
      appId: "1:993822676610:web:1e001809e089a6c6a0069b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Global state
    let equipment = [];
    let templates = [];
    let currentEquipmentId = null;
    
    // Load all data
    async function loadData() {
      try {
        // Load equipment
        const equipmentSnapshot = await getDocs(collection(db, 'equipment'));
        equipment = equipmentSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load templates
        const templatesSnapshot = await getDocs(collection(db, 'maintenanceTemplates'));
        templates = templatesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        renderEquipment();
        renderTemplates();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }
    
    // Tab switching
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        if (tabName === 'schedule') {
          renderSchedule();
        }
      });
    });
    
    window.openAddEquipmentModal = function() {
      document.getElementById('addEquipmentModal').classList.add('active');
      document.getElementById('templateLoadSection').style.display = 'none';
    }
    
    window.closeModal = function(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    window.loadMaintenanceTemplates = function() {
      const type = document.getElementById('equipmentType').value;
      const section = document.getElementById('templateLoadSection');
      const container = document.getElementById('availableTemplates');
      
      if (!type) {
        section.style.display = 'none';
        return;
      }
      
      const typeTemplates = templates.filter(t => t.equipmentType === type);
      
      if (typeTemplates.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      container.innerHTML = typeTemplates.map(t => `
        <div class="checkbox-group">
          <input type="checkbox" id="template-${t.id}" value="${t.id}" checked>
          <label for="template-${t.id}" style="margin: 0; text-transform: none; font-family: 'Rajdhani', sans-serif; color: var(--text-primary);">
            ${t.name} (Every ${t.interval} days)
          </label>
        </div>
      `).join('');
    }
    
    window.addEquipment = async function(event) {
      event.preventDefault();
      
      const type = document.getElementById('equipmentType').value;
      const selectedTemplates = Array.from(document.querySelectorAll('#availableTemplates input[type="checkbox"]:checked'))
        .map(cb => cb.value);
      
      const maintenanceItems = selectedTemplates.map(templateId => {
        const template = templates.find(t => t.id === templateId);
        return {
          id: Date.now() + Math.random(),
          name: template.name,
          interval: template.interval,
          description: template.description,
          lastCompleted: null,
          history: []
        };
      });
      
      const newEquipment = {
        equipmentId: document.getElementById('equipmentId').value,
        name: document.getElementById('equipmentName').value,
        type: type,
        location: document.getElementById('equipmentLocation').value,
        maintenanceItems: maintenanceItems,
        createdAt: new Date().toISOString()
      };
      
      try {
        await addDoc(collection(db, 'equipment'), newEquipment);
        await loadData();
        document.getElementById('addEquipmentForm').reset();
        closeModal('addEquipmentModal');
      } catch (error) {
        console.error('Error adding equipment:', error);
        alert('Error adding equipment. Please try again.');
      }
    }
    
    window.addTemplate = async function(event) {
      event.preventDefault();
      
      const newTemplate = {
        equipmentType: document.getElementById('templateEquipmentType').value,
        name: document.getElementById('templateName').value,
        interval: parseInt(document.getElementById('templateInterval').value),
        description: document.getElementById('templateDescription').value,
        createdAt: new Date().toISOString()
      };
      
      try {
        await addDoc(collection(db, 'maintenanceTemplates'), newTemplate);
        await loadData();
        document.getElementById('addTemplateForm').reset();
        closeModal('addTemplateModal');
      } catch (error) {
        console.error('Error adding template:', error);
        alert('Error adding template. Please try again.');
      }
    }
    
    function getMaintenanceStatus(item) {
      if (!item.lastCompleted) {
        return { status: 'danger', daysUntil: -999, nextDue: 'Not Set' };
      }
      
      const lastDate = new Date(item.lastCompleted);
      const today = new Date();
      const nextDue = new Date(lastDate);
      nextDue.setDate(nextDue.getDate() + item.interval);
      
      const daysUntil = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
      
      let status = 'good';
      if (daysUntil < 0) {
        status = 'danger';
      } else if (daysUntil <= 7) {
        status = 'warning';
      }
      
      return {
        status,
        daysUntil,
        nextDue: nextDue.toLocaleDateString()
      };
    }
    
    function getEquipmentOverallStatus(eq) {
      if (!eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        return { status: 'good', itemsOverdue: 0, itemsDueSoon: 0 };
      }
      
      let itemsOverdue = 0;
      let itemsDueSoon = 0;
      
      eq.maintenanceItems.forEach(item => {
        const { status } = getMaintenanceStatus(item);
        if (status === 'danger') itemsOverdue++;
        else if (status === 'warning') itemsDueSoon++;
      });
      
      let overallStatus = 'good';
      if (itemsOverdue > 0) overallStatus = 'danger';
      else if (itemsDueSoon > 0) overallStatus = 'warning';
      
      return { status: overallStatus, itemsOverdue, itemsDueSoon };
    }
    
    function renderEquipment() {
      const grid = document.getElementById('equipmentGrid');
      
      if (equipment.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üöú</div>
            <h3>No Equipment Added</h3>
            <p>Click "Add Equipment" to start tracking your fleet</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = equipment.map((eq, index) => {
        const { status, itemsOverdue, itemsDueSoon } = getEquipmentOverallStatus(eq);
        
        let statusText = 'All Good';
        let statusClass = 'status-good';
        
        if (status === 'danger') {
          statusText = `${itemsOverdue} Overdue`;
          statusClass = 'status-danger';
        } else if (status === 'warning') {
          statusText = `${itemsDueSoon} Due Soon`;
          statusClass = 'status-warning';
        }
        
        return `
          <div class="equipment-card" style="animation-delay: ${index * 0.1}s">
            <div class="equipment-header">
              <div>
                <div class="equipment-id">${eq.equipmentId}</div>
                <div class="equipment-name">${eq.name}</div>
                <div class="equipment-type">${eq.type}</div>
              </div>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
            
            <div class="equipment-stats">
              <div class="stat-item">
                <div class="stat-label">Items</div>
                <div class="stat-value">${eq.maintenanceItems ? eq.maintenanceItems.length : 0}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Overdue</div>
                <div class="stat-value" style="color: var(--accent-danger);">${itemsOverdue}</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">Due Soon</div>
                <div class="stat-value" style="color: var(--accent-warning);">${itemsDueSoon}</div>
              </div>
            </div>
            
            <div class="equipment-actions">
              <button class="btn btn-small btn-primary" onclick="window.viewEquipmentDetails('${eq.id}')">View Details</button>
              <button class="btn btn-small" onclick="window.deleteEquipment('${eq.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderTemplates() {
      const container = document.getElementById('templatesList');
      
      if (templates.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>No Templates Created</h3>
            <p>Create maintenance templates that will auto-load when adding equipment</p>
          </div>
        `;
        return;
      }
      
      // Group by equipment type
      const grouped = {};
      templates.forEach(t => {
        if (!grouped[t.equipmentType]) {
          grouped[t.equipmentType] = [];
        }
        grouped[t.equipmentType].push(t);
      });
      
      container.innerHTML = Object.keys(grouped).sort().map(type => `
        <div class="template-section">
          <h3 style="font-family: 'Orbitron', sans-serif; color: var(--accent-primary); margin-bottom: 1rem;">${type}</h3>
          ${grouped[type].map(t => `
            <div class="template-item">
              <div class="template-info">
                <div class="template-name">${t.name}</div>
                <div class="template-desc">Every ${t.interval} days${t.description ? ' - ' + t.description : ''}</div>
              </div>
              <button class="btn btn-small" onclick="window.deleteTemplate('${t.id}')">Delete</button>
            </div>
          `).join('')}
        </div>
      `).join('');
    }
    
    window.viewEquipmentDetails = function(equipmentId) {
      const eq = equipment.find(e => e.id === equipmentId);
      if (!eq) return;
      
      currentEquipmentId = equipmentId;
      
      document.getElementById('detailsEquipmentName').textContent = `${eq.equipmentId} - ${eq.name}`;
      
      const content = document.getElementById('equipmentDetailsContent');
      
      if (!eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <p>No maintenance items configured for this equipment.</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="maintenance-list">
            ${eq.maintenanceItems.map(item => {
              const { status, daysUntil, nextDue } = getMaintenanceStatus(item);
              
              let statusClass = 'status-good';
              let statusText = 'Up to Date';
              
              if (status === 'danger') {
                statusClass = 'status-danger';
                statusText = daysUntil === -999 ? 'Never Done' : `${Math.abs(daysUntil)} Days Overdue`;
              } else if (status === 'warning') {
                statusClass = 'status-warning';
                statusText = `Due in ${daysUntil} Days`;
              } else {
                statusText = `Due in ${daysUntil} Days`;
              }
              
              return `
                <div class="maintenance-item">
                  <div class="maintenance-header">
                    <div>
                      <div class="maintenance-title">${item.name}</div>
                      <div class="maintenance-interval">Every ${item.interval} days</div>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                  </div>
                  ${item.description ? `<div class="maintenance-description">${item.description}</div>` : ''}
                  <div class="maintenance-status">
                    <strong>Last Completed:</strong> ${item.lastCompleted ? new Date(item.lastCompleted).toLocaleDateString() : 'Never'}<br>
                    <strong>Next Due:</strong> ${nextDue}
                  </div>
                  <div class="equipment-actions" style="margin-top: 1rem;">
                    <button class="btn btn-small btn-primary" onclick="window.openCompleteModal('${eq.id}', '${item.id}')">Mark Complete</button>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      document.getElementById('equipmentDetailsModal').classList.add('active');
    }
    
    window.openCompleteModal = function(equipmentId, maintenanceId) {
      const eq = equipment.find(e => e.id === equipmentId);
      const item = eq.maintenanceItems.find(m => m.id == maintenanceId);
      
      document.getElementById('completeEquipmentId').value = equipmentId;
      document.getElementById('completeMaintenanceId').value = maintenanceId;
      document.getElementById('completeMaintenanceName').textContent = item.name;
      document.getElementById('completionDate').value = new Date().toISOString().split('T')[0];
      
      document.getElementById('completeMaintenanceModal').classList.add('active');
    }
    
    window.completeMaintenance = async function(event) {
      event.preventDefault();
      
      const equipmentId = document.getElementById('completeEquipmentId').value;
      const maintenanceId = document.getElementById('completeMaintenanceId').value;
      const date = document.getElementById('completionDate').value;
      const notes = document.getElementById('completionNotes').value;
      
      const eq = equipment.find(e => e.id === equipmentId);
      const item = eq.maintenanceItems.find(m => m.id == maintenanceId);
      
      if (!item.history) item.history = [];
      
      item.history.push({
        date: date,
        notes: notes,
        completedAt: new Date().toISOString()
      });
      item.lastCompleted = date;
      
      try {
        await updateDoc(doc(db, 'equipment', equipmentId), {
          maintenanceItems: eq.maintenanceItems
        });
        
        await loadData();
        document.getElementById('completeMaintenanceForm').reset();
        closeModal('completeMaintenanceModal');
        viewEquipmentDetails(equipmentId);
      } catch (error) {
        console.error('Error completing maintenance:', error);
        alert('Error saving maintenance. Please try again.');
      }
    }
    
    window.deleteEquipment = async function(equipmentId) {
      if (!confirm('Are you sure you want to delete this equipment and all its maintenance records?')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'equipment', equipmentId));
        await loadData();
      } catch (error) {
        console.error('Error deleting equipment:', error);
        alert('Error deleting equipment. Please try again.');
      }
    }
    
    window.deleteTemplate = async function(templateId) {
      if (!confirm('Are you sure you want to delete this template?')) {
        return;
      }
      
      try {
        await deleteDoc(doc(db, 'maintenanceTemplates', templateId));
        await loadData();
      } catch (error) {
        console.error('Error deleting template:', error);
        alert('Error deleting template. Please try again.');
      }
    }
    
    window.printReport = function() {
      const eq = equipment.find(e => e.id === currentEquipmentId);
      if (!eq) {
        alert('Equipment not found');
        return;
      }
      
      if (!eq.maintenanceItems || eq.maintenanceItems.length === 0) {
        alert('No maintenance items to print for this equipment');
        return;
      }
      
      // Create print window
      const printWindow = window.open('', '_blank');
      
      // Build maintenance items HTML
      let maintenanceItemsHTML = '';
      eq.maintenanceItems.forEach(item => {
        const { status, daysUntil, nextDue } = getMaintenanceStatus(item);
        
        let statusText = '';
        if (status === 'danger') {
          statusText = '‚ö†Ô∏è OVERDUE';
        } else if (status === 'warning') {
          statusText = '‚ö° DUE SOON';
        } else {
          statusText = '‚úì UP TO DATE';
        }
        
        maintenanceItemsHTML += `
          <div class="print-maintenance-item">
            <div class="print-item-header">${item.name}</div>
            <p><strong>Interval:</strong> Every ${item.interval} days</p>
            <p><strong>Last Completed:</strong> ${item.lastCompleted ? new Date(item.lastCompleted).toLocaleDateString() : 'Never'}</p>
            <p><strong>Next Due:</strong> ${nextDue}</p>
            <p><strong>Status:</strong> ${statusText}</p>
            ${item.description ? `<p><strong>Instructions:</strong> ${item.description}</p>` : ''}
            <div style="margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 0.5rem;">
              <strong>Completion Checklist:</strong>
              <div style="margin-top: 0.5rem;">
                ‚òê Task completed<br>
                ‚òê Parts replaced (if applicable)<br>
                ‚òê Issues noted<br>
                ‚òê Signed off: _________________ Date: _________
              </div>
            </div>
          </div>
        `;
      });
      
      // Write full HTML document to print window
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Maintenance Report - ${eq.equipmentId}</title>
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            
            body {
              font-family: Arial, sans-serif;
              padding: 20px;
              background: white;
              color: black;
            }
            
            .print-header {
              text-align: center;
              margin-bottom: 30px;
              padding-bottom: 20px;
              border-bottom: 3px solid #ff6b35;
            }
            
            .print-title {
              font-size: 32px;
              font-weight: 900;
              color: #ff6b35;
              margin-bottom: 10px;
              text-transform: uppercase;
            }
            
            .print-equipment-info {
              background: #f5f5f5;
              padding: 20px;
              margin-bottom: 30px;
              border-left: 4px solid #ff6b35;
            }
            
            .print-info-row {
              display: flex;
              margin-bottom: 8px;
            }
            
            .print-label {
              font-weight: 700;
              width: 150px;
              color: #333;
            }
            
            .print-value {
              color: #666;
            }
            
            h2 {
              color: #ff6b35;
              margin-bottom: 20px;
              font-size: 24px;
            }
            
            .print-maintenance-item {
              border: 1px solid #ddd;
              padding: 15px;
              margin-bottom: 15px;
              page-break-inside: avoid;
            }
            
            .print-item-header {
              background: #ff6b35;
              color: white;
              padding: 8px 15px;
              margin: -15px -15px 15px -15px;
              font-weight: 700;
              font-size: 18px;
            }
            
            p {
              margin-bottom: 8px;
              line-height: 1.6;
            }
            
            @media print {
              body {
                padding: 0;
              }
              
              @page {
                margin: 1cm;
              }
            }
          </style>
        </head>
        <body>
          <div class="print-header">
            <h1 class="print-title">MAINTENANCE REPORT</h1>
            <p>Generated: ${new Date().toLocaleDateString()}</p>
          </div>
          
          <div class="print-equipment-info">
            <div class="print-info-row">
              <span class="print-label">Equipment ID:</span>
              <span class="print-value">${eq.equipmentId}</span>
            </div>
            <div class="print-info-row">
              <span class="print-label">Name:</span>
              <span class="print-value">${eq.name}</span>
            </div>
            <div class="print-info-row">
              <span class="print-label">Type:</span>
              <span class="print-value">${eq.type}</span>
            </div>
            <div class="print-info-row">
              <span class="print-label">Location:</span>
              <span class="print-value">${eq.location || 'N/A'}</span>
            </div>
          </div>
          
          <h2>Maintenance Items</h2>
          
          ${maintenanceItemsHTML}
          
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
              }, 250);
            };
          </script>
        </body>
        </html>
      `);
      
      printWindow.document.close();
    }
    
    function renderSchedule() {
      const container = document.getElementById('scheduleView');
      
      const allMaintenanceItems = [];
      
      equipment.forEach(eq => {
        if (eq.maintenanceItems) {
          eq.maintenanceItems.forEach(item => {
            const { status, daysUntil, nextDue } = getMaintenanceStatus(item);
            allMaintenanceItems.push({
              equipment: eq,
              item: item,
              status: status,
              daysUntil: daysUntil,
              nextDue: nextDue
            });
          });
        }
      });
      
      allMaintenanceItems.sort((a, b) => a.daysUntil - b.daysUntil);
      
      if (allMaintenanceItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìÖ</div>
            <h3>No Scheduled Maintenance</h3>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="maintenance-list">
          ${allMaintenanceItems.map((mi, index) => {
            let statusClass = 'status-good';
            if (mi.status === 'danger') statusClass = 'status-danger';
            else if (mi.status === 'warning') statusClass = 'status-warning';
            
            let statusText = '';
            if (mi.daysUntil < 0) {
              statusText = `${Math.abs(mi.daysUntil)} days overdue`;
            } else if (mi.daysUntil === 0) {
              statusText = 'Due today';
            } else {
              statusText = `Due in ${mi.daysUntil} days`;
            }
            
            return `
              <div class="maintenance-item" style="animation-delay: ${index * 0.05}s;">
                <div class="maintenance-header">
                  <div>
                    <div class="equipment-id">${mi.equipment.equipmentId}</div>
                    <div class="maintenance-title">${mi.item.name}</div>
                    <div class="equipment-type">${mi.equipment.name} - ${mi.equipment.type}</div>
                  </div>
                  <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="maintenance-status">
                  <strong>Next Due:</strong> ${mi.nextDue}<br>
                  <strong>Interval:</strong> Every ${mi.item.interval} days
                  ${mi.item.description ? `<br><strong>Instructions:</strong> ${mi.item.description}` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    window.openAddTemplateModal = function() {
      document.getElementById('addTemplateModal').classList.add('active');
    }
    
    // Initialize
    loadData();
  </script>
</body>
</html>
